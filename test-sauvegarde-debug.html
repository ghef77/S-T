<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Debug Sauvegarde</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-cell { 
            border: 2px solid #007bff; 
            padding: 15px; 
            margin: 20px; 
            min-height: 60px;
            background: #f8f9fa;
            font-size: 16px;
        }
        .log { 
            background: #f8f9fa; 
            padding: 15px; 
            margin: 20px; 
            border-radius: 8px;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }
        .success { color: #28a745; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .info { color: #17a2b8; font-weight: bold; }
        .saving { color: #6f42c1; font-weight: bold; }
        button { 
            padding: 12px 20px; 
            margin: 8px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .btn-danger { background-color: #dc3545; color: white; }
    </style>
</head>
<body>
    <h1>🧪 Test Debug Sauvegarde</h1>
    
    <div class="test-cell" contenteditable="true" data-original-value="Test initial">
        Test initial
    </div>
    
    <div style="margin: 20px;">
        <button onclick="testModification()" class="btn-primary">📝 Test Modification</button>
        <button onclick="testSyncToMaster()" class="btn-success">🔄 Test SyncToMaster</button>
        <button onclick="testHashComparison()" class="btn-warning">🔍 Test Hash</button>
        <button onclick="testCollectTableData()" class="btn-danger">📊 Test CollectData</button>
        <button onclick="clearLog()" class="btn-warning">🗑️ Effacer Log</button>
    </div>
    
    <div class="log" id="log">
        <div class="info">🚀 Test debug sauvegarde initialisé</div>
    </div>
    
    <script>
        let logCount = 0;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            logCount++;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '<div class="info">🚀 Test debug sauvegarde initialisé</div>';
            logCount = 0;
        }
        
        // Simulation des fonctions de l'application principale
        let isDirty = false;
        let appState = {
            dataHash: 'hash_initial',
            localData: { rows: [] }
        };
        
        // Simulation de collectTableData
        function collectTableData() {
            const cell = document.querySelector('.test-cell');
            const currentValue = cell.textContent;
            
            const data = {
                rows: [{
                    id: 1,
                    content: currentValue,
                    timestamp: Date.now()
                }]
            };
            
            log(`📊 collectTableData: ${JSON.stringify(data)}`, 'info');
            return data;
        }
        
        // Simulation de generateDataHash
        function generateDataHash(data) {
            const jsonString = JSON.stringify(data);
            let hash = 0;
            for (let i = 0; i < jsonString.length; i++) {
                const char = jsonString.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            const hashString = Math.abs(hash).toString(16);
            log(`🔐 Hash généré: ${hashString}`, 'info');
            return hashString;
        }
        
        // Simulation de syncToMaster
        async function syncToMaster(isManualSave = false) {
            log(`🔄 syncToMaster appelé (isManualSave: ${isManualSave})`, 'saving');
            
            const current = collectTableData();
            const currentHash = generateDataHash(current);
            
            log(`📊 Données actuelles: ${JSON.stringify(current)}`, 'info');
            log(`🔐 Hash actuel: ${currentHash}`, 'info');
            log(`🔐 Hash précédent: ${appState.dataHash}`, 'info');
            
            if (!isManualSave && currentHash === appState.dataHash) {
                log('🚫 Pas de changement détecté - sauvegarde annulée', 'warning');
                return;
            }
            
            log('💾 Sauvegarde en cours...', 'saving');
            
            // Simuler la sauvegarde
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Mettre à jour le hash après sauvegarde
            appState.dataHash = currentHash;
            log(`✅ Hash mis à jour: ${appState.dataHash}`, 'success');
            log('✅ Sauvegarde réussie !', 'success');
        }
        
        // Test de modification
        function testModification() {
            log('🧪 Test de modification...', 'info');
            
            const cell = document.querySelector('.test-cell');
            const originalValue = cell.dataset.originalValue;
            const newValue = 'Modification test ' + Date.now();
            
            log(`📝 Modification: "${originalValue}" → "${newValue}"`, 'info');
            
            // Simuler la modification
            cell.textContent = newValue;
            cell.dataset.originalValue = newValue;
            
            // Marquer comme modifié
            isDirty = true;
            log(`✅ isDirty: ${isDirty}`, 'success');
            
            // Appeler syncToMaster
            syncToMaster(false).then(() => {
                log('✅ Test de modification terminé', 'success');
            }).catch((error) => {
                log(`❌ Erreur: ${error.message}`, 'error');
            });
        }
        
        // Test direct de syncToMaster
        function testSyncToMaster() {
            log('🧪 Test direct de syncToMaster...', 'info');
            syncToMaster(false);
        }
        
        // Test de comparaison de hash
        function testHashComparison() {
            log('🧪 Test de comparaison de hash...', 'info');
            
            const data1 = { rows: [{ id: 1, content: 'Test 1' }] };
            const data2 = { rows: [{ id: 1, content: 'Test 2' }] };
            
            const hash1 = generateDataHash(data1);
            const hash2 = generateDataHash(data2);
            
            log(`🔐 Hash 1: ${hash1}`, 'info');
            log(`🔐 Hash 2: ${hash2}`, 'info');
            log(`🔍 Hash 1 === Hash 2: ${hash1 === hash2}`, 'info');
            
            if (hash1 === hash2) {
                log('⚠️ ATTENTION: Hashs identiques pour données différentes !', 'warning');
            } else {
                log('✅ Hashs différents pour données différentes', 'success');
            }
        }
        
        // Test de collectTableData
        function testCollectTableData() {
            log('🧪 Test de collectTableData...', 'info');
            
            const data = collectTableData();
            const hash = generateDataHash(data);
            
            log(`📊 Données collectées: ${JSON.stringify(data)}`, 'info');
            log(`🔐 Hash généré: ${hash}`, 'info');
        }
        
        // Initialisation
        log('✅ Test debug initialisé avec succès', 'success');
        log('📋 Instructions:', 'info');
        log('   1. Cliquez sur "Test Modification" pour tester le cycle complet', 'info');
        log('   2. Utilisez les autres boutons pour tester des fonctions spécifiques', 'info');
        log('   3. Observez les logs pour identifier les problèmes', 'info');
        
        // Afficher l'état initial
        log('📊 État initial:', 'info');
        log(`   - isDirty: ${isDirty}`, 'info');
        log(`   - appState.dataHash: ${appState.dataHash}`, 'info');
    </script>
</body>
</html>
