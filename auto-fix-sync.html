<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Correction Automatique Synchronisation</title>
    <style>
        body { 
            font-family: system-ui, -apple-system, sans-serif; 
            margin: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button { 
            background: #16a34a; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 6px; 
            cursor: pointer; 
            margin: 5px;
            font-size: 14px;
            font-weight: 500;
        }
        .button:hover { background: #15803d; }
        .button.large { padding: 16px 32px; font-size: 16px; }
        .output { 
            background: #1f2937; 
            color: #f3f4f6; 
            padding: 15px; 
            border-radius: 6px; 
            margin: 10px 0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.4;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .status { 
            padding: 12px; 
            border-radius: 6px; 
            margin: 10px 0; 
            font-weight: bold;
        }
        .status.error { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
        .status.success { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .status.warning { background: #fefce8; color: #92400e; border: 1px solid #fde68a; }
        .progress { background: #e5e7eb; height: 4px; border-radius: 2px; margin: 10px 0; overflow: hidden; }
        .progress-bar { background: #16a34a; height: 100%; width: 0%; transition: width 0.3s; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Correction Automatique de la Synchronisation</h1>
        
        <div class="status warning">
            <strong>Probl√®me d√©tect√© :</strong> Client Supabase non initialis√©, subscription realtime manquante
        </div>
        
        <button class="button large" onclick="autoFixAll()">üöÄ Correction Automatique Compl√®te</button>
        
        <div class="progress">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <div id="output" class="output">Pr√™t pour la correction automatique...\nCliquez sur le bouton ci-dessus pour commencer.</div>
    </div>

    <!-- Chargement de Supabase -->
    <script type="module">
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2'
        window.createSupabaseClient = createClient;
        
        // Signal que le module est charg√©
        window.supabaseModuleLoaded = true;
    </script>
    
    <!-- Chargement des scripts de diagnostic -->
    <script src="realtime-sync-diagnostics.js"></script>
    <script src="realtime-sync-fix.js"></script>
    
    <script>
        const output = document.getElementById('output');
        const progressBar = document.getElementById('progressBar');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : 'üìÑ';
            output.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }
        
        function setProgress(percent) {
            progressBar.style.width = percent + '%';
        }
        
        function clearOutput() {
            output.textContent = '';
            setProgress(0);
        }
        
        // Configuration Supabase (vraies cl√©s trouv√©es dans index.html)
        const SUPABASE_CONFIG = {
            supabaseUrl: 'https://fiecugxopjxzqfdnaqsu.supabase.co',
            supabaseAnonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpZWN1Z3hvcGp4enFmZG5hcXN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDU2NTcsImV4cCI6MjA3MDA4MTY1N30.xd9Thasg4r8Nrwxx5nFwyGB_ufPIvok4XB-78dilpsw'
        };
        
        async function autoFixAll() {
            clearOutput();
            log('üöÄ D√©marrage de la correction automatique compl√®te...');
            
            try {
                // √âtape 1: Initialisation Supabase (20%)
                setProgress(10);
                log('üì° √âtape 1/5: Initialisation du client Supabase...');
                await initializeSupabase();
                setProgress(20);
                
                // √âtape 2: Configuration globale (40%)
                log('‚öôÔ∏è √âtape 2/5: Configuration des variables globales...');
                await setupGlobalVariables();
                setProgress(40);
                
                // √âtape 3: Nettoyage des flags de blocage (60%)
                log('üßπ √âtape 3/5: Nettoyage des flags de blocage...');
                await clearBlockingFlags();
                setProgress(60);
                
                // √âtape 4: Configuration de la subscription realtime (80%)
                log('üì° √âtape 4/5: Configuration de la subscription realtime...');
                await setupRealtimeSubscription();
                setProgress(80);
                
                // √âtape 5: Test final (100%)
                log('üß™ √âtape 5/5: Tests finaux...');
                await runFinalTests();
                setProgress(100);
                
                log('üéâ CORRECTION TERMIN√âE AVEC SUCC√àS !', 'success');
                log('‚úÖ La synchronisation realtime est maintenant op√©rationnelle', 'success');
                log('üí° Vous pouvez retourner √† votre page principale', 'success');
                
            } catch (error) {
                log('‚ùå Erreur lors de la correction: ' + error.message, 'error');
                setProgress(0);
            }
        }
        
        async function initializeSupabase() {
            // Attendre que le module soit charg√©
            let attempts = 0;
            while (!window.supabaseModuleLoaded && attempts < 20) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (!window.createSupabaseClient) {
                throw new Error('Module Supabase non charg√©');
            }
            
            // Cr√©er le client
            window.supabase = window.createSupabaseClient(
                SUPABASE_CONFIG.supabaseUrl,
                SUPABASE_CONFIG.supabaseAnonKey
            );
            
            if (!window.supabase) {
                throw new Error('√âchec de cr√©ation du client Supabase');
            }
            
            log('  ‚úÖ Client Supabase cr√©√© avec succ√®s', 'success');
            
            // Test de connexion rapide
            try {
                await window.supabase.auth.getSession();
                log('  ‚úÖ Test de connexion r√©ussi', 'success');
            } catch (error) {
                log('  ‚ö†Ô∏è Test de connexion partiel, mais client cr√©√©', 'warning');
            }
        }
        
        async function setupGlobalVariables() {
            // Configuration globale
            window.supabaseConfig = SUPABASE_CONFIG;
            window.snapshotMode = 'live';
            
            // Flags de blocage
            window.isLocalSaveInProgress = false;
            window.isExcelSaveInProgress = false;
            
            // Fonction isRestoringCursor
            window.isRestoringCursor = () => false;
            
            log('  ‚úÖ Variables globales configur√©es', 'success');
            log('  ‚úÖ Mode snapshot d√©fini sur "live"', 'success');
            log('  ‚úÖ Flags de blocage r√©initialis√©s', 'success');
        }
        
        async function clearBlockingFlags() {
            if (typeof window.clearRealtimeFlags === 'function') {
                window.clearRealtimeFlags();
                log('  ‚úÖ Flags de blocage vid√©s via clearRealtimeFlags', 'success');
            }
            
            // Double v√©rification manuelle
            if (window.realtimeFlagManager) {
                window.realtimeFlagManager.clearAllFlags();
                log('  ‚úÖ Flags vid√©s via flagManager', 'success');
            }
            
            log('  ‚úÖ Tous les flags de blocage sont maintenant clairs', 'success');
        }
        
        async function setupRealtimeSubscription() {
            // Nettoyer toute subscription existante
            if (window.realtimeSubscription) {
                try {
                    await window.supabase.removeChannel(window.realtimeSubscription);
                    window.realtimeSubscription = null;
                    log('  üßπ Ancienne subscription supprim√©e', 'success');
                } catch (error) {
                    log('  ‚ö†Ô∏è Nettoyage de l\'ancienne subscription: ' + error.message, 'warning');
                }
            }
            
            // Attendre un peu
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Cr√©er une nouvelle subscription
            const channelName = `staff-table-fixed-${Date.now()}`;
            log(`  üì° Cr√©ation du channel: ${channelName}`);
            
            const channel = window.supabase
                .channel(channelName)
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'staffTable'
                }, (payload) => {
                    log('üîÑ [REALTIME] INSERT re√ßu: ' + JSON.stringify(payload.new));
                })
                .on('postgres_changes', {
                    event: 'UPDATE',
                    schema: 'public',
                    table: 'staffTable'
                }, (payload) => {
                    log('üîÑ [REALTIME] UPDATE re√ßu: ' + JSON.stringify(payload.new));
                })
                .on('postgres_changes', {
                    event: 'DELETE',
                    schema: 'public',
                    table: 'staffTable'
                }, (payload) => {
                    log('üîÑ [REALTIME] DELETE re√ßu: ' + JSON.stringify(payload.old));
                });
            
            // S'abonner avec promesse
            return new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    reject(new Error('Timeout de subscription (10s)'));
                }, 10000);
                
                channel.subscribe((status, error) => {
                    clearTimeout(timeout);
                    
                    if (status === 'SUBSCRIBED') {
                        window.realtimeSubscription = channel;
                        log('  ‚úÖ Subscription realtime cr√©√©e avec succ√®s', 'success');
                        resolve(channel);
                    } else if (status === 'CHANNEL_ERROR') {
                        log('  ‚ùå Erreur de subscription: ' + (error?.message || 'Inconnue'), 'error');
                        reject(error || new Error('Erreur de subscription'));
                    } else if (status === 'TIMED_OUT') {
                        log('  ‚ùå Timeout de subscription', 'error');
                        reject(new Error('Timeout de subscription'));
                    } else {
                        log('  üìä Statut de subscription: ' + status);
                    }
                });
            });
        }
        
        async function runFinalTests() {
            // Test de diagnostic complet
            if (typeof window.diagnoseRealtime === 'function') {
                log('  üîç Ex√©cution du diagnostic final...');
                const result = await window.diagnoseRealtime();
                
                // Analyser les r√©sultats
                const issues = [];
                
                if (result.supabaseConnection.status !== 'SUCCESS') {
                    issues.push('Connexion Supabase');
                } else {
                    log('    ‚úÖ Connexion Supabase: OK', 'success');
                }
                
                if (result.realtimeSubscription.subscriptionExists) {
                    log('    ‚úÖ Subscription realtime: OK', 'success');
                } else {
                    issues.push('Subscription realtime');
                }
                
                if (!result.blockingFlags.isBlocked) {
                    log('    ‚úÖ Flags de blocage: OK', 'success');
                } else {
                    issues.push('Flags de blocage: ' + result.blockingFlags.activeBlocks.join(', '));
                }
                
                if (result.networkConnectivity.status === 'SUCCESS') {
                    log('    ‚úÖ Connectivit√© r√©seau: OK', 'success');
                } else {
                    issues.push('Connectivit√© r√©seau');
                }
                
                if (issues.length === 0) {
                    log('  üéâ Tous les tests sont r√©ussis !', 'success');
                } else {
                    log('  ‚ö†Ô∏è Probl√®mes restants: ' + issues.join(', '), 'warning');
                }
                
            } else {
                log('  ‚ö†Ô∏è Fonction diagnoseRealtime non disponible', 'warning');
            }
        }
        
        // Instructions au chargement
        window.addEventListener('load', () => {
            log('üöÄ Interface de correction automatique charg√©e');
            log('üìã Cette correction va:');
            log('  1. Initialiser le client Supabase avec les vraies cl√©s');
            log('  2. Configurer toutes les variables globales');
            log('  3. Vider tous les flags de blocage');
            log('  4. Cr√©er une nouvelle subscription realtime');
            log('  5. Tester le bon fonctionnement');
            log('');
            log('üîß Cliquez sur "Correction Automatique Compl√®te" pour commencer');
        });
    </script>
</body>
</html>