<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test PrÃ©servation du Focus - Autosave</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .log { background-color: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0; font-family: monospace; }
        .test-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .test-table th, .test-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .test-table th { background-color: #f8f9fa; }
        .editable-cell { background-color: #fff; cursor: text; transition: all 0.2s ease; }
        .editable-cell:focus { background-color: #e3f2fd; outline: 2px solid #2196f3; box-shadow: 0 0 10px rgba(33, 150, 243, 0.3); }
        .editable-cell:hover { background-color: #f5f5f5; }
        .editable-cell.testing { background-color: #fff3cd; border: 2px solid #ffc107; }
        .editable-cell.restored { background-color: #d4edda; border: 2px solid #28a745; animation: pulse 1s ease-in-out; }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª Test de PrÃ©servation du Focus aprÃ¨s Autosave</h1>
    
    <div class="test-section info">
        <h3>ğŸ“‹ Instructions de Test</h3>
        <p>Ce test vÃ©rifie que le curseur reste dans la cellule Ã©ditÃ©e aprÃ¨s la sauvegarde automatique.</p>
        
        <h4>ğŸ¯ MÃ©thode Simple (RecommandÃ©e):</h4>
        <ol>
            <li><strong>Cliquez sur "ğŸ§ª Test Complet Automatique"</strong></li>
            <li>Cliquez dans une cellule du tableau (Nom, PrÃ©nom, Email, etc.)</li>
            <li>Tapez du texte (par exemple "Test focus")</li>
            <li>Le test se lance automatiquement et simule l'autosave</li>
        </ol>
        
        <h4>ğŸ”§ MÃ©thode Manuelle:</h4>
        <ol>
            <li>Cliquez dans une cellule du tableau</li>
            <li>Cliquez sur "ğŸ“ Test Capture Focus"</li>
            <li>Cliquez sur "ğŸ’¾ Simuler Autosave"</li>
            <li>VÃ©rifiez que le curseur reste dans la cellule</li>
        </ol>
        
        <p><strong>ğŸ’¡ Conseil:</strong> Commencez par le "Test Complet Automatique" pour une expÃ©rience fluide !</p>
    </div>

            <div class="test-section">
            <h3>ğŸ”§ Tests de Focus</h3>
            <button onclick="runCompleteTest()" class="btn-primary">ğŸ§ª Test Complet Automatique</button>
            <button onclick="testFocusCapture()" class="btn-primary">ğŸ“ Test Capture Focus</button>
            <button onclick="testFocusRestoration()" class="btn-success">ğŸ”„ Test Restauration Focus</button>
            <button onclick="simulateAutosave()" class="btn-warning">ğŸ’¾ Simuler Autosave</button>
            <button onclick="clearLogs()" class="btn-warning">ğŸ—‘ï¸ Effacer Logs</button>
        </div>

    <div class="test-section">
        <h3>ğŸ“Š Tableau de Test</h3>
        <table class="test-table">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Nom</th>
                    <th>PrÃ©nom</th>
                    <th>Email</th>
                    <th>TÃ©lÃ©phone</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>1</td>
                    <td class="editable-cell" contenteditable="true" data-label="Nom">Dupont</td>
                    <td class="editable-cell" contenteditable="true" data-label="PrÃ©nom">Jean</td>
                    <td class="editable-cell" contenteditable="true" data-label="Email">jean.dupont@email.com</td>
                    <td class="editable-cell" contenteditable="true" data-label="TÃ©lÃ©phone">0123456789</td>
                </tr>
                <tr>
                    <td>2</td>
                    <td class="editable-cell" contenteditable="true" data-label="Nom">Martin</td>
                    <td class="editable-cell" contenteditable="true" data-label="PrÃ©nom">Marie</td>
                    <td class="editable-cell" contenteditable="true" data-label="Email">marie.martin@email.com</td>
                    <td class="editable-cell" contenteditable="true" data-label="TÃ©lÃ©phone">0987654321</td>
                </tr>
                <tr>
                    <td>3</td>
                    <td class="editable-cell" contenteditable="true" data-label="Nom">Bernard</td>
                    <td class="editable-cell" contenteditable="true" data-label="PrÃ©nom">Pierre</td>
                    <td class="editable-cell" contenteditable="true" data-label="Email">pierre.bernard@email.com</td>
                    <td class="editable-cell" contenteditable="true" data-label="TÃ©lÃ©phone">0555666777</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="test-section">
        <h3>ğŸ“Š RÃ©sultats des Tests</h3>
        <div id="test-results" class="log">Aucun test exÃ©cutÃ©...</div>
    </div>

    <div class="test-section">
        <h3>ğŸ“ Logs DÃ©taillÃ©s</h3>
        <div id="detailed-logs" class="log">Logs dÃ©taillÃ©s...</div>
    </div>

    <script>
        // Variables globales pour simuler le systÃ¨me de focus
        let lastFocusInfo = null;
        let lastCellPos = null;
        let isTyping = false;
        let lastEditAt = Date.now();
        
        // Configuration d'autosave simulÃ©e
        const AUTOSAVE_DELAY_MS = 3000; // 3 secondes
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            
            // Ajouter aux logs dÃ©taillÃ©s
            const detailedLogs = document.getElementById('detailed-logs');
            detailedLogs.innerHTML += logEntry + '\n';
            
            // Ajouter aux rÃ©sultats des tests
            const testResults = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = type;
            resultDiv.textContent = logEntry;
            testResults.appendChild(resultDiv);
            
            console.log(logEntry);
        }
        
        function clearLogs() {
            document.getElementById('test-results').innerHTML = 'Logs effacÃ©s...';
            document.getElementById('detailed-logs').innerHTML = 'Logs dÃ©taillÃ©s...';
        }
        
        // Fonction pour capturer les informations de focus
        function captureFocusInfo() {
            const activeElement = document.activeElement;
            if (activeElement && activeElement.classList.contains('editable-cell')) {
                const row = activeElement.closest('tr');
                const rowIndex = Array.from(row.parentNode.children).indexOf(row);
                const cells = Array.from(row.children);
                const cellIndex = cells.indexOf(activeElement);
                const colLabel = activeElement.getAttribute('data-label');
                
                lastFocusInfo = {
                    rowKey: `row-${rowIndex}`,
                    rowIndex: rowIndex,
                    colLabel: colLabel,
                    caret: getCursorPosition(activeElement)
                };
                
                lastCellPos = {
                    rowIndex: rowIndex,
                    cellIndex: cellIndex
                };
                
                log(`ğŸ“ Focus capturÃ©: Ligne ${rowIndex}, Cellule ${colLabel}, Position curseur: ${lastFocusInfo.caret}`, 'success');
                
                return true;
            }
            return false;
        }
        
        // Fonction pour obtenir la position du curseur
        function getCursorPosition(element) {
            if (!element || element.contentEditable !== 'true') {
                return null;
            }
            
            try {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    const preCaretRange = range.cloneRange();
                    preCaretRange.selectNodeContents(element);
                    preCaretRange.setEnd(range.endContainer, range.endOffset);
                    return preCaretRange.toString().length;
                }
            } catch (error) {
                console.warn('âš ï¸ Erreur lors de la rÃ©cupÃ©ration de la position du curseur:', error);
            }
            
            return null;
        }
        
        // Fonction pour restaurer le focus
        function restoreFocus() {
            if (!lastFocusInfo || !lastCellPos) {
                log('âš ï¸ Aucune information de focus Ã  restaurer', 'warning');
                return false;
            }
            
            try {
                const tbody = document.querySelector('.test-table tbody');
                const targetRow = tbody.children[lastCellPos.rowIndex];
                
                if (!targetRow) {
                    log('âŒ Ligne cible non trouvÃ©e', 'error');
                    return false;
                }
                
                const targetCell = targetRow.children[lastCellPos.cellIndex];
                
                if (!targetCell) {
                    log('âŒ Cellule cible non trouvÃ©e', 'error');
                    return false;
                }
                
                // Restaurer le focus
                targetCell.focus();
                
                // Restaurer la position du curseur
                if (lastFocusInfo.caret !== null) {
                    const range = document.createRange();
                    const selection = window.getSelection();
                    
                    if (targetCell.firstChild) {
                        range.setStart(targetCell.firstChild, Math.min(lastFocusInfo.caret, targetCell.textContent.length));
                        range.collapse(true);
                    } else {
                        range.selectNodeContents(targetCell);
                        range.collapse(true);
                    }
                    
                    selection.removeAllRanges();
                    selection.addRange(range);
                    log(`âœ… Curseur restaurÃ© Ã  la position ${lastFocusInfo.caret}`, 'success');
                } else {
                    // Placer le curseur Ã  la fin
                    const range = document.createRange();
                    const selection = window.getSelection();
                    range.selectNodeContents(targetCell);
                    range.collapse(false);
                    selection.removeAllRanges();
                    selection.addRange(range);
                    log('âœ… Curseur placÃ© Ã  la fin du texte', 'success');
                }
                
                log(`âœ… Focus restaurÃ©: Ligne ${lastCellPos.rowIndex}, Cellule ${lastFocusInfo.colLabel}`, 'success');
                return true;
                
            } catch (error) {
                log(`âŒ Erreur lors de la restauration du focus: ${error.message}`, 'error');
                return false;
            }
        }
        
        // Test de capture du focus
        function testFocusCapture() {
            log('ğŸ§ª Test de capture du focus...');
            
            // VÃ©rifier d'abord si une cellule est focalisÃ©e
            const activeElement = document.activeElement;
            if (activeElement && activeElement.classList.contains('editable-cell')) {
                // Ajouter une classe visuelle pour indiquer que la cellule est en cours de test
                activeElement.classList.add('testing');
                
                const focusInfo = captureFocusInfo();
                if (focusInfo && focusInfo.colLabel && focusInfo.rowIndex !== undefined) {
                    log('âœ… Test de capture rÃ©ussi', 'success');
                    log(`ğŸ“ Cellule: ${focusInfo.colLabel}, Ligne: ${focusInfo.rowIndex}, Curseur: ${focusInfo.caret || 'fin du texte'}`, 'info');
                    
                    // Retirer la classe de test aprÃ¨s un dÃ©lai
                    setTimeout(() => activeElement.classList.remove('testing'), 2000);
                    return true;
                } else {
                    log('âŒ Test de capture Ã©chouÃ© - Erreur interne', 'error');
                    log('ğŸ” DÃ©tails de debug:', 'info');
                    console.log('focusInfo:', focusInfo);
                    
                    // Retirer la classe de test
                    activeElement.classList.remove('testing');
                    return false;
                }
            } else {
                log('âš ï¸ Aucune cellule focalisÃ©e - Cliquez d\'abord dans une cellule du tableau', 'warning');
                log('ğŸ’¡ Conseil: Cliquez dans une cellule (Nom, PrÃ©nom, Email, etc.) puis relancez le test', 'info');
                return false;
            }
        }
        
        // Test de restauration du focus
        function testFocusRestoration() {
            log('ğŸ§ª Test de restauration du focus...');
            
            if (!lastFocusInfo || !lastCellPos) {
                log('âš ï¸ Aucune information de focus Ã  restaurer', 'warning');
                log('ğŸ’¡ Conseil: Lancez d\'abord le test de capture du focus', 'info');
                return;
            }
            
            if (restoreFocus()) {
                log('âœ… Test de restauration rÃ©ussi', 'success');
            } else {
                log('âŒ Test de restauration Ã©chouÃ©', 'error');
            }
        }
        
        // Simulation d'autosave
        function simulateAutosave() {
            log('ğŸ”„ Simulation d\'autosave...');
            
            // VÃ©rifier d'abord si une cellule est focalisÃ©e
            const activeElement = document.activeElement;
            if (!activeElement || !activeElement.classList.contains('editable-cell')) {
                // Essayer d'utiliser les derniÃ¨res informations de focus capturÃ©es
                if (lastFocusInfo && lastCellPos) {
                    log('ğŸ“ Utilisation des derniÃ¨res informations de focus capturÃ©es', 'info');
                    log(`ğŸ“ DerniÃ¨re cellule: ${lastFocusInfo.colLabel}, Ligne: ${lastFocusInfo.rowIndex}`, 'info');
                    
                    // Simuler l'autosave avec les informations capturÃ©es
                    simulateAutosaveWithStoredInfo();
                    return;
                } else {
                    log('âš ï¸ Aucune cellule focalisÃ©e et aucune information de focus stockÃ©e', 'warning');
                    log('ğŸ’¡ Conseil: Cliquez d\'abord dans une cellule du tableau', 'info');
                    return;
                }
            }
            
            // Capturer l'Ã©tat actuel du focus
            const focusBeforeAutosave = {
                activeElement: activeElement,
                selection: window.getSelection().toString(),
                cursorPosition: getCursorPosition(activeElement)
            };
            
            log(`ğŸ“ Ã‰tat du focus capturÃ© avant autosave: ${activeElement.getAttribute('data-label')}`, 'info');
            log(`ğŸ“ Position du curseur: ${focusBeforeAutosave.cursorPosition || 'fin du texte'}`, 'info');
            
            // Simuler le dÃ©lai d'autosave
            setTimeout(() => {
                log('ğŸ’¾ Autosave terminÃ©, restauration du focus...', 'info');
                
                // Restaurer le focus
                if (focusBeforeAutosave.activeElement && document.contains(focusBeforeAutosave.activeElement)) {
                    // Ajouter une classe visuelle pour indiquer la restauration
                    focusBeforeAutosave.activeElement.classList.add('restored');
                    
                    focusBeforeAutosave.activeElement.focus();
                    
                    // Restaurer la position du curseur
                    if (focusBeforeAutosave.cursorPosition !== null) {
                        const range = document.createRange();
                        const selection = window.getSelection();
                        
                        if (focusBeforeAutosave.activeElement.firstChild) {
                            range.setStart(focusBeforeAutosave.activeElement.firstChild, 
                                Math.min(focusBeforeAutosave.cursorPosition, focusBeforeAutosave.activeElement.textContent.length));
                            range.collapse(true);
                        } else {
                            range.selectNodeContents(focusBeforeAutosave.activeElement);
                            range.collapse(true);
                        }
                        
                        selection.removeAllRanges();
                        selection.addRange(range);
                        log(`âœ… Curseur restaurÃ© Ã  la position ${focusBeforeAutosave.cursorPosition}`, 'success');
                    } else {
                        // Placer le curseur Ã  la fin
                        const range = document.createRange();
                        const selection = window.getSelection();
                        range.selectNodeContents(focusBeforeAutosave.activeElement);
                        range.collapse(false);
                        selection.removeAllRanges();
                        selection.addRange(range);
                        log('âœ… Curseur placÃ© Ã  la fin du texte', 'success');
                    }
                    
                    log('âœ… Focus restaurÃ© aprÃ¨s autosave simulÃ©', 'success');
                    
                    // Retirer la classe de restauration aprÃ¨s l'animation
                    setTimeout(() => focusBeforeAutosave.activeElement.classList.remove('restored'), 3000);
                } else {
                    log('âš ï¸ L\'Ã©lÃ©ment cible n\'est plus accessible', 'warning');
                }
            }, 1000); // Simuler 1 seconde de dÃ©lai
        }
        
        // Fonction de simulation d'autosave avec informations stockÃ©es
        function simulateAutosaveWithStoredInfo() {
            log('ğŸ”„ Simulation d\'autosave avec informations stockÃ©es...');
            
            // Utiliser les informations de focus stockÃ©es
            const focusBeforeAutosave = {
                activeElement: null, // Pas d'Ã©lÃ©ment actif, on utilisera la position
                selection: '',
                cursorPosition: lastFocusInfo ? lastFocusInfo.caret : null
            };
            
            log(`ğŸ“ Utilisation des informations stockÃ©es: ${lastFocusInfo.colLabel}, Position curseur: ${focusBeforeAutosave.cursorPosition || 'fin du texte'}`, 'info');
            
            // Simuler le dÃ©lai d'autosave
            setTimeout(() => {
                log('ğŸ’¾ Autosave terminÃ©, restauration du focus par position...', 'info');
                
                // Restaurer le focus en utilisant la position stockÃ©e
                if (restoreFocus()) {
                    log('âœ… Focus restaurÃ© par position aprÃ¨s autosave simulÃ©', 'success');
                    
                    // Restaurer la position du curseur si possible
                    const activeCell = document.activeElement;
                    if (activeCell && activeCell.contentEditable === 'true' && focusBeforeAutosave.cursorPosition !== null) {
                        const range = document.createRange();
                        const selection = window.getSelection();
                        
                        if (activeCell.firstChild) {
                            range.setStart(activeCell.firstChild, 
                                Math.min(focusBeforeAutosave.cursorPosition, activeCell.textContent.length));
                            range.collapse(true);
                        } else {
                            range.selectNodeContents(activeCell);
                            range.collapse(true);
                        }
                        
                        selection.removeAllRanges();
                        selection.addRange(range);
                        log(`âœ… Curseur restaurÃ© Ã  la position ${focusBeforeAutosave.cursorPosition}`, 'success');
                    }
                } else {
                    log('âŒ Ã‰chec de la restauration du focus par position', 'error');
                }
            }, 1000); // Simuler 1 seconde de dÃ©lai
        }
        
        // Test complet automatique
        function runCompleteTest() {
            log('ğŸš€ DÃ©marrage du test complet automatique...');
            log('ğŸ“‹ Instructions:');
            log('   1. Cliquez dans une cellule du tableau (Nom, PrÃ©nom, Email, etc.)');
            log('   2. Tapez du texte (par exemple "Test focus")');
            log('   3. Attendez que le test se lance automatiquement');
            
            // VÃ©rifier si une cellule est dÃ©jÃ  focalisÃ©e
            const activeElement = document.activeElement;
            if (activeElement && activeElement.classList.contains('editable-cell')) {
                log('âœ… Cellule dÃ©jÃ  focalisÃ©e dÃ©tectÃ©e, lancement immÃ©diat du test...');
                runAutomaticTest();
                return;
            }
            
            // Attendre que l'utilisateur clique dans une cellule
            const checkFocus = setInterval(() => {
                const activeElement = document.activeElement;
                if (activeElement && activeElement.classList.contains('editable-cell')) {
                    clearInterval(checkFocus);
                    log('âœ… Cellule focalisÃ©e dÃ©tectÃ©e, lancement du test...');
                    runAutomaticTest();
                }
            }, 500);
            
            // ArrÃªter la vÃ©rification aprÃ¨s 30 secondes
            setTimeout(() => {
                clearInterval(checkFocus);
                if (!document.activeElement || !document.activeElement.classList.contains('editable-cell')) {
                    log('â° Timeout - Aucune cellule focalisÃ©e dÃ©tectÃ©e', 'warning');
                    log('ğŸ’¡ Relancez le test et cliquez dans une cellule', 'info');
                }
            }, 30000);
        }
        
        // Fonction pour exÃ©cuter le test automatique
        function runAutomaticTest() {
            setTimeout(() => {
                log('ğŸ§ª Test automatique en cours...');
                
                // Test 1: Capture du focus
                if (testFocusCapture()) {
                    log('âœ… Test de capture du focus rÃ©ussi', 'success');
                    
                    // Test 2: Simulation d'autosave
                    setTimeout(() => {
                        log('ğŸ”„ Test de simulation d\'autosave...');
                        simulateAutosave();
                    }, 500);
                    
                } else {
                    log('âŒ Ã‰chec du test de capture du focus', 'error');
                    log('ğŸ’¡ VÃ©rifiez que vous avez cliquÃ© dans une cellule et relancez le test', 'info');
                }
            }, 1000);
        }
        
        // Configuration des Ã©vÃ©nements sur les cellules
        function setupCellEvents() {
            const editableCells = document.querySelectorAll('.editable-cell');
            
            editableCells.forEach(cell => {
                // Ã‰vÃ©nement de focus
                cell.addEventListener('focus', () => {
                    log(`ğŸ¯ Focus sur: ${cell.getAttribute('data-label')}`, 'info');
                    captureFocusInfo();
                });
                
                // Ã‰vÃ©nement de saisie
                cell.addEventListener('input', () => {
                    isTyping = true;
                    lastEditAt = Date.now();
                    
                    // Simuler l'autosave aprÃ¨s dÃ©lai
                    setTimeout(() => {
                        if (Date.now() - lastEditAt >= AUTOSAVE_DELAY_MS) {
                            log('â° DÃ©clenchement de l\'autosave simulÃ©...', 'info');
                            simulateAutosave();
                        }
                    }, AUTOSAVE_DELAY_MS);
                    
                    isTyping = false;
                });
                
                // Ã‰vÃ©nement de clic
                cell.addEventListener('click', () => {
                    captureFocusInfo();
                });
            });
        }
        
        // Initialisation au chargement
        window.addEventListener('load', () => {
            log('ğŸš€ Initialisation du test de prÃ©servation du focus...');
            setupCellEvents();
            log('âœ… Test prÃªt - Cliquez dans une cellule et tapez du texte pour tester');
        });
    </script>
</body>
</html>
