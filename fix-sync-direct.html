<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Correction Directe Synchronisation</title>
    <style>
        body { 
            font-family: system-ui, -apple-system, sans-serif; 
            margin: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button { 
            background: #16a34a; 
            color: white; 
            border: none; 
            padding: 16px 32px; 
            border-radius: 6px; 
            cursor: pointer; 
            margin: 10px 5px;
            font-size: 16px;
            font-weight: 600;
        }
        .button:hover { background: #15803d; }
        .button.large { padding: 20px 40px; font-size: 18px; }
        .output { 
            background: #1f2937; 
            color: #f3f4f6; 
            padding: 15px; 
            border-radius: 6px; 
            margin: 15px 0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.4;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }
        .status { 
            padding: 12px; 
            border-radius: 6px; 
            margin: 15px 0; 
            font-weight: bold;
        }
        .status.error { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
        .status.success { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .progress { background: #e5e7eb; height: 6px; border-radius: 3px; margin: 15px 0; overflow: hidden; }
        .progress-bar { background: #16a34a; height: 100%; width: 0%; transition: width 0.5s ease; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Correction Directe de la Synchronisation</h1>
        
        <div class="status error">
            <strong>Diagnostic :</strong> Client Supabase non initialis√©, subscription realtime manquante
        </div>
        
        <div class="grid">
            <button class="button large" onclick="fixSupabaseInit()">1Ô∏è‚É£ Initialiser Supabase</button>
            <button class="button large" onclick="fixRealtimeSync()">2Ô∏è‚É£ Corriger Realtime</button>
            <button class="button large" onclick="testEverything()">3Ô∏è‚É£ Tester Tout</button>
        </div>
        
        <div class="progress">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <div id="output" class="output">Correction directe de la synchronisation\nUtilise la m√™me m√©thode que index.html\n\nüîß √âtapes disponibles:\n  1. Initialiser Supabase (m√™me import que index.html)\n  2. Corriger Realtime (subscription compl√®te)\n  3. Tester Tout (diagnostic final)\n\nCliquez sur les boutons dans l'ordre pour une correction compl√®te.</div>
    </div>

    <!-- Chargement des scripts de diagnostic -->
    <script src="realtime-sync-diagnostics.js"></script>
    <script src="realtime-sync-fix.js"></script>
    
    <script>
        const output = document.getElementById('output');
        const progressBar = document.getElementById('progressBar');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : 'üìÑ';
            output.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }
        
        function setProgress(percent) {
            progressBar.style.width = percent + '%';
        }
        
        function clearOutput() {
            output.textContent = '';
            setProgress(0);
        }
        
        // Configuration Supabase (exactement comme dans index.html)
        const supabaseConfig = {
            supabaseUrl: 'https://fiecugxopjxzqfdnaqsu.supabase.co', 
            supabaseAnonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpZWN1Z3hvcGp4enFmZG5hcXN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDU2NTcsImV4cCI6MjA3MDA4MTY1N30.xd9Thasg4r8Nrwxx5nFwyGB_ufPIvok4XB-78dilpsw', 
            supabaseServiceKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpZWN1Z3hvcGp4enFmZG5hcXN1Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NDUwNTY1NywiZXhwIjoyMDcwMDgxNjU3fQ.5m7nLHxHxOkxQf8maZis7Y7jynqu2dWqIzEbgWvOTcE',
            tableName: 'staffTable',
            primaryKeyColumn: 'id'
        };
        
        // √âtape 1: Initialiser Supabase (exactement comme index.html)
        async function fixSupabaseInit() {
            clearOutput();
            log('üöÄ √âtape 1: Initialisation du client Supabase...');
            setProgress(10);
            
            try {
                // M√©thode exacte d'index.html ligne 1860
                log('üì¶ Import du module Supabase via CDN jsdelivr...');
                const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
                setProgress(30);
                
                // Cr√©ation du client exactement comme index.html
                log('üîß Cr√©ation du client Supabase...');
                window.supabase = createClient(supabaseConfig.supabaseUrl, supabaseConfig.supabaseAnonKey);
                setProgress(50);
                
                if (!window.supabase) {
                    throw new Error('√âchec de cr√©ation du client');
                }
                
                // Configuration globale
                window.supabaseConfig = supabaseConfig;
                window.snapshotMode = 'live';
                
                // R√©initialiser les flags de blocage
                window.isLocalSaveInProgress = false;
                window.isExcelSaveInProgress = false;
                window.isRestoringCursor = () => false;
                
                setProgress(80);
                
                // Test de connexion
                log('üîó Test de connexion...');
                const { data, error } = await window.supabase.auth.getSession();
                
                if (error && error.message.includes('Invalid API key')) {
                    throw new Error('Cl√© API invalide');
                }
                
                setProgress(100);
                log('‚úÖ Client Supabase initialis√© avec succ√®s !', 'success');
                log('‚úÖ Configuration globale appliqu√©e', 'success');
                log('‚úÖ Flags de blocage r√©initialis√©s', 'success');
                log('üí° Pr√™t pour l\'√©tape 2: Corriger Realtime', 'success');
                
            } catch (error) {
                log('‚ùå Erreur lors de l\'initialisation: ' + error.message, 'error');
                setProgress(0);
                throw error;
            }
        }
        
        // √âtape 2: Corriger la synchronisation realtime
        async function fixRealtimeSync() {
            log('\nüîÑ √âtape 2: Correction de la synchronisation realtime...');
            
            if (!window.supabase) {
                log('‚ùå Client Supabase non initialis√©. Ex√©cutez l\'√©tape 1 d\'abord.', 'error');
                return;
            }
            
            try {
                setProgress(0);
                
                // Nettoyer toute subscription existante
                if (window.realtimeSubscription) {
                    log('üßπ Nettoyage de l\'ancienne subscription...');
                    try {
                        await window.supabase.removeChannel(window.realtimeSubscription);
                    } catch (e) {
                        log('‚ö†Ô∏è Nettoyage partiel: ' + e.message, 'warning');
                    }
                    window.realtimeSubscription = null;
                }
                setProgress(20);
                
                // Vider les flags avec les outils disponibles
                log('üßπ Vidage des flags de blocage...');
                if (typeof window.clearRealtimeFlags === 'function') {
                    window.clearRealtimeFlags();
                }
                if (window.realtimeFlagManager) {
                    window.realtimeFlagManager.clearAllFlags();
                }
                setProgress(40);
                
                // Attendre un peu pour la stabilisation
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Cr√©er une nouvelle subscription robuste
                log('üì° Cr√©ation d\'une nouvelle subscription realtime...');
                const channelName = `staff-table-sync-${Date.now()}`;
                
                const channel = window.supabase
                    .channel(channelName)
                    .on('postgres_changes', {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'staffTable'
                    }, (payload) => {
                        log(`üü¢ [REALTIME] INSERT: ${payload.new?.id || 'N/A'}`, 'success');
                        // Appeler le gestionnaire s'il existe
                        if (typeof window.handleRealtimeUpdate === 'function') {
                            window.handleRealtimeUpdate(payload);
                        }
                    })
                    .on('postgres_changes', {
                        event: 'UPDATE',
                        schema: 'public',
                        table: 'staffTable'
                    }, (payload) => {
                        log(`üü° [REALTIME] UPDATE: ${payload.new?.id || 'N/A'}`, 'success');
                        if (typeof window.handleRealtimeUpdate === 'function') {
                            window.handleRealtimeUpdate(payload);
                        }
                    })
                    .on('postgres_changes', {
                        event: 'DELETE',
                        schema: 'public',
                        table: 'staffTable'
                    }, (payload) => {
                        log(`üî¥ [REALTIME] DELETE: ${payload.old?.id || 'N/A'}`, 'success');
                        if (typeof window.handleRealtimeUpdate === 'function') {
                            window.handleRealtimeUpdate(payload);
                        }
                    });
                
                setProgress(60);
                
                // S'abonner avec gestion d'erreur
                return new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('Timeout de subscription (15 secondes)'));
                    }, 15000);
                    
                    channel.subscribe((status, error) => {
                        log(`üìä Statut subscription: ${status}`);
                        
                        if (status === 'SUBSCRIBED') {
                            clearTimeout(timeout);
                            window.realtimeSubscription = channel;
                            setProgress(100);
                            log('‚úÖ Subscription realtime cr√©√©e avec succ√®s !', 'success');
                            log(`‚úÖ Channel: ${channelName}`, 'success');
                            log('‚úÖ √âv√©nements: INSERT, UPDATE, DELETE', 'success');
                            log('üí° Pr√™t pour l\'√©tape 3: Tester Tout', 'success');
                            resolve(channel);
                        } else if (status === 'CHANNEL_ERROR') {
                            clearTimeout(timeout);
                            setProgress(0);
                            log('‚ùå Erreur de subscription: ' + (error?.message || 'Inconnue'), 'error');
                            reject(error || new Error('Erreur de channel'));
                        } else if (status === 'TIMED_OUT') {
                            clearTimeout(timeout);
                            setProgress(0);
                            log('‚ùå Timeout de subscription', 'error');
                            reject(new Error('Timeout de subscription'));
                        }
                    });
                });
                
            } catch (error) {
                log('‚ùå Erreur lors de la correction realtime: ' + error.message, 'error');
                setProgress(0);
                throw error;
            }
        }
        
        // √âtape 3: Test complet
        async function testEverything() {
            log('\nüß™ √âtape 3: Test complet du syst√®me...');
            setProgress(0);
            
            try {
                // Test 1: Client Supabase
                log('üîç Test 1: Client Supabase...');
                if (!window.supabase) {
                    log('‚ùå Client Supabase manquant', 'error');
                    return;
                }
                log('‚úÖ Client Supabase: OK', 'success');
                setProgress(20);
                
                // Test 2: Configuration
                log('üîç Test 2: Configuration globale...');
                if (!window.supabaseConfig) {
                    log('‚ùå Configuration manquante', 'error');
                    return;
                }
                log('‚úÖ Configuration: OK', 'success');
                setProgress(40);
                
                // Test 3: Subscription realtime
                log('üîç Test 3: Subscription realtime...');
                if (!window.realtimeSubscription) {
                    log('‚ùå Subscription manquante', 'error');
                    return;
                }
                
                const state = window.realtimeSubscription.state;
                if (state === 'joined') {
                    log('‚úÖ Subscription realtime: CONNECT√âE', 'success');
                } else {
                    log(`‚ö†Ô∏è Subscription realtime: ${state}`, 'warning');
                }
                setProgress(60);
                
                // Test 4: Flags de blocage
                log('üîç Test 4: Flags de blocage...');
                const hasBlocks = window.isLocalSaveInProgress || window.isExcelSaveInProgress || 
                                 (typeof window.isRestoringCursor === 'function' && window.isRestoringCursor());
                
                if (hasBlocks) {
                    log('‚ö†Ô∏è Flags de blocage actifs', 'warning');
                } else {
                    log('‚úÖ Flags de blocage: OK', 'success');
                }
                setProgress(80);
                
                // Test 5: Diagnostic complet avec les outils
                log('üîç Test 5: Diagnostic avec outils int√©gr√©s...');
                if (typeof window.diagnoseRealtime === 'function') {
                    const diagnostics = await window.diagnoseRealtime();
                    
                    let score = 0;
                    let total = 0;
                    
                    Object.entries(diagnostics).forEach(([key, result]) => {
                        if (key === 'timestamp') return;
                        
                        total++;
                        if (result.status === 'SUCCESS') {
                            score++;
                            log(`  ‚úÖ ${key}: OK`, 'success');
                        } else {
                            log(`  ‚ùå ${key}: ${result.error || result.issue || 'FAILED'}`, 'error');
                        }
                    });
                    
                    const percentage = Math.round((score / total) * 100);
                    log(`üìä Score final: ${score}/${total} (${percentage}%)`, 'success');
                    
                    if (percentage >= 80) {
                        log('üéâ SYST√àME OP√âRATIONNEL !', 'success');
                        log('‚úÖ La synchronisation realtime fonctionne', 'success');
                    } else {
                        log('‚ö†Ô∏è Syst√®me partiellement op√©rationnel', 'warning');
                    }
                } else {
                    log('‚ö†Ô∏è Outils de diagnostic non disponibles', 'warning');
                }
                
                setProgress(100);
                log('\nüèÅ Tests termin√©s !', 'success');
                log('üí° Vous pouvez maintenant utiliser votre syst√®me principal', 'success');
                
            } catch (error) {
                log('‚ùå Erreur lors des tests: ' + error.message, 'error');
                setProgress(0);
            }
        }
        
        // Auto-diagnostic au chargement
        window.addEventListener('load', () => {
            log('üöÄ Interface de correction directe charg√©e');
            log('üìã M√©thode: Utilise exactement les m√™mes imports que index.html');
            log('');
            log('üîß √âtapes de correction:');
            log('  1Ô∏è‚É£ Initialiser Supabase (import CDN + client)');
            log('  2Ô∏è‚É£ Corriger Realtime (subscription compl√®te)');
            log('  3Ô∏è‚É£ Tester Tout (diagnostic final)');
            log('');
            log('üí° Ex√©cutez les √©tapes dans l\'ordre pour une correction compl√®te');
        });
    </script>
</body>
</html>