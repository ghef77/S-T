<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Test Snapshot Manuel</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-success:hover {
            background: #1e7e34;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .console {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
    </style>
    <!-- Supabase Client Library -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Snapshot Manuel</h1>
        <p>Cette page teste la fonctionnalit√© de snapshot manuel ajout√©e √† l'interface principale.</p>
        
        <div class="test-section">
            <h3>üìã Test de la Fonction</h3>
            <p>V√©rifiez que la fonction <code>createManualSnapshot</code> est disponible :</p>
            <button class="btn" onclick="testFunctionAvailability()">üîç V√©rifier Disponibilit√©</button>
            <div id="function-status"></div>
        </div>
        
        <div class="test-section">
            <h3>üöÄ Test de Cr√©ation</h3>
            <p>Testez la cr√©ation d'un snapshot manuel :</p>
            <button class="btn btn-success" onclick="testManualSnapshot()">üì∏ Cr√©er Snapshot Manuel</button>
            <button class="btn" onclick="testDirectSnapshot()">‚ö° Test Direct</button>
            <button class="btn" onclick="testWithAnonKey()">üîì Test Cl√© Anon</button>
            <div id="creation-status"></div>
        </div>
        
        <div class="test-section">
            <h3>üìä Console de Test</h3>
            <div class="console" id="test-console">
                <div>Console de test pr√™te...</div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üîë Informations sur les Cl√©s</h3>
            <p><strong>Cl√© de Service (Service Role)</strong> : Utilis√©e par d√©faut pour contourner les politiques RLS</p>
            <p><strong>Cl√© Anon</strong> : Test√©e pour confirmer les restrictions RLS</p>
            <div class="status info">
                üí° <strong>Note :</strong> La cl√© de service contourne toutes les politiques RLS et permet l'insertion
            </div>
        </div>
        
        <div class="test-section">
            <h3>üîó Retour √† l'Interface Principale</h3>
            <p>Testez le bouton dans l'interface principale :</p>
            <a href="index.html" class="btn">üè† Retour √† l'Interface</a>
        </div>
    </div>

    <script>
        // Fonction pour logger dans la console de test
        function logToTestConsole(message, type = 'info') {
            const console = document.getElementById('test-console');
            const time = new Date().toLocaleTimeString('fr-FR');
            const line = document.createElement('div');
            line.innerHTML = `[${time}] ${message}`;
            line.style.color = type === 'error' ? '#ff0000' : type === 'success' ? '#00ff00' : '#00ffff';
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;
        }

        // Test de disponibilit√© de la fonction
        function testFunctionAvailability() {
            const statusDiv = document.getElementById('function-status');
            
            if (typeof window.createManualSnapshot === 'function') {
                statusDiv.innerHTML = '<div class="status success">‚úÖ Fonction createManualSnapshot disponible</div>';
                logToTestConsole('‚úÖ Fonction createManualSnapshot disponible', 'success');
            } else {
                statusDiv.innerHTML = '<div class="status warning">‚ö†Ô∏è Fonction non disponible - Cr√©ation d\'une version de test</div>';
                logToTestConsole('‚ö†Ô∏è Fonction non disponible - Cr√©ation d\'une version de test', 'info');
                
                // Cr√©er une version de test de la fonction
                createTestVersion();
            }
        }
        
        // Cr√©er une version de test de la fonction
        function createTestVersion() {
            try {
                // Configuration Supabase de test
                const SUPABASE_URL = 'https://fiecugxopjxzqfdnaqsu.supabase.co';
                const SUPABASE_SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpZWN1Z3hvcGp4enFmZG5hcXN1Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NDUwNTY1NywiZXhwIjoyMDcwMDgxNjU3fQ.5m7nLHxHxOkxQf8maZis7Y7jynqu2dWqIzEbgWvOTcE';
                
                // Cr√©er un client Supabase de test avec la cl√© de service
                let supabase;
                try {
                    if (window.supabase && window.supabase.createClient) {
                        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);
                    } else if (typeof Supabase !== 'undefined') {
                        supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);
                    } else {
                        throw new Error('Biblioth√®que Supabase non charg√©e');
                    }
                    
                    logToTestConsole('üîë Client Supabase cr√©√© avec la cl√© de service', 'info');
                } catch (error) {
                    throw new Error(`Erreur de cr√©ation du client Supabase: ${error.message}`);
                }
                
                // Cr√©er la fonction de test
                window.createManualSnapshot = async function() {
                    try {
                        logToTestConsole('üöÄ Cr√©ation d\'un snapshot manuel de test...', 'info');
                        
                        // Donn√©es de test
                        const testData = [
                            { No: 1, Name: 'Test User 1', Department: 'Test Dept', Status: 'Active' },
                            { No: 2, Name: 'Test User 2', Department: 'Test Dept', Status: 'Inactive' },
                            { No: 3, Name: 'Test User 3', Department: 'Test Dept', Status: 'Active' }
                        ];
                        
                        // G√©n√©rer un nom de fichier unique
                        const now = new Date();
                        const timestamp = now.getTime();
                        const dateString = now.toISOString().split('T')[0];
                        const timeString = now.toTimeString().split(' ')[0].replace(/:/g, '-');
                        
                        // Chemin de stockage
                        const year = now.getFullYear();
                        const month = (now.getMonth() + 1).toString().padStart(2, '0');
                        const day = now.getDate().toString().padStart(2, '0');
                        const objectPath = `${year}/${month}/${day}/TEST_MANUAL_${timeString}_staffTable.json`;
                        
                        // Pr√©parer les donn√©es
                        const snapshotData = {
                            data: testData,
                            metadata: {
                                table: 'staffTable',
                                rowCount: testData.length,
                                createdAt: now.toISOString(),
                                snapshotDate: dateString,
                                type: 'TEST_MANUAL_SNAPSHOT',
                                version: '2.0.0',
                                description: 'Snapshot manuel de test',
                                timestamp: timestamp,
                                userAction: 'test_creation'
                            }
                        };
                        
                        const jsonContent = JSON.stringify(snapshotData, null, 2);
                        const fileSize = new TextEncoder().encode(jsonContent).length;
                        
                        logToTestConsole(`üìä Cr√©ation du snapshot de test: ${testData.length} lignes, ${(fileSize / 1024).toFixed(2)} KB`, 'info');
                        
                        // Upload vers le stockage
                        const { error: uploadError } = await supabase.storage
                            .from('table-snapshots')
                            .upload(objectPath, jsonContent, {
                                contentType: 'application/json',
                                upsert: true
                            });
                        
                        if (uploadError) {
                            throw new Error(`Erreur lors de l'upload: ${uploadError.message}`);
                        }
                        
                        logToTestConsole(`üíæ Snapshot de test upload√© vers: ${objectPath}`, 'success');
                        
                        // Cr√©er l'enregistrement dans l'index
                        const { error: indexError } = await supabase
                            .from('table_snapshots_index')
                            .insert({
                                snapshot_date: dateString,
                                object_path: objectPath,
                                row_count: testData.length,
                                file_size_bytes: fileSize,
                                metadata: snapshotData.metadata
                            });
                        
                        if (indexError) {
                            throw new Error(`Erreur lors de la cr√©ation de l'index: ${indexError.message}`);
                        }
                        
                        logToTestConsole(`‚úÖ Snapshot de test index√© avec succ√®s pour la date: ${dateString}`, 'success');
                        
                        return { success: true, objectPath, dateString };
                        
                    } catch (error) {
                        logToTestConsole(`‚ùå Erreur lors de la cr√©ation du snapshot de test: ${error.message}`, 'error');
                        throw error;
                    }
                };
                
                logToTestConsole('‚úÖ Version de test de createManualSnapshot cr√©√©e avec succ√®s!', 'success');
                
                // Mettre √† jour le statut
                const statusDiv = document.getElementById('function-status');
                if (statusDiv) {
                    statusDiv.innerHTML = '<div class="status success">‚úÖ Version de test cr√©√©e et disponible</div>';
                }
                
            } catch (error) {
                logToTestConsole(`‚ùå Erreur lors de la cr√©ation de la version de test: ${error.message}`, 'error');
                
                // Mettre √† jour le statut en cas d'erreur
                const statusDiv = document.getElementById('function-status');
                if (statusDiv) {
                    statusDiv.innerHTML = `<div class="status error">‚ùå Erreur: ${error.message}</div>`;
                }
            }
        }

        // Test de cr√©ation de snapshot manuel
        async function testManualSnapshot() {
            const statusDiv = document.getElementById('creation-status');
            statusDiv.innerHTML = '<div class="status info">üîÑ Test en cours...</div>';
            
            try {
                logToTestConsole('üöÄ D√©marrage du test de snapshot manuel...', 'info');
                
                // V√©rifier que la fonction existe
                if (typeof window.createManualSnapshot !== 'function') {
                    throw new Error('Fonction createManualSnapshot non disponible');
                }
                
                logToTestConsole('‚úÖ Fonction disponible, lancement du test...', 'info');
                
                // Appeler la fonction (elle g√®re ses propres donn√©es de test)
                const result = await window.createManualSnapshot();
                
                if (result && result.success) {
                    logToTestConsole('‚úÖ Test de snapshot manuel termin√© avec succ√®s!', 'success');
                    logToTestConsole(`üìÅ Fichier cr√©√©: ${result.objectPath}`, 'success');
                    logToTestConsole(`üìÖ Date: ${result.dateString}`, 'success');
                    statusDiv.innerHTML = '<div class="status success">‚úÖ Test termin√© avec succ√®s!</div>';
                } else {
                    throw new Error('La fonction a retourn√© un r√©sultat inattendu');
                }
                
            } catch (error) {
                logToTestConsole(`‚ùå Erreur lors du test: ${error.message}`, 'error');
                statusDiv.innerHTML = `<div class="status error">‚ùå Erreur: ${error.message}</div>`;
            }
                }
        
        // Test direct sans v√©rification pr√©alable
        async function testDirectSnapshot() {
            const statusDiv = document.getElementById('creation-status');
            statusDiv.innerHTML = '<div class="status info">üîÑ Test direct en cours...</div>';
            
            try {
                logToTestConsole('‚ö° Test direct de snapshot manuel...', 'info');
                
                // Cr√©er directement la fonction de test si elle n'existe pas
                if (typeof window.createManualSnapshot !== 'function') {
                    logToTestConsole('üîß Cr√©ation automatique de la fonction de test...', 'info');
                    createTestVersion();
                    
                    // Attendre un peu que la fonction soit cr√©√©e
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // V√©rifier que la fonction est maintenant disponible
                if (typeof window.createManualSnapshot !== 'function') {
                    throw new Error('Impossible de cr√©er la fonction de test');
                }
                
                logToTestConsole('‚úÖ Fonction disponible, lancement du test direct...', 'info');
                
                // Appeler la fonction
                const result = await window.createManualSnapshot();
                
                if (result && result.success) {
                    logToTestConsole('‚úÖ Test direct r√©ussi!', 'success');
                    logToTestConsole(`üìÅ Fichier: ${result.objectPath}`, 'success');
                    logToTestConsole(`üìÖ Date: ${result.dateString}`, 'success');
                    statusDiv.innerHTML = '<div class="status success">‚úÖ Test direct r√©ussi!</div>';
                } else {
                    throw new Error('R√©sultat inattendu de la fonction');
                }
                
            } catch (error) {
                logToTestConsole(`‚ùå Erreur lors du test direct: ${error.message}`, 'error');
                statusDiv.innerHTML = `<div class="status error">‚ùå Erreur: ${error.message}</div>`;
            }
        }
        
        // Test avec la cl√© anon (pour comparaison)
        async function testWithAnonKey() {
            const statusDiv = document.getElementById('creation-status');
            statusDiv.innerHTML = '<div class="status info">üîÑ Test avec cl√© anon en cours...</div>';
            
            try {
                logToTestConsole('üîì Test avec cl√© anon...', 'info');
                
                // Configuration avec cl√© anon
                const SUPABASE_URL = 'https://fiecugxopjxzqfdnaqsu.supabase.co';
                const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpZWN1Z3hvcGp4enFmZG5hcXN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDU2NTcsImV4cCI6MjA3MDA4MTY1N30.xd9Thasg4r8Nrwxx5nFwyGB_ufPIvok4XB-78dilpsw';
                
                // Cr√©er un client avec cl√© anon
                let supabase;
                if (window.supabase && window.supabase.createClient) {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                } else if (typeof Supabase !== 'undefined') {
                    supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                } else {
                    throw new Error('Biblioth√®que Supabase non charg√©e');
                }
                
                logToTestConsole('üîì Client cr√©√© avec cl√© anon, test d\'insertion...', 'info');
                
                // Test simple d'insertion pour voir l'erreur RLS
                const testData = { test: 'RLS test' };
                const { error: insertError } = await supabase
                    .from('table_snapshots_index')
                    .insert({
                        snapshot_date: new Date().toISOString().split('T')[0],
                        object_path: 'test_rls.json',
                        row_count: 1,
                        file_size_bytes: 100,
                        metadata: testData
                    });
                
                if (insertError) {
                    logToTestConsole(`‚ùå Erreur RLS avec cl√© anon: ${insertError.message}`, 'error');
                    statusDiv.innerHTML = '<div class="status error">‚ùå Erreur RLS confirm√©e avec cl√© anon</div>';
                } else {
                    logToTestConsole('‚úÖ Insertion r√©ussie avec cl√© anon (surprenant!)', 'success');
                    statusDiv.innerHTML = '<div class="status success">‚úÖ Insertion r√©ussie avec cl√© anon</div>';
                }
                
            } catch (error) {
                logToTestConsole(`‚ùå Erreur lors du test avec cl√© anon: ${error.message}`, 'error');
                statusDiv.innerHTML = `<div class="status error">‚ùå Erreur: ${error.message}</div>`;
            }
        }
        
        // Test automatique au chargement
        window.addEventListener('load', () => {
            logToTestConsole('üß™ Page de test charg√©e', 'info');
            logToTestConsole('üí° Cliquez sur "V√©rifier Disponibilit√©" pour commencer', 'info');
        });

        // Intercepter les logs de la console pour les afficher
        const originalLog = console.log;
        const originalError = console.error;
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            const message = args.join(' ');
            if (message.includes('üöÄ') || message.includes('üìä') || message.includes('‚úÖ') || message.includes('‚ùå')) {
                logToTestConsole(message, 'info');
            }
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            const message = args.join(' ');
            logToTestConsole(message, 'error');
        };
    </script>
</body>
</html>
