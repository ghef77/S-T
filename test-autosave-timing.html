<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Timing Autosave</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-cell { 
            border: 1px solid #ccc; 
            padding: 10px; 
            margin: 10px; 
            min-height: 50px;
            background: #f9f9f9;
        }
        .log { 
            background: #f0f0f0; 
            padding: 10px; 
            margin: 10px; 
            border-radius: 5px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: green; }
        .warning { color: orange; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>Test du Timing de l'Autosave</h1>
    
    <div class="test-cell" contenteditable="true" data-original-value="Test initial">
        Test initial
    </div>
    
    <button onclick="testTypingBehavior()">Test Comportement de Frappe</button>
    <button onclick="testFocusPreservation()">Test Pr√©servation du Focus</button>
    <button onclick="clearLog()">Effacer Log</button>
    
    <div class="log" id="log"></div>
    
    <script>
        let logCount = 0;
        let lastEditAt = null;
        let isTyping = false;
        let typingTimer = null;
        const AUTOSAVE_DELAY_MS = 3000;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            logCount++;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
            logCount = 0;
        }
        
        function testTypingBehavior() {
            log('üß™ Test du comportement de frappe...', 'info');
            
            const cell = document.querySelector('.test-cell');
            const originalValue = cell.dataset.originalValue;
            
            // Simuler plusieurs frappes rapides
            log('‚å®Ô∏è Simulation de frappes rapides...', 'info');
            
            // Premi√®re frappe
            simulateTyping(cell, 'T', 0);
            
            // Deuxi√®me frappe apr√®s 200ms
            setTimeout(() => {
                simulateTyping(cell, 'Te', 200);
            }, 200);
            
            // Troisi√®me frappe apr√®s 400ms
            setTimeout(() => {
                simulateTyping(cell, 'Tes', 400);
            }, 400);
            
            // Quatri√®me frappe apr√®s 600ms
            setTimeout(() => {
                simulateTyping(cell, 'Test', 600);
            }, 600);
            
            // V√©rifier le timing apr√®s 1 seconde
            setTimeout(() => {
                checkTiming();
            }, 1000);
        }
        
        function simulateTyping(cell, newValue, delay) {
            cell.textContent = newValue;
            cell.dataset.originalValue = newValue;
            
            log(`‚å®Ô∏è Frappe simul√©e (${delay}ms): "${newValue}"`, 'info');
            
            // Appeler markEdited simul√©
            markEditedSimulated();
        }
        
        function markEditedSimulated() {
            isTyping = true;
            
            // Ne pas r√©initialiser lastEditAt √† chaque frappe - seulement la premi√®re fois
            if (!lastEditAt || Date.now() - lastEditAt > 1000) {
                lastEditAt = Date.now();
                log('üïê D√©marrage du compte √† rebours autosave (3s)', 'success');
            } else {
                log('‚è±Ô∏è Compte √† rebours autosave en cours...', 'warning');
            }
            
            if (typingTimer) clearTimeout(typingTimer);
            typingTimer = setTimeout(() => { isTyping = false; }, 1200);
        }
        
        function checkTiming() {
            if (lastEditAt) {
                const timeSinceLastEdit = Date.now() - lastEditAt;
                const remainingTime = AUTOSAVE_DELAY_MS - timeSinceLastEdit;
                
                log(`‚è∞ Timing v√©rifi√©:`, 'info');
                log(`   - Derni√®re √©dition: ${timeSinceLastEdit}ms`, 'info');
                log(`   - Temps restant avant autosave: ${remainingTime}ms`, 'info');
                
                if (remainingTime > 0) {
                    log(`‚úÖ Autosave pr√©vu dans ${Math.ceil(remainingTime/1000)}s`, 'success');
                } else {
                    log(`üöÄ Autosave d√©clench√©!`, 'success');
                }
            } else {
                log('‚ùå Aucun timing d'√©dition enregistr√©', 'error');
            }
        }
        
        function testFocusPreservation() {
            log('üß™ Test de pr√©servation du focus...', 'info');
            
            const cell = document.querySelector('.test-cell');
            cell.focus();
            
            // Capturer l'√©tat du focus
            const focusState = {
                element: cell,
                position: 0
            };
            
            log('üìù Focus captur√© sur la cellule', 'info');
            
            // Simuler une sauvegarde automatique
            setTimeout(() => {
                log('üíæ Simulation de sauvegarde automatique...', 'info');
                
                // Simuler la perte de focus
                cell.blur();
                log('üö´ Focus perdu pendant la sauvegarde', 'warning');
                
                // Restaurer le focus
                setTimeout(() => {
                    restoreFocusSimulated(focusState);
                }, 100);
            }, 500);
        }
        
        function restoreFocusSimulated(focusState) {
            if (focusState && focusState.element) {
                focusState.element.focus();
                log('‚úÖ Focus restaur√© apr√®s la sauvegarde', 'success');
                
                // V√©rifier que le focus est bien restaur√©
                if (document.activeElement === focusState.element) {
                    log('‚úÖ Test de pr√©servation du focus r√©ussi!', 'success');
                } else {
                    log('‚ùå Test de pr√©servation du focus √©chou√©!', 'error');
                }
            }
        }
        
        // Initialisation
        log('üöÄ Test de timing autosave initialis√©', 'info');
        log('Cliquez sur "Test Comportement de Frappe" pour v√©rifier le timing', 'info');
        log('Cliquez sur "Test Pr√©servation du Focus" pour v√©rifier la pr√©servation du focus', 'info');
    </script>
</body>
</html>
