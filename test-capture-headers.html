<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Capture d'√âcran - En-t√™tes en Haut</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-table { 
            border-collapse: collapse; 
            margin: 20px 0; 
            width: 100%;
            max-width: 800px;
            height: 600px;
            overflow-y: auto;
        }
        .test-table th, .test-table td { 
            border: 2px solid #007bff; 
            padding: 15px; 
            text-align: center;
            background: #f8f9fa;
            font-size: 16px;
        }
        .test-table thead { 
            position: sticky !important; 
            top: 0 !important; 
            z-index: 1000 !important; 
            background-color: #007bff !important;
            color: white !important;
            font-weight: 600 !important;
            text-transform: uppercase !important;
            letter-spacing: 0.05em !important;
            /* ‚úÖ GARANTIR que les en-t√™tes restent toujours visibles */
            will-change: transform !important;
            transform: translateZ(0) !important;
            /* ‚úÖ Ombre pour s√©parer visuellement les en-t√™tes */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
            /* ‚úÖ Bordure inf√©rieure pour d√©limiter clairement */
            border-bottom: 3px solid #0056b3 !important;
        }
        .test-table thead th {
            padding: 1rem;
            font-size: 0.875rem;
        }
        .test-table tbody tr {
            transition: all 0.2s ease;
        }
        .test-table tbody tr:hover {
            background-color: #e3f2fd;
            transform: scale(1.005);
        }
        .instructions {
            background: #e3f2fd;
            padding: 15px;
            margin: 20px;
            border-radius: 8px;
            border-left: 4px solid #2196f3;
        }
        .status {
            background: #fff3cd;
            padding: 10px;
            margin: 10px;
            border-radius: 5px;
            border-left: 4px solid #ffc107;
        }
        .log {
            background: #f8f9fa;
            padding: 15px;
            margin: 20px;
            border-radius: 8px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }
        .success { color: #28a745; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .info { color: #17a2b8; font-weight: bold; }
        button { 
            padding: 12px 20px; 
            margin: 8px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        
        /* ‚úÖ Styles pour les en-t√™tes pendant la capture d'√©cran */
        .test-table thead.capturing {
            position: absolute !important;
            top: 0px !important;
            left: 0px !important;
            right: 0px !important;
            z-index: 10000 !important;
            background-color: #007bff !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
            border-bottom: 3px solid #ffc107 !important;
            /* ‚úÖ Garantir la visibilit√© pendant la capture */
            visibility: visible !important;
            opacity: 1 !important;
            /* ‚úÖ Emp√™cher tout d√©bordement */
            overflow: visible !important;
            /* ‚úÖ Forcer l'affichage en haut */
            transform: translateY(0) !important;
        }
    </style>
</head>
<body>
    <h1>üß™ Test Capture d'√âcran - En-t√™tes en Haut</h1>
    
    <div class="instructions">
        <h3>üìã Test de la Capture d'√âcran</h3>
        <p><strong>Objectif :</strong> V√©rifier que les en-t√™tes restent en haut lors de la capture d'√©cran, m√™me apr√®s d√©filement.</p>
        <ol>
            <li>Faites d√©filer le tableau vers le bas (les en-t√™tes restent visibles en haut)</li>
            <li>Cliquez sur "Capture d'√âcran" pour tester la fonction</li>
            <li>V√©rifiez que l'image captur√©e a les en-t√™tes en haut</li>
            <li>Les en-t√™tes doivent appara√Ætre en haut, pas au milieu</li>
        </ol>
    </div>
    
    <div class="status" id="status">
        <strong>√âtat :</strong> Pr√™t pour le test de capture d'√©cran
    </div>
    
    <div style="margin: 20px;">
        <button onclick="testCapture()" class="btn-primary">üì∏ Capture d'√âcran</button>
        <button onclick="scrollToBottom()" class="btn-warning">‚¨áÔ∏è D√©filer vers le Bas</button>
        <button onclick="scrollToTop()" class="btn-success">‚¨ÜÔ∏è D√©filer vers le Haut</button>
        <button onclick="clearLog()" class="btn-success">üóëÔ∏è Effacer Log</button>
    </div>
    
    <table class="test-table" id="test-table">
        <thead>
            <tr>
                <th>Nom</th>
                <th>Pr√©nom</th>
                <th>Email</th>
                <th>T√©l√©phone</th>
                <th>D√©partement</th>
            </tr>
        </thead>
        <tbody>
            <tr><td>Dupont</td><td>Jean</td><td>jean.dupont@email.com</td><td>01 23 45 67 89</td><td>IT</td></tr>
            <tr><td>Martin</td><td>Marie</td><td>marie.martin@email.com</td><td>01 98 76 54 32</td><td>RH</td></tr>
            <tr><td>Bernard</td><td>Pierre</td><td>pierre.bernard@email.com</td><td>01 11 22 33 44</td><td>Marketing</td></tr>
            <tr><td>Petit</td><td>Sophie</td><td>sophie.petit@email.com</td><td>01 55 66 77 88</td><td>Finance</td></tr>
            <tr><td>Moreau</td><td>Lucas</td><td>lucas.moreau@email.com</td><td>01 99 88 77 66</td><td>Ventes</td></tr>
            <tr><td>Leroy</td><td>Emma</td><td>emma.leroy@email.com</td><td>01 44 33 22 11</td><td>R&D</td></tr>
            <tr><td>Garcia</td><td>Thomas</td><td>thomas.garcia@email.com</td><td>01 77 88 99 00</td><td>Support</td></tr>
            <tr><td>Roux</td><td>Julie</td><td>julie.roux@email.com</td><td>01 12 34 56 78</td><td>Marketing</td></tr>
            <tr><td>Simon</td><td>Paul</td><td>paul.simon@email.com</td><td>01 87 65 43 21</td><td>IT</td></tr>
            <tr><td>Michel</td><td>Claire</td><td>claire.michel@email.com</td><td>01 98 76 54 32</td><td>RH</td></tr>
            <tr><td>Lefevre</td><td>Antoine</td><td>antoine.lefevre@email.com</td><td>01 11 22 33 44</td><td>Finance</td></tr>
            <tr><td>Girard</td><td>Camille</td><td>camille.girard@email.com</td><td>01 55 66 77 88</td><td>Ventes</td></tr>
            <tr><td>Bonnet</td><td>Hugo</td><td>hugo.bonnet@email.com</td><td>01 99 88 77 66</td><td>Support</td></tr>
            <tr><td>Dupuis</td><td>L√©a</td><td>lea.dupuis@email.com</td><td>01 44 33 22 11</td><td>R&D</td></tr>
            <tr><td>Lambert</td><td>Nathan</td><td>nathan.lambert@email.com</td><td>01 77 88 99 00</td><td>IT</td></tr>
            <tr><td>Fontaine</td><td>Chlo√©</td><td>chloe.fontaine@email.com</td><td>01 12 34 56 78</td><td>Marketing</td></tr>
            <tr><td>Rousseau</td><td>Ethan</td><td>ethan.rousseau@email.com</td><td>01 87 65 43 21</td><td>Finance</td></tr>
            <tr><td>Blanc</td><td>Zo√©</td><td>zoe.blanc@email.com</td><td>01 98 76 54 32</td><td>RH</td></tr>
            <tr><td>Henry</td><td>Adam</td><td>adam.henry@email.com</td><td>01 11 22 33 44</td><td>Ventes</td></tr>
            <tr><td>Garnier</td><td>Lola</td><td>lola.garnier@email.com</td><td>01 55 66 77 88</td><td>Support</td></tr>
        </tbody>
    </table>
    
    <div class="log" id="log">
        <div class="info">üöÄ Test de capture d'√©cran initialis√©</div>
    </div>
    
    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(message) {
            document.getElementById('status').innerHTML = `<strong>√âtat :</strong> ${message}`;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '<div class="info">üöÄ Test de capture d\'√©cran initialis√©</div>';
        }
        
        function scrollToBottom() {
            const table = document.getElementById('test-table');
            table.scrollTop = table.scrollHeight;
            log('‚¨áÔ∏è D√©filement vers le bas effectu√©', 'info');
            updateStatus('Tableau d√©fil√© vers le bas - En-t√™tes restent visibles en haut');
        }
        
        function scrollToTop() {
            const table = document.getElementById('test-table');
            table.scrollTop = 0;
            log('‚¨ÜÔ∏è D√©filement vers le haut effectu√©', 'info');
            updateStatus('Tableau d√©fil√© vers le haut');
        }
        
        // ‚úÖ FONCTION DE CAPTURE CORRIG√âE (comme dans index.html)
        function testCapture() { 
            const table = document.getElementById('test-table'); 
            
            // ‚úÖ CAPTURE DE LA ZONE VISIBLE: Prendre seulement ce qui est √† l'√©cran
            const container = table.closest('.table-container') || table.parentElement;
            const scrollTop = container ? container.scrollTop : 0;
            const scrollLeft = container ? container.scrollLeft : 0;
            const viewportHeight = window.innerHeight;
            const viewportWidth = window.innerWidth;
            
            log('üì∏ D√©but de la capture d\'√©cran...', 'info');
            
            // ‚úÖ NOUVELLE APPROCHE: Cr√©er une copie du tableau pour la capture
            const tableClone = table.cloneNode(true);
            
            // ‚úÖ Supprimer les classes et styles probl√©matiques
            tableClone.classList.remove('capturing');
            tableClone.style.position = 'static';
            tableClone.style.top = 'auto';
            tableClone.style.zIndex = 'auto';
            
            // ‚úÖ Corriger les en-t√™tes dans la copie
            const theadClone = tableClone.querySelector('thead');
            if (theadClone) {
                theadClone.style.position = 'static';
                theadClone.style.top = 'auto';
                theadClone.style.zIndex = 'auto';
                theadClone.style.backgroundColor = '#007bff';
                theadClone.style.color = 'white';
                theadClone.style.fontWeight = 'bold';
                theadClone.style.textTransform = 'uppercase';
                
                // ‚úÖ Corriger chaque cellule d'en-t√™te
                const thCells = theadClone.querySelectorAll('th');
                thCells.forEach((th, index) => {
                    th.style.position = 'static';
                    th.style.top = 'auto';
                    th.style.left = 'auto';
                    th.style.zIndex = 'auto';
                    th.style.backgroundColor = '#007bff';
                    th.style.color = 'white';
                    th.style.fontWeight = 'bold';
                    th.style.border = '1px solid #e5e7eb';
                    th.style.padding = '1rem';
                    
                    // ‚úÖ CORRECTION SP√âCIALE pour la colonne "N¬∞" (premi√®re colonne)
                    if (index === 0) {
                        th.style.backgroundColor = '#007bff !important';
                        th.style.color = 'white !important';
                        th.style.fontWeight = 'bold !important';
                        th.style.border = '1px solid #e5e7eb !important';
                        th.style.padding = '1rem !important';
                        th.style.position = 'static !important';
                        th.style.left = 'auto !important';
                        th.style.zIndex = 'auto !important';
                        // ‚úÖ S'assurer que le texte "N¬∞" est visible
                        th.style.visibility = 'visible !important';
                        th.style.opacity = '1 !important';
                        th.style.display = 'table-cell !important';
                    }
                });
            }
            
            // ‚úÖ Corriger les cellules du corps du tableau
            const tbodyClone = tableClone.querySelector('tbody');
            if (tbodyClone) {
                const rows = tbodyClone.querySelectorAll('tr');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    cells.forEach((td, cellIndex) => {
                        td.style.position = 'static';
                        td.style.top = 'auto';
                        td.style.left = 'auto';
                        td.style.zIndex = 'auto';
                        td.style.backgroundColor = '#ffffff';
                        td.style.border = '1px solid #e5e7eb';
                        td.style.padding = '1rem';
                        
                        // ‚úÖ CORRECTION SP√âCIALE pour la colonne "N¬∞" (premi√®re colonne)
                        if (cellIndex === 0) {
                            td.style.backgroundColor = '#ffffff !important';
                            td.style.color = '#1f2937 !important'; // Texte fonc√©
                            td.style.fontWeight = 'bold !important';
                            td.style.border = '1px solid #e5e7eb !important';
                            td.style.padding = '1rem !important';
                            td.style.position = 'static !important';
                            td.style.left = 'auto !important';
                            td.style.zIndex = 'auto !important';
                            // ‚úÖ S'assurer que le num√©ro de ligne est visible
                            td.style.visibility = 'visible !important';
                            td.style.opacity = '1 !important';
                            td.style.display = 'table-cell !important';
                            // ‚úÖ Supprimer les classes probl√©matiques
                            td.classList.remove('frozen-column', 'frozen-1');
                        }
                    });
                });
            }
            
            log('‚úÖ Copie du tableau corrig√©e, ajout au DOM...', 'success');
            
            // ‚úÖ Ajouter la copie au DOM temporairement (hors de l'√©cran mais visible)
            tableClone.style.position = 'absolute';
            tableClone.style.left = '-9999px';
            tableClone.style.top = '0px';
            tableClone.style.zIndex = '10000';
            tableClone.style.visibility = 'visible';
            tableClone.style.opacity = '1';
            tableClone.style.display = 'table';
            document.body.appendChild(tableClone);
            
            log('‚úÖ Copie ajout√©e au DOM, d√©but de la capture...', 'success');
            
            // ‚úÖ CAPTURE DE LA ZONE VISIBLE: Calculer les dimensions de la zone visible
            const visibleWidth = Math.min(viewportWidth - 40, table.scrollWidth); // -40px pour les marges
            const visibleHeight = Math.min(viewportHeight - 100, table.scrollHeight); // -100px pour les marges
            
            // ‚úÖ Calculer la largeur totale r√©elle du tableau
            const totalWidth = Array.from(tableClone.querySelectorAll('th')).reduce((total, th) => {
                return total + (th.offsetWidth || 200); // Largeur minimale de 200px par colonne
            }, 0);
            
            // ‚úÖ S'assurer que toutes les colonnes sont visibles
            tableClone.style.width = `${totalWidth}px`;
            tableClone.style.minWidth = `${totalWidth}px`;
            tableClone.style.maxWidth = `${totalWidth}px`;
            tableClone.style.tableLayout = 'fixed';
            
            // ‚úÖ CAPTURE DE LA ZONE VISIBLE: Masquer les lignes non visibles
            const allRows = tbodyClone.querySelectorAll('tr');
            allRows.forEach((row, index) => {
                // ‚úÖ Calculer la position r√©elle de chaque ligne
                const rowTop = index * 60; // Hauteur approximative par ligne (60px)
                const rowBottom = rowTop + 60;
                
                // ‚úÖ V√©rifier si la ligne est dans la zone visible actuelle
                const isVisible = (rowTop >= scrollTop - 100) && (rowBottom <= scrollTop + visibleHeight + 100);
                
                if (isVisible) {
                    row.style.display = 'table-row !important';
                    row.style.visibility = 'visible !important';
                    row.style.opacity = '1 !important';
                    row.style.height = 'auto !important';
                    row.style.minHeight = '50px !important';
                } else {
                    // ‚úÖ Masquer compl√®tement les lignes non visibles
                    row.style.display = 'none !important';
                    row.style.visibility = 'hidden !important';
                    row.style.opacity = '0 !important';
                    row.style.height = '0 !important';
                    row.style.overflow = 'hidden !important';
                }
            });
            
            // ‚úÖ CAPTURE DE LA ZONE VISIBLE: Positionner le tableau pour capturer la zone actuelle
            tableClone.style.position = 'absolute';
            tableClone.style.left = '0px';
            tableClone.style.top = '0px';
            tableClone.style.transform = `translate(-${scrollLeft}px, -${scrollTop}px)`;
            tableClone.style.height = 'auto';
            tableClone.style.overflow = 'visible';
            
            // ‚úÖ Capture de la copie corrig√©e
            html2canvas(tableClone, {
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#ffffff',
                scale: 2,
                scrollX: 0,
                scrollY: 0,
                width: visibleWidth,
                height: visibleHeight,
                logging: false,
                // ‚úÖ Options suppl√©mentaires pour garantir la capture
                ignoreElements: (element) => {
                    // Ignorer les √©l√©ments qui pourraient interf√©rer
                    return element === table || element.closest('#test-table') === table;
                },
                onclone: (clonedDoc) => {
                    // S'assurer que la copie est bien visible dans le document clon√©
                    const clonedTable = clonedDoc.querySelector('table');
                    if (clonedTable) {
                        clonedTable.style.visibility = 'visible';
                        clonedTable.style.opacity = '1';
                        clonedTable.style.display = 'table';
                        clonedTable.style.width = `${totalWidth}px`;
                        clonedTable.style.minWidth = `${totalWidth}px`;
                        clonedTable.style.maxWidth = `${totalWidth}px`;
                        clonedTable.style.tableLayout = 'fixed';
                        clonedTable.style.height = 'auto';
                        clonedTable.style.overflow = 'visible';
                        clonedTable.style.transform = `translate(-${scrollLeft}px, -${scrollTop}px)`;
                        
                        // ‚úÖ CAPTURE DE LA ZONE VISIBLE: Afficher seulement les lignes visibles
                        const clonedTbody = clonedDoc.querySelector('tbody');
                        if (clonedTbody) {
                            const clonedRows = clonedTbody.querySelectorAll('tr');
                            clonedRows.forEach((row, index) => {
                                // ‚úÖ Calculer si la ligne est dans la zone visible
                                const rowTop = index * 50; // Hauteur approximative par ligne
                                const rowBottom = rowTop + 50;
                                const isVisible = (rowTop < scrollTop + visibleHeight) && (rowBottom > scrollTop);
                                
                                if (isVisible) {
                                    row.style.display = 'table-row !important';
                                    row.style.visibility = 'visible !important';
                                    row.style.opacity = '1 !important';
                                } else {
                                    row.style.display = 'none !important';
                                }
                            });
                        }
                    }
                }
            }).then(canvas => { 
                log('‚úÖ Capture r√©ussie !', 'success');
                
                const link = document.createElement('a'); 
                link.href = canvas.toDataURL('image/png'); 
                link.download = 'Test_Tableau_Zone_Visible.png'; 
                link.click(); 
                
                log('üíæ Image t√©l√©charg√©e avec succ√®s', 'success');
                updateStatus('Capture r√©ussie - Image t√©l√©charg√©e de la zone visible');
                
                // ‚úÖ Nettoyer la copie temporaire
                document.body.removeChild(tableClone);
                log('üîÑ Copie temporaire nettoy√©e', 'info');
                
            }).catch(error => {
                log(`‚ùå Erreur lors de la capture: ${error.message}`, 'error');
                updateStatus('Erreur lors de la capture');
                
                // ‚úÖ Nettoyer m√™me en cas d'erreur
                if (document.body.contains(tableClone)) {
                    document.body.removeChild(tableClone);
                    log('üîÑ Copie temporaire nettoy√©e apr√®s erreur', 'warning');
                }
            });
        }
        
        // Initialisation
        log('‚úÖ Test de capture d\'√©cran initialis√© avec succ√®s', 'success');
        log('üéØ Objectif: V√©rifier que les en-t√™tes restent en haut lors de la capture', 'success');
        log('üí° D√©filez vers le bas puis testez la capture', 'info');
        
        // Afficher l'√©tat initial
        log('üìä √âtat initial:', 'info');
        log('   - Tableau avec 20 lignes configur√©es', 'info');
        log('   - En-t√™tes sticky configur√©s', 'info');
        log('   - Fonction de capture corrig√©e', 'info');
        log('   - Styles de capture ajout√©s', 'info');
        
        updateStatus('Pr√™t pour le test - D√©filez puis capturez');
    </script>
</body>
</html>
