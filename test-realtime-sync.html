<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Synchronisation Temps R√©el</title>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
        window.createClient = createClient;
    </script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; max-height: 300px; overflow-y: auto; }
        .status { padding: 10px; margin: 10px 0; border-radius: 3px; font-weight: bold; }
        .realtime-status { padding: 15px; margin: 15px 0; border-radius: 5px; font-weight: bold; text-align: center; }
        .realtime-active { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .realtime-inactive { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Test de la Synchronisation Temps R√©el</h1>
        <p class="info">Cette page teste la synchronisation temps r√©el entre appareils via Supabase.</p>
        
        <div class="realtime-status" id="realtime-status">
            <h3>üì° Statut de la Synchronisation Temps R√©el</h3>
            <p id="realtime-status-text">Initialisation...</p>
        </div>

        <div class="test-section">
            <h3>üîå Configuration Supabase</h3>
            <p><strong>URL:</strong> <span id="supabase-url">Chargement...</span></p>
            <p><strong>Statut:</strong> <span id="connection-status">Non connect√©</span></p>
        </div>

        <div class="test-section">
            <h3>üß™ Tests de Synchronisation</h3>
            <button onclick="testRealtimeConnection()" id="test-realtime-btn">üîå Tester la connexion temps r√©el</button>
            <button onclick="testDataModification()" id="test-modification-btn" disabled>‚úèÔ∏è Tester la modification de donn√©es</button>
            <button onclick="testRealtimeUpdate()" id="test-update-btn" disabled>üîÑ Tester la r√©ception temps r√©el</button>
            <div id="realtime-test-results"></div>
        </div>

        <div class="test-section">
            <h3>üìä Donn√©es du Tableau</h3>
            <button onclick="loadTableData()" id="load-data-btn" disabled>üì• Charger les donn√©es du tableau</button>
            <button onclick="insertTestRow()" id="insert-row-btn" disabled>‚ûï Ins√©rer une ligne de test</button>
            <div id="table-data-results"></div>
        </div>

        <div class="test-section">
            <h3>üìù Logs de Diagnostic</h3>
            <button onclick="clearLogs()">üóëÔ∏è Effacer les logs</button>
            <div id="diagnostic-logs"></div>
        </div>

        <div class="test-section">
            <h3>üìã Instructions de Test</h3>
            <ol>
                <li><strong>Ouvrez cette page sur deux appareils diff√©rents</strong></li>
                <li><strong>Appareil 1 :</strong> Cliquez sur "Tester la connexion temps r√©el"</li>
                <li><strong>Appareil 1 :</strong> Cliquez sur "Ins√©rer une ligne de test"</li>
                <li><strong>Appareil 2 :</strong> V√©rifiez que la nouvelle ligne appara√Æt automatiquement</li>
                <li><strong>Si la ligne n'appara√Æt pas automatiquement :</strong> Probl√®me de synchronisation temps r√©el</li>
            </ol>
        </div>
    </div>

    <script>
        // Configuration Supabase
        const supabaseConfig = { 
            supabaseUrl: 'https://fiecugxopjxzqfdnaqsu.supabase.co', 
            supabaseAnonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpZWN1Z3hvcGp4enFmZG5hcXN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDU2NTcsImV4cCI6MjA3MDA4MTY1N30.xd9Thasg4r8Nrwxx5r8Nrwxx5nFwyGB_ufPIvok4XB-78dilpsw'
        };

        let supabase;
        let realtimeSubscription = null;
        let isRealtimeActive = false;

        // Initialisation
        async function initSupabase() {
            try {
                log('üîÑ Initialisation du client Supabase...');
                
                if (typeof createClient === 'undefined') {
                    throw new Error('createClient n\'est pas d√©fini. V√©rifiez que le script Supabase est charg√©.');
                }
                
                supabase = createClient(supabaseConfig.supabaseUrl, supabaseConfig.supabaseAnonKey);
                
                document.getElementById('supabase-url').textContent = supabaseConfig.supabaseUrl;
                
                log('‚úÖ Client Supabase initialis√©');
                return true;
            } catch (error) {
                log('‚ùå Erreur lors de l\'initialisation: ' + error.message, 'error');
                return false;
            }
        }

        // Test de connexion temps r√©el
        async function testRealtimeConnection() {
            try {
                log('üîÑ Test de connexion temps r√©el...');
                
                // Tester d'abord la connexion de base
                const { data, error } = await supabase.from('staffTable').select('count').limit(1);
                if (error) throw error;
                
                log('‚úÖ Connexion de base r√©ussie');
                document.getElementById('connection-status').textContent = 'Connect√©';
                document.getElementById('connection-status').className = 'status success';
                
                // Configurer la synchronisation temps r√©el
                await setupRealtimeSubscription();
                
                // Activer les boutons suivants
                document.getElementById('test-modification-btn').disabled = false;
                document.getElementById('test-update-btn').disabled = false;
                document.getElementById('load-data-btn').disabled = false;
                document.getElementById('insert-row-btn').disabled = false;
                
            } catch (error) {
                log('‚ùå Erreur de connexion temps r√©el: ' + error.message, 'error');
                document.getElementById('realtime-test-results').innerHTML = '<div class="log error">‚ùå Erreur de connexion temps r√©el: ' + error.message + '</div>';
            }
        }

        // Configuration de la synchronisation temps r√©el
        async function setupRealtimeSubscription() {
            try {
                if (realtimeSubscription) {
                    log('üîÑ Nettoyage de l\'ancienne subscription temps r√©el...');
                    supabase.removeChannel(realtimeSubscription);
                }

                log('üîÑ Configuration de la synchronisation temps r√©el...');
                
                realtimeSubscription = supabase.channel('table-changes')
                    .on('postgres_changes', { 
                        event: 'INSERT', 
                        schema: 'public', 
                        table: 'staffTable' 
                    }, handleRealtimeUpdate)
                    .on('postgres_changes', { 
                        event: 'UPDATE', 
                        schema: 'public', 
                        table: 'staffTable' 
                    }, handleRealtimeUpdate)
                    .on('postgres_changes', { 
                        event: 'DELETE', 
                        schema: 'public', 
                        table: 'staffTable' 
                    }, handleRealtimeUpdate)
                    .subscribe(status => {
                        log('üì° Statut de la subscription temps r√©el: ' + status);
                        
                        if (status === 'SUBSCRIBED') {
                            log('‚úÖ Synchronisation temps r√©el activ√©e', 'success');
                            isRealtimeActive = true;
                            updateRealtimeStatus('‚úÖ Synchronisation temps r√©el ACTIVE', 'realtime-active');
                            document.getElementById('realtime-test-results').innerHTML = '<div class="log success">‚úÖ Synchronisation temps r√©el activ√©e</div>';
                        } else if (status === 'CHANNEL_ERROR') {
                            log('‚ùå Erreur de synchronisation temps r√©el', 'error');
                            isRealtimeActive = false;
                            updateRealtimeStatus('‚ùå Erreur de synchronisation temps r√©el', 'realtime-inactive');
                        } else if (status === 'CLOSED') {
                            log('‚ö†Ô∏è Synchronisation temps r√©el ferm√©e', 'warning');
                            isRealtimeActive = false;
                            updateRealtimeStatus('‚ö†Ô∏è Synchronisation temps r√©el ferm√©e', 'realtime-inactive');
                        }
                    });
                    
                log('‚úÖ Configuration temps r√©el termin√©e');
                
            } catch (error) {
                log('‚ùå Erreur de configuration temps r√©el: ' + error.message, 'error');
                throw error;
            }
        }

        // Gestion des mises √† jour temps r√©el
        function handleRealtimeUpdate(payload) {
            log('üîÑ Mise √† jour temps r√©el re√ßue: ' + JSON.stringify(payload), 'success');
            
            // Traiter la mise √† jour selon le type d'√©v√©nement
            switch (payload.eventType) {
                case 'INSERT':
                    log('‚ûï Nouvelle ligne ins√©r√©e via temps r√©el', 'success');
                    break;
                case 'UPDATE':
                    log('‚úèÔ∏è Ligne mise √† jour via temps r√©el', 'success');
                    break;
                case 'DELETE':
                    log('üóëÔ∏è Ligne supprim√©e via temps r√©el', 'success');
                    break;
            }

            // Simuler le rafra√Æchissement des donn√©es
            setTimeout(() => {
                log('üîÑ Rafra√Æchissement automatique des donn√©es...', 'info');
                loadTableData(); // Recharger les donn√©es pour montrer les changements
            }, 1000);
        }

        // Test de modification de donn√©es
        async function testDataModification() {
            try {
                log('üîÑ Test de modification de donn√©es...');
                
                // Ins√©rer une ligne de test
                const testData = {
                    'Date de saisie': new Date().toISOString().split('T')[0],
                    'PEC finale': 'Test temps r√©el',
                    'PEC initiale': 'Test',
                    'Nom_Pr√©nom': 'Test Synchronisation ' + Date.now(),
                    'DDN': '1990-01-01',
                    'Diagnostic_initial': 'Test de synchronisation temps r√©el',
                    'information complementaire': 'Ligne cr√©√©e pour tester la synchronisation',
                    'Numero_tel': '0123456789'
                };
                
                const { data, error } = await supabase
                    .from('staffTable')
                    .insert([testData])
                    .select();
                
                if (error) throw error;
                
                log('‚úÖ Ligne de test ins√©r√©e avec succ√®s', 'success');
                document.getElementById('realtime-test-results').innerHTML += '<div class="log success">‚úÖ Ligne de test ins√©r√©e avec succ√®s</div>';
                
                // Recharger les donn√©es
                await loadTableData();
                
            } catch (error) {
                log('‚ùå Erreur lors de l\'insertion: ' + error.message, 'error');
                document.getElementById('realtime-test-results').innerHTML += '<div class="log error">‚ùå Erreur lors de l\'insertion: ' + error.message + '</div>';
            }
        }

        // Test de r√©ception temps r√©el
        function testRealtimeUpdate() {
            log('üß™ Test de r√©ception temps r√©el...', 'info');
            document.getElementById('realtime-test-results').innerHTML += '<div class="log info">üß™ Test de r√©ception temps r√©el - V√©rifiez que les mises √† jour apparaissent automatiquement</div>';
        }

        // Charger les donn√©es du tableau
        async function loadTableData() {
            try {
                log('üîÑ Chargement des donn√©es du tableau...');
                
                const { data, error } = await supabase
                    .from('staffTable')
                    .select('*')
                    .order('No', { ascending: true })
                    .limit(10);
                
                if (error) throw error;
                
                log(`‚úÖ ${data.length} lignes charg√©es depuis Supabase`, 'success');
                
                let resultsHtml = `<div class="log success">‚úÖ ${data.length} lignes charg√©es depuis Supabase</div>`;
                
                if (data.length > 0) {
                    resultsHtml += '<div class="log">';
                    data.forEach((row, index) => {
                        resultsHtml += `<div><strong>${index + 1}.</strong> ${row['Nom_Pr√©nom'] || 'Sans nom'} - ${row['PEC finale'] || 'Sans PEC'}</div>`;
                    });
                    resultsHtml += '</div>';
                } else {
                    resultsHtml += '<div class="log warning">‚ö†Ô∏è Aucune donn√©e trouv√©e</div>';
                }
                
                document.getElementById('table-data-results').innerHTML = resultsHtml;
                
            } catch (error) {
                log('‚ùå Erreur lors du chargement: ' + error.message, 'error');
                document.getElementById('table-data-results').innerHTML = '<div class="log error">‚ùå Erreur lors du chargement: ' + error.message + '</div>';
            }
        }

        // Ins√©rer une ligne de test
        async function insertTestRow() {
            try {
                log('üîÑ Insertion d\'une ligne de test...');
                
                const testData = {
                    'Date de saisie': new Date().toISOString().split('T')[0],
                    'PEC finale': 'Test insertion',
                    'PEC initiale': 'Test',
                    'Nom_Pr√©nom': 'Test Insertion ' + Date.now(),
                    'DDN': '1990-01-01',
                    'Diagnostic_initial': 'Test d\'insertion manuel',
                    'information complementaire': 'Ligne cr√©√©e manuellement pour tester',
                    'Numero_tel': '0987654321'
                };
                
                const { data, error } = await supabase
                    .from('staffTable')
                    .insert([testData])
                    .select();
                
                if (error) throw error;
                
                log('‚úÖ Ligne de test ins√©r√©e manuellement', 'success');
                document.getElementById('table-data-results').innerHTML += '<div class="log success">‚úÖ Ligne de test ins√©r√©e manuellement</div>';
                
                // Recharger les donn√©es
                await loadTableData();
                
            } catch (error) {
                log('‚ùå Erreur lors de l\'insertion manuelle: ' + error.message, 'error');
                document.getElementById('table-data-results').innerHTML += '<div class="log error">‚ùå Erreur lors de l\'insertion manuelle: ' + error.message + '</div>';
            }
        }

        // Mettre √† jour le statut temps r√©el
        function updateRealtimeStatus(message, className) {
            const statusElement = document.getElementById('realtime-status');
            const statusText = document.getElementById('realtime-status-text');
            
            statusElement.className = `realtime-status ${className}`;
            statusText.textContent = message;
        }

        // Fonction utilitaire pour logger
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('diagnostic-logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log ${type}`;
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            
            console.log(`[${timestamp}] ${message}`);
        }

        // Effacer les logs
        function clearLogs() {
            document.getElementById('diagnostic-logs').innerHTML = '';
        }

        // Initialisation au chargement de la page
        window.addEventListener('load', async () => {
            log('üöÄ Page de test de synchronisation temps r√©el charg√©e');
            await initSupabase();
        });
    </script>
</body>
</html>
