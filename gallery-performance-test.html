<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gallery Performance Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f5f5f5;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .performance-stats {
            background: #f8f9fa;
            padding: 15px;
            margin: 20px 0;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }
        
        .test-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .test-image-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            background: white;
            transition: transform 0.2s ease;
        }
        
        .test-image-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .test-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #f0f0f0;
        }
        
        .test-image.lazy-loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .test-controls {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .test-btn {
            padding: 10px 20px;
            border: none;
            background: #007bff;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s ease;
        }
        
        .test-btn:hover {
            background: #0056b3;
        }
        
        .test-btn.secondary {
            background: #6c757d;
        }
        
        .test-btn.secondary:hover {
            background: #545b62;
        }
        
        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            text-align: center;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 14px;
            color: #666;
        }
        
        .log-output {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }
        
        .success { color: #48bb78; }
        .warning { color: #ed8936; }
        .error { color: #f56565; }
        .info { color: #63b3ed; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üöÄ Gallery Performance Optimization Test</h1>
        <p>This page tests the gallery performance optimizations with lazy loading, caching, and smooth transitions.</p>
        
        <div class="performance-stats">
            <h3>üìä Performance Monitoring</h3>
            <div class="performance-metrics" id="metrics-container">
                <div class="metric-card">
                    <div class="metric-value" id="images-loaded">0</div>
                    <div class="metric-label">Images Loaded</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="cache-size">0</div>
                    <div class="metric-label">Cache Size</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="load-time">0ms</div>
                    <div class="metric-label">Avg Load Time</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="memory-usage">0KB</div>
                    <div class="metric-label">Memory Usage</div>
                </div>
            </div>
        </div>
        
        <div class="test-controls">
            <button class="test-btn" onclick="generateTestImages()">üì∑ Generate Test Images</button>
            <button class="test-btn" onclick="clearImages()">üóëÔ∏è Clear Images</button>
            <button class="test-btn secondary" onclick="runPerformanceTest()">‚ö° Run Performance Test</button>
            <button class="test-btn secondary" onclick="showPerformanceStats()">üìà Show Stats</button>
            <button class="test-btn secondary" onclick="clearLog()">üßπ Clear Log</button>
        </div>
        
        <div class="test-gallery" id="test-gallery">
            <!-- Test images will be generated here -->
        </div>
        
        <div class="log-output" id="log-output">
            <div class="info">üîÑ Gallery Performance Test loaded. Click "Generate Test Images" to start testing.</div>
        </div>
    </div>

    <!-- Load the gallery optimization scripts -->
    <script src="gallery-optimizer.js"></script>
    <script src="smooth-image-viewer.js"></script>
    
    <script>
        // Test gallery performance
        let testGallery = null;
        let testOptimizer = null;
        let testViewer = null;
        let performanceMetrics = {
            imagesLoaded: 0,
            totalLoadTime: 0,
            memoryUsage: 0,
            cacheHits: 0,
            cacheMisses: 0
        };

        // Logging utility
        function log(message, type = 'info') {
            const logOutput = document.getElementById('log-output');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'success' ? 'success' : 
                              type === 'warning' ? 'warning' : 
                              type === 'error' ? 'error' : 'info';
            
            const logEntry = document.createElement('div');
            logEntry.className = colorClass;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            logOutput.appendChild(logEntry);
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log-output').innerHTML = '';
        }

        // Create mock gallery instance for testing
        function createMockGallery() {
            return {
                images: [],
                currentImageIndex: 0,
                isInitialized: true,
                patientNames: {},
                
                renderGallery: function() {
                    log('üîÑ Rendering gallery with optimizations', 'info');
                },
                
                loadImages: function() {
                    log('üì• Loading images', 'info');
                    return Promise.resolve();
                }
            };
        }

        // Generate test images with various sizes
        function generateTestImages() {
            const gallery = document.getElementById('test-gallery');
            const numberOfImages = 50; // Test with 50 images
            
            log(`üñºÔ∏è Generating ${numberOfImages} test images...`, 'info');
            
            gallery.innerHTML = '';
            performanceMetrics.imagesLoaded = 0;
            updateMetrics();
            
            // Create mock gallery if not exists
            if (!testGallery) {
                testGallery = createMockGallery();
            }
            
            testGallery.images = [];
            
            for (let i = 0; i < numberOfImages; i++) {
                // Use different image services for variety
                const services = [
                    'https://picsum.photos',
                    'https://source.unsplash.com',
                    'https://images.unsplash.com'
                ];
                
                const service = services[Math.floor(Math.random() * services.length)];
                const width = 300 + (Math.random() * 200); // 300-500px width
                const height = 200 + (Math.random() * 100); // 200-300px height
                
                let imageUrl;
                if (service.includes('picsum')) {
                    imageUrl = `${service}/${Math.floor(width)}/${Math.floor(height)}?random=${i}`;
                } else if (service.includes('unsplash')) {
                    imageUrl = `https://source.unsplash.com/${Math.floor(width)}x${Math.floor(height)}/?sig=${i}`;
                }
                
                // Create image card
                const card = document.createElement('div');
                card.className = 'test-image-card';
                card.innerHTML = `
                    <img class="test-image lazy-loading" 
                         data-src="${imageUrl}" 
                         alt="Test Image ${i + 1}"
                         data-index="${i}">
                `;
                
                gallery.appendChild(card);
                
                // Add to mock gallery
                testGallery.images.push({
                    name: `test-image-${i}.jpg`,
                    url: imageUrl,
                    size: Math.floor(Math.random() * 500000) + 100000, // 100KB-600KB
                    created_at: new Date().toISOString()
                });
            }
            
            log(`‚úÖ Generated ${numberOfImages} test images`, 'success');
            
            // Initialize optimizer if available
            if (window.GalleryOptimizer && !testOptimizer) {
                testOptimizer = new window.GalleryOptimizer(testGallery);
                log('üöÄ Gallery Optimizer initialized for testing', 'success');
                
                // Apply optimizations to test images
                setTimeout(() => {
                    testOptimizer.optimizeExistingImages();
                    log('‚ö° Applied optimizations to test images', 'success');
                }, 100);
            }
            
            // Initialize smooth viewer if available
            if (window.SmoothImageViewer && !testViewer) {
                testViewer = new window.SmoothImageViewer(testGallery);
                log('üì± Smooth Image Viewer initialized for testing', 'success');
            }
            
            // Monitor image loading
            monitorImageLoading();
        }

        function monitorImageLoading() {
            const images = document.querySelectorAll('.test-image');
            let loadedCount = 0;
            let totalLoadTime = 0;
            
            images.forEach((img, index) => {
                const startTime = performance.now();
                
                img.addEventListener('load', () => {
                    const loadTime = performance.now() - startTime;
                    loadedCount++;
                    totalLoadTime += loadTime;
                    
                    performanceMetrics.imagesLoaded = loadedCount;
                    performanceMetrics.totalLoadTime = totalLoadTime / loadedCount;
                    
                    img.classList.remove('lazy-loading');
                    
                    if (loadedCount % 5 === 0) {
                        log(`üìà Loaded ${loadedCount} images, avg time: ${(totalLoadTime / loadedCount).toFixed(2)}ms`, 'info');
                    }
                    
                    updateMetrics();
                });
                
                img.addEventListener('error', () => {
                    log(`‚ùå Failed to load image ${index + 1}`, 'error');
                    img.classList.remove('lazy-loading');
                });
            });
        }

        function clearImages() {
            document.getElementById('test-gallery').innerHTML = '';
            performanceMetrics.imagesLoaded = 0;
            performanceMetrics.totalLoadTime = 0;
            updateMetrics();
            
            log('üóëÔ∏è Cleared all test images', 'info');
        }

        function runPerformanceTest() {
            log('üß™ Running performance test...', 'info');
            
            const startTime = performance.now();
            
            // Test lazy loading performance
            const images = document.querySelectorAll('.test-image');
            let visibleImages = 0;
            let lazyImages = 0;
            
            images.forEach(img => {
                const rect = img.getBoundingClientRect();
                if (rect.top < window.innerHeight && rect.bottom > 0) {
                    visibleImages++;
                }
                if (img.classList.contains('lazy-loading')) {
                    lazyImages++;
                }
            });
            
            const testDuration = performance.now() - startTime;
            
            log(`üìä Performance Test Results:`, 'success');
            log(`   ‚Ä¢ Total images: ${images.length}`, 'info');
            log(`   ‚Ä¢ Visible images: ${visibleImages}`, 'info');
            log(`   ‚Ä¢ Lazy loading images: ${lazyImages}`, 'info');
            log(`   ‚Ä¢ Test duration: ${testDuration.toFixed(2)}ms`, 'info');
            
            // Test optimizer stats
            if (testOptimizer) {
                const optimizerStats = testOptimizer.getPerformanceStats();
                log(`‚ö° Optimizer Stats:`, 'success');
                log(`   ‚Ä¢ Cache size: ${optimizerStats.cacheSize}`, 'info');
                log(`   ‚Ä¢ Loading queue: ${optimizerStats.loadingQueueSize}`, 'info');
                log(`   ‚Ä¢ Active loads: ${optimizerStats.activeLoads}`, 'info');
                log(`   ‚Ä¢ WebP support: ${optimizerStats.webPSupport ? 'Yes' : 'No'}`, 'info');
            }
            
            // Test viewer stats
            if (testViewer) {
                const viewerStats = testViewer.getPerformanceStats();
                log(`üì± Viewer Stats:`, 'success');
                log(`   ‚Ä¢ Preloaded images: ${viewerStats.preloadedImagesCount}`, 'info');
                log(`   ‚Ä¢ Touch support: ${viewerStats.touchSupport ? 'Yes' : 'No'}`, 'info');
            }
        }

        function showPerformanceStats() {
            if (window.debugGalleryPerformance) {
                const stats = window.debugGalleryPerformance();
                log('üìà Full Performance Stats:', 'success');
                console.table(stats);
            } else {
                log('‚ö†Ô∏è Performance debugging not available', 'warning');
            }
        }

        function updateMetrics() {
            document.getElementById('images-loaded').textContent = performanceMetrics.imagesLoaded;
            
            if (testOptimizer) {
                const stats = testOptimizer.getPerformanceStats();
                document.getElementById('cache-size').textContent = stats.cacheSize || 0;
            }
            
            document.getElementById('load-time').textContent = 
                performanceMetrics.totalLoadTime ? 
                `${performanceMetrics.totalLoadTime.toFixed(0)}ms` : '0ms';
            
            // Estimate memory usage (rough calculation)
            const estimatedMemory = performanceMetrics.imagesLoaded * 150; // ~150KB per image
            document.getElementById('memory-usage').textContent = 
                estimatedMemory > 1024 ? 
                `${(estimatedMemory / 1024).toFixed(1)}MB` : 
                `${estimatedMemory}KB`;
        }

        // Auto-update metrics every 2 seconds
        setInterval(updateMetrics, 2000);

        // Initialize test environment
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Gallery Performance Test initialized', 'success');
            log('üí° Click "Generate Test Images" to start testing the optimizations', 'info');
            
            updateMetrics();
        });

        // Add click handlers for test images to open viewer
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('test-image') && testViewer) {
                const index = parseInt(e.target.dataset.index);
                testViewer.open(index);
                log(`üñºÔ∏è Opened image ${index + 1} in smooth viewer`, 'info');
            }
        });
    </script>
</body>
</html>