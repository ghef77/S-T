<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Sauvegarde au Changement de Focus</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-cell { 
            border: 2px solid #007bff; 
            padding: 15px; 
            margin: 20px; 
            min-height: 60px;
            background: #f8f9fa;
            font-size: 16px;
        }
        .log { 
            background: #f8f9fa; 
            padding: 15px; 
            margin: 20px; 
            border-radius: 8px;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }
        .success { color: #28a745; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .info { color: #17a2b8; font-weight: bold; }
        .saving { color: #6f42c1; font-weight: bold; }
        .focus-restored {
            background-color: #d4edda !important;
            border: 3px solid #28a745 !important;
            box-shadow: 0 0 15px rgba(40, 167, 69, 0.4);
            animation: focusRestored 2s ease-in-out;
        }
        @keyframes focusRestored {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        button { 
            padding: 12px 20px; 
            margin: 8px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .instructions {
            background: #e3f2fd;
            padding: 15px;
            margin: 20px;
            border-radius: 8px;
            border-left: 4px solid #2196f3;
        }
    </style>
</head>
<body>
    <h1>üß™ Test Sauvegarde au Changement de Focus</h1>
    
    <div class="instructions">
        <h3>üìã Instructions de Test</h3>
        <p><strong>Nouvelle logique :</strong> La sauvegarde se d√©clenche maintenant <strong>seulement quand vous changez de focus</strong>, pas pendant que vous tapez.</p>
        <ol>
            <li>Cliquez dans une cellule et tapez du texte</li>
            <li>Cliquez dans une autre cellule (changement de focus)</li>
            <li>Observez que la sauvegarde se d√©clenche au changement de focus</li>
            <li>V√©rifiez que le curseur est restaur√© si vous revenez sur la premi√®re cellule</li>
        </ol>
    </div>
    
    <div class="test-cell" contenteditable="true" data-original-value="Cellule 1 - Cliquez et tapez ici">
        Cellule 1 - Cliquez et tapez ici
    </div>
    
    <div class="test-cell" contenteditable="true" data-original-value="Cellule 2 - Cliquez ici pour changer de focus">
        Cellule 2 - Cliquez ici pour changer de focus
    </div>
    
    <div class="test-cell" contenteditable="true" data-original-value="Cellule 3 - Test de navigation">
        Cellule 3 - Test de navigation
    </div>
    
    <div style="margin: 20px;">
        <button onclick="testCycleComplet()" class="btn-primary">üöÄ Test Cycle Complet</button>
        <button onclick="testNavigation()" class="btn-success">üß≠ Test Navigation</button>
        <button onclick="clearLog()" class="btn-warning">üóëÔ∏è Effacer Log</button>
    </div>
    
    <div class="log" id="log">
        <div class="info">üöÄ Test de sauvegarde au changement de focus initialis√©</div>
    </div>
    
    <script>
        let logCount = 0;
        let isDirty = false;
        let isTyping = false;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            logCount++;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '<div class="info">üöÄ Test de sauvegarde au changement de focus initialis√©</div>';
            logCount = 0;
        }
        
        // Simulation de markEdited (sans sauvegarde imm√©diate)
        function markEdited() {
            log('üìù markEdited appel√© - Cellule marqu√©e comme modifi√©e', 'info');
            log('‚è≥ Sauvegarde en attente - se d√©clenchera au changement de focus', 'warning');
            
            isDirty = true;
            isTyping = true;
            
            // Timer de frappe
            setTimeout(() => { isTyping = false; }, 1200);
        }
        
        // Simulation de syncToMaster
        async function syncToMaster(isManualSave = false) {
            log(`üîÑ syncToMaster appel√© (isManualSave: ${isManualSave})`, 'saving');
            log('üíæ Sauvegarde en cours...', 'saving');
            
            // Simuler la sauvegarde
            await new Promise(resolve => setTimeout(resolve, 500));
            
            log('‚úÖ Sauvegarde r√©ussie !', 'success');
            return true;
        }
        
        // Simulation de getCursorPosition
        function getCursorPosition(element) {
            if (!element || element.contentEditable !== 'true') {
                return 0;
            }
            
            try {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    if (element.contains(range.startContainer)) {
                        const preCaretRange = range.cloneRange();
                        preCaretRange.selectNodeContents(element);
                        preCaretRange.setEnd(range.endContainer, range.endOffset);
                        return preCaretRange.toString().length;
                    }
                }
            } catch (error) {
                log(`‚ùå Erreur getCursorPosition: ${error.message}`, 'error');
            }
            return 0;
        }
        
        // Simulation de restoreFocusAfterAutosave
        function restoreFocusAfterAutosave(focusState) {
            if (!focusState || !focusState.element) {
                log('‚ö†Ô∏è focusState invalide', 'warning');
                return;
            }

            try {
                log('üîÑ Restauration du focus...', 'info');
                
                // Restaurer le focus
                focusState.element.focus();
                log('‚úÖ Focus restaur√©', 'success');
                
                // Restaurer la position du curseur
                if (focusState.position !== null && focusState.position !== undefined) {
                    try {
                        const range = document.createRange();
                        const selection = window.getSelection();
                        
                        if (focusState.element.firstChild) {
                            const safeOffset = Math.min(focusState.position, focusState.element.textContent.length);
                            range.setStart(focusState.element.firstChild, safeOffset);
                            range.collapse(true);
                            
                            selection.removeAllRanges();
                            selection.addRange(range);
                            
                            log(`‚úÖ Curseur restaur√© √† la position ${safeOffset}`, 'success');
                        }
                    } catch (error) {
                        log(`‚ö†Ô∏è Erreur restauration curseur: ${error.message}`, 'warning');
                    }
                }
                
                // Feedback visuel
                focusState.element.classList.add('focus-restored');
                setTimeout(() => {
                    focusState.element.classList.remove('focus-restored');
                }, 2000);
                
                log('‚úÖ Restauration termin√©e avec succ√®s', 'success');
                
            } catch (error) {
                log(`‚ùå Erreur restauration: ${error.message}`, 'error');
            }
        }
        
        // Gestion des √©v√©nements blur pour chaque cellule
        function setupBlurEvents() {
            const cells = document.querySelectorAll('.test-cell');
            
            cells.forEach((cell, index) => {
                let initialValue = cell.dataset.originalValue;
                
                // √âv√©nement blur (changement de focus)
                cell.addEventListener('blur', () => {
                    const currentValue = cell.textContent;
                    const normalizedCurrent = currentValue.trim();
                    const normalizedInitial = initialValue.trim();
                    
                    if (normalizedCurrent !== normalizedInitial) {
                        log(`üíæ Changement de focus d√©tect√© sur Cellule ${index + 1}`, 'saving');
                        
                        // Capturer l'√©tat du focus
                        const focusState = {
                            element: cell,
                            position: getCursorPosition(cell)
                        };
                        
                        log(`üìù Focus captur√©: position ${focusState.position}`, 'info');
                        
                        // Sauvegarder au changement de focus
                        syncToMaster(false).then(() => {
                            log(`‚úÖ Sauvegarde au changement de focus r√©ussie pour Cellule ${index + 1}`, 'success');
                            
                            // Mettre √† jour la valeur initiale
                            initialValue = currentValue;
                            cell.dataset.originalValue = currentValue;
                            
                            // Restaurer le focus si c'est la m√™me cellule
                            if (document.activeElement === focusState.element) {
                                log('üîÑ Restauration du focus apr√®s sauvegarde...', 'info');
                                setTimeout(() => {
                                    restoreFocusAfterAutosave(focusState);
                                }, 100);
                            }
                        }).catch((error) => {
                            log(`‚ùå Erreur sauvegarde: ${error.message}`, 'error');
                        });
                    } else {
                        log(`üö´ Blur ignor√© sur Cellule ${index + 1} - aucun changement`, 'warning');
                    }
                });
                
                // √âv√©nement input (pendant la frappe)
                cell.addEventListener('input', () => {
                    log(`üìù Input d√©tect√© sur Cellule ${index + 1}`, 'info');
                    markEdited();
                });
            });
        }
        
        // Test du cycle complet
        function testCycleComplet() {
            log('üöÄ Test du cycle complet...', 'info');
            log('üìã Instructions:', 'info');
            log('   1. Cliquez dans la Cellule 1', 'info');
            log('   2. Tapez du texte (ex: "Test modification")', 'info');
            log('   3. Cliquez dans la Cellule 2 (changement de focus)', 'info');
            log('   4. Observez la sauvegarde se d√©clencher', 'info');
        }
        
        // Test de navigation
        function testNavigation() {
            log('üß≠ Test de navigation...', 'info');
            log('üìã Instructions:', 'info');
            log('   1. Naviguez entre les cellules avec Tab ou clics', 'info');
            log('   2. Modifiez le contenu de plusieurs cellules', 'info');
            log('   3. V√©rifiez que la sauvegarde se d√©clenche √† chaque changement de focus', 'info');
        }
        
        // Initialisation
        log('‚úÖ Test initialis√© avec succ√®s', 'success');
        log('üéØ Nouvelle logique: Sauvegarde au changement de focus uniquement', 'success');
        
        // Configurer les √©v√©nements
        setupBlurEvents();
        
        // Afficher l'√©tat initial
        log('üìä √âtat initial:', 'info');
        log('   - isDirty: false', 'info');
        log('   - isTyping: false', 'info');
        log('   - 3 cellules de test configur√©es', 'info');
    </script>
</body>
</html>
