<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Snapshots - Apr√®s Configuration</title>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
        window.createClient = createClient;
    </script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; max-height: 300px; overflow-y: auto; }
        .status { padding: 10px; margin: 10px 0; border-radius: 3px; font-weight: bold; }
        .step { margin: 10px 0; padding: 10px; background: #f8f9fa; border-left: 4px solid #007bff; }
        .step h4 { margin: 0 0 10px 0; color: #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Test des Snapshots - Apr√®s Configuration</h1>
        <p class="info">Cette page teste le syst√®me de snapshots apr√®s avoir ex√©cut√© le script SQL de configuration.</p>
        
        <div class="step">
            <h4>üìã √âtapes de Configuration</h4>
            <ol>
                <li>Ex√©cutez le script SQL <code>setup-snapshots-fixed.sql</code> dans l'√©diteur SQL de Supabase</li>
                <li>Cr√©ez le bucket <code>table-snapshots</code> dans le stockage Supabase</li>
                <li>Testez la connexion et les fonctionnalit√©s ci-dessous</li>
            </ol>
        </div>

        <div class="test-section info">
            <h3>‚öôÔ∏è Configuration</h3>
            <p><strong>URL Supabase:</strong> <span id="supabase-url">Chargement...</span></p>
            <p><strong>Cl√© anonyme:</strong> <span id="supabase-key">Chargement...</span></p>
            <p><strong>Statut:</strong> <span id="connection-status">Non connect√©</span></p>
        </div>

        <div class="test-section">
            <h3>üîå Tests de Base</h3>
            <button onclick="testBasicConnection()" id="test-connection-btn">üîå Tester la connexion</button>
            <button onclick="testTableAccess()" id="test-table-btn" disabled>üìä Tester l'acc√®s aux tables</button>
            <div id="basic-test-results"></div>
        </div>

        <div class="test-section">
            <h3>üì∏ Tests des Snapshots</h3>
            <button onclick="testSnapshotTable()" id="test-snapshots-btn" disabled>üì∏ Tester la table des snapshots</button>
            <button onclick="createTestSnapshot()" id="create-snapshot-btn" disabled>‚ûï Cr√©er un snapshot de test</button>
            <button onclick="loadAllSnapshots()" id="load-snapshots-btn" disabled>üì• Charger tous les snapshots</button>
            <div id="snapshots-test-results"></div>
        </div>

        <div class="test-section">
            <h3>üóÑÔ∏è Tests du Stockage</h3>
            <button onclick="testStorageAccess()" id="test-storage-btn" disabled>üóÑÔ∏è Tester l'acc√®s au stockage</button>
            <button onclick="uploadTestFile()" id="upload-file-btn" disabled>üì§ T√©l√©charger un fichier de test</button>
            <div id="storage-test-results"></div>
        </div>

        <div class="test-section">
            <h3>üéØ Test Complet du Syst√®me</h3>
            <button onclick="runFullTest()" id="full-test-btn" disabled>üöÄ Test complet</button>
            <div id="full-test-results"></div>
        </div>

        <div class="test-section">
            <h3>üìù Logs de Diagnostic</h3>
            <button onclick="clearLogs()">üóëÔ∏è Effacer les logs</button>
            <div id="diagnostic-logs"></div>
        </div>
    </div>

    <script>
        // Configuration Supabase
        const supabaseConfig = { 
            supabaseUrl: 'https://fiecugxopjxzqfdnaqsu.supabase.co', 
            supabaseAnonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpZWN1Z3hvcGp4enFmZG5hcXN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDU2NTcsImV4cCI6MjA3MDA4MTY1N30.xd9Thasg4r8Nrwxx5nFwyGB_ufPIvok4XB-78dilpsw'
        };

        let supabase;
        let isConnected = false;

        // Initialisation
        async function initSupabase() {
            try {
                log('üîÑ Initialisation du client Supabase...');
                
                if (typeof createClient === 'undefined') {
                    throw new Error('createClient n\'est pas d√©fini. V√©rifiez que le script Supabase est charg√©.');
                }
                
                supabase = createClient(supabaseConfig.supabaseUrl, supabaseConfig.supabaseAnonKey);
                
                document.getElementById('supabase-url').textContent = supabaseConfig.supabaseUrl;
                document.getElementById('supabase-key').textContent = supabaseConfig.supabaseAnonKey.substring(0, 20) + '...';
                
                log('‚úÖ Client Supabase initialis√©');
                return true;
            } catch (error) {
                log('‚ùå Erreur lors de l\'initialisation: ' + error.message, 'error');
                return false;
            }
        }

        // Test de connexion de base
        async function testBasicConnection() {
            try {
                log('üîÑ Test de connexion de base...');
                const { data, error } = await supabase.from('staffTable').select('count').limit(1);
                
                if (error) {
                    throw error;
                }
                
                log('‚úÖ Connexion de base r√©ussie', 'success');
                document.getElementById('connection-status').textContent = 'Connect√©';
                document.getElementById('connection-status').className = 'status success';
                document.getElementById('basic-test-results').innerHTML = '<div class="log success">‚úÖ Connexion de base r√©ussie</div>';
                
                // Activer les boutons suivants
                document.getElementById('test-table-btn').disabled = false;
                isConnected = true;
                
            } catch (error) {
                log('‚ùå Erreur de connexion: ' + error.message, 'error');
                document.getElementById('basic-test-results').innerHTML = '<div class="log error">‚ùå Erreur de connexion: ' + error.message + '</div>';
            }
        }

        // Test d'acc√®s aux tables
        async function testTableAccess() {
            try {
                log('üîÑ Test d\'acc√®s aux tables...');
                
                // Test staffTable
                const { data: staffData, error: staffError } = await supabase.from('staffTable').select('*').limit(5);
                if (staffError) throw new Error('staffTable: ' + staffError.message);
                
                // Test table_snapshots_index
                const { data: snapshotsData, error: snapshotsError } = await supabase.from('table_snapshots_index').select('*');
                if (snapshotsError) throw new Error('table_snapshots_index: ' + snapshotsError.message);
                
                log(`‚úÖ Acc√®s aux tables r√©ussi - staffTable: ${staffData.length} lignes, snapshots: ${snapshotsData.length}`, 'success');
                document.getElementById('basic-test-results').innerHTML += '<div class="log success">‚úÖ Acc√®s aux tables r√©ussi</div>';
                
                // Activer les boutons suivants
                document.getElementById('test-snapshots-btn').disabled = false;
                document.getElementById('create-snapshot-btn').disabled = false;
                document.getElementById('load-snapshots-btn').disabled = false;
                
            } catch (error) {
                log('‚ùå Erreur d\'acc√®s aux tables: ' + error.message, 'error');
                document.getElementById('basic-test-results').innerHTML += '<div class="log error">‚ùå Erreur d\'acc√®s aux tables: ' + error.message + '</div>';
            }
        }

        // Test de la table des snapshots
        async function testSnapshotTable() {
            try {
                log('üîÑ Test de la table des snapshots...');
                const { data, error } = await supabase.from('table_snapshots_index').select('*');
                
                if (error) {
                    throw error;
                }
                
                log(`‚úÖ Table des snapshots accessible - ${data.length} snapshots trouv√©s`, 'success');
                
                let resultsHtml = `<div class="log success">‚úÖ Table des snapshots accessible - ${data.length} snapshots trouv√©s</div>`;
                
                if (data.length > 0) {
                    resultsHtml += '<div class="log">';
                    data.forEach((snapshot, index) => {
                        const date = new Date(snapshot.snapshot_date);
                        const formattedDate = date.toLocaleDateString('fr-FR');
                        resultsHtml += `<div><strong>${index + 1}.</strong> Date: ${formattedDate}, Lignes: ${snapshot.row_count}, Taille: ${snapshot.file_size_bytes} bytes</div>`;
                    });
                    resultsHtml += '</div>';
                } else {
                    resultsHtml += '<div class="log warning">‚ö†Ô∏è Aucun snapshot dans la base de donn√©es</div>';
                }
                
                document.getElementById('snapshots-test-results').innerHTML = resultsHtml;
                
            } catch (error) {
                log('‚ùå Erreur d\'acc√®s √† la table des snapshots: ' + error.message, 'error');
                document.getElementById('snapshots-test-results').innerHTML = '<div class="log error">‚ùå Erreur d\'acc√®s √† la table des snapshots: ' + error.message + '</div>';
            }
        }

        // Cr√©er un snapshot de test
        async function createTestSnapshot() {
            try {
                log('üîÑ Cr√©ation d\'un snapshot de test...');
                
                const today = new Date();
                const dateString = today.toISOString().split('T')[0];
                const timestamp = today.getTime();
                
                const snapshotData = {
                    snapshot_date: dateString,
                    object_path: `snapshots/staff_table_${dateString}_${timestamp}.json`,
                    row_count: 0,
                    file_size_bytes: 0,
                    metadata: {
                        table: 'staffTable',
                        version: '1.0.0',
                        description: 'Snapshot de test cr√©√© automatiquement',
                        created_at: new Date().toISOString()
                    }
                };
                
                const { data, error } = await supabase
                    .from('table_snapshots_index')
                    .insert([snapshotData])
                    .select();
                
                if (error) {
                    throw error;
                }
                
                log('‚úÖ Snapshot de test cr√©√© avec succ√®s', 'success');
                document.getElementById('snapshots-test-results').innerHTML += '<div class="log success">‚úÖ Snapshot de test cr√©√© avec succ√®s</div>';
                
                // Recharger les snapshots
                await loadAllSnapshots();
                
            } catch (error) {
                log('‚ùå Erreur lors de la cr√©ation du snapshot: ' + error.message, 'error');
                document.getElementById('snapshots-test-results').innerHTML += '<div class="log error">‚ùå Erreur lors de la cr√©ation du snapshot: ' + error.message + '</div>';
            }
        }

        // Charger tous les snapshots
        async function loadAllSnapshots() {
            try {
                log('üîÑ Chargement de tous les snapshots...');
                const { data, error } = await supabase
                    .from('table_snapshots_index')
                    .select('*')
                    .order('snapshot_date', { ascending: false });
                
                if (error) {
                    throw error;
                }
                
                log(`‚úÖ ${data.length} snapshots charg√©s`, 'success');
                
                let resultsHtml = `<div class="log success">‚úÖ ${data.length} snapshots charg√©s</div>`;
                
                if (data.length > 0) {
                    resultsHtml += '<div class="log">';
                    data.forEach((snapshot, index) => {
                        const date = new Date(snapshot.snapshot_date);
                        const formattedDate = date.toLocaleDateString('fr-FR');
                        resultsHtml += `<div><strong>${index + 1}.</strong> Date: ${formattedDate}, Lignes: ${snapshot.row_count}, Taille: ${(snapshot.file_size_bytes / 1024).toFixed(2)} KB</div>`;
                    });
                    resultsHtml += '</div>';
                } else {
                    resultsHtml += '<div class="log warning">‚ö†Ô∏è Aucun snapshot trouv√©</div>';
                }
                
                document.getElementById('snapshots-test-results').innerHTML = resultsHtml;
                
            } catch (error) {
                log('‚ùå Erreur lors du chargement des snapshots: ' + error.message, 'error');
                document.getElementById('snapshots-test-results').innerHTML = '<div class="log error">‚ùå Erreur lors du chargement des snapshots: ' + error.message + '</div>';
            }
        }

        // Test d'acc√®s au stockage
        async function testStorageAccess() {
            try {
                log('üîÑ Test d\'acc√®s au stockage...');
                const { data, error } = await supabase.storage.from('table-snapshots').list('', { limit: 10 });
                
                if (error) {
                    throw error;
                }
                
                log(`‚úÖ Stockage accessible - ${data.length} fichiers trouv√©s`, 'success');
                
                let resultsHtml = `<div class="log success">‚úÖ Stockage accessible - ${data.length} fichiers trouv√©s</div>`;
                
                if (data.length > 0) {
                    resultsHtml += '<div class="log">';
                    data.forEach((file, index) => {
                        resultsHtml += `<div><strong>${index + 1}.</strong> ${file.name}</div>`;
                    });
                    resultsHtml += '</div>';
                } else {
                    resultsHtml += '<div class="log warning">‚ö†Ô∏è Aucun fichier dans le bucket table-snapshots</div>';
                }
                
                document.getElementById('storage-test-results').innerHTML = resultsHtml;
                document.getElementById('upload-file-btn').disabled = false;
                
            } catch (error) {
                log('‚ùå Erreur d\'acc√®s au stockage: ' + error.message, 'error');
                document.getElementById('storage-test-results').innerHTML = '<div class="log error">‚ùå Erreur d\'acc√®s au stockage: ' + error.message + '</div>';
            }
        }

        // T√©l√©charger un fichier de test
        async function uploadTestFile() {
            try {
                log('üîÑ T√©l√©chargement d\'un fichier de test...');
                
                const testContent = JSON.stringify({
                    test: true,
                    timestamp: new Date().toISOString(),
                    message: 'Fichier de test pour v√©rifier le stockage'
                }, null, 2);
                
                const fileName = `test_${Date.now()}.json`;
                
                const { data, error } = await supabase.storage
                    .from('table-snapshots')
                    .upload(fileName, testContent, {
                        contentType: 'application/json'
                    });
                
                if (error) {
                    throw error;
                }
                
                log('‚úÖ Fichier de test t√©l√©charg√© avec succ√®s', 'success');
                document.getElementById('storage-test-results').innerHTML += '<div class="log success">‚úÖ Fichier de test t√©l√©charg√© avec succ√®s</div>';
                
                // Recharger la liste des fichiers
                await testStorageAccess();
                
            } catch (error) {
                log('‚ùå Erreur lors du t√©l√©chargement: ' + error.message, 'error');
                document.getElementById('storage-test-results').innerHTML += '<div class="log error">‚ùå Erreur lors du t√©l√©chargement: ' + error.message + '</div>';
            }
        }

        // Test complet du syst√®me
        async function runFullTest() {
            try {
                log('üöÄ D√©but du test complet du syst√®me...');
                
                // Activer tous les boutons
                document.getElementById('full-test-btn').disabled = true;
                
                // Ex√©cuter tous les tests
                await testBasicConnection();
                if (!isConnected) return;
                
                await testTableAccess();
                await testSnapshotTable();
                await testStorageAccess();
                await loadAllSnapshots();
                
                log('‚úÖ Test complet termin√© avec succ√®s', 'success');
                document.getElementById('full-test-results').innerHTML = '<div class="log success">‚úÖ Test complet termin√© avec succ√®s</div>';
                
            } catch (error) {
                log('‚ùå Erreur lors du test complet: ' + error.message, 'error');
                document.getElementById('full-test-results').innerHTML = '<div class="log error">‚ùå Erreur lors du test complet: ' + error.message + '</div>';
            } finally {
                document.getElementById('full-test-btn').disabled = false;
            }
        }

        // Fonction utilitaire pour logger
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('diagnostic-logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log ${type}`;
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            
            console.log(`[${timestamp}] ${message}`);
        }

        // Effacer les logs
        function clearLogs() {
            document.getElementById('diagnostic-logs').innerHTML = '';
        }

        // Initialisation au chargement de la page
        window.addEventListener('load', async () => {
            log('üöÄ Page de test des snapshots charg√©e');
            await initSupabase();
        });
    </script>
</body>
</html>
