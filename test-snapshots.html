<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Snapshots - Diagnostic</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; }
    </style>
</head>
<body>
    <h1>üîç Diagnostic des Snapshots Supabase</h1>
    
    <div class="test-section info">
        <h3>Configuration</h3>
        <p><strong>URL:</strong> <span id="supabase-url">Chargement...</span></p>
        <p><strong>Cl√© anonyme:</strong> <span id="supabase-key">Chargement...</span></p>
    </div>

    <div class="test-section">
        <h3>Tests de Connexion</h3>
        <button onclick="testConnection()">üîå Tester la connexion</button>
        <button onclick="testTableAccess()">üìä Tester l'acc√®s √† la table</button>
        <button onclick="testSnapshotTable()">üì∏ Tester la table des snapshots</button>
        <button onclick="testStorageAccess()">üóÑÔ∏è Tester l'acc√®s au stockage</button>
        <div id="connection-results"></div>
    </div>

    <div class="test-section">
        <h3>Donn√©es des Snapshots</h3>
        <button onclick="loadSnapshots()">üì• Charger les snapshots</button>
        <button onclick="checkStorageBucket()">üîç V√©rifier le bucket de stockage</button>
        <div id="snapshots-results"></div>
    </div>

    <div class="test-section">
        <h3>Logs de Diagnostic</h3>
        <button onclick="clearLogs()">üóëÔ∏è Effacer les logs</button>
        <div id="diagnostic-logs"></div>
    </div>

    <script>
        // Configuration Supabase
        const supabaseConfig = { 
            supabaseUrl: 'https://fiecugxopjxzqfdnaqsu.supabase.co', 
            supabaseAnonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpZWN1Z3hvcGp4enFmZG5hcXN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDU2NTcsImV4cCI6MjA3MDA4MTY1N30.xd9Thasg4r8Nrwxx5r8Nrwxx5nFwyGB_ufPIvok4XB-78dilpsw'
        };

        let supabase;

        // Initialisation
        async function initSupabase() {
            try {
                log('üîÑ Initialisation du client Supabase...');
                log('URL: ' + supabaseConfig.supabaseUrl);
                log('Cl√©: ' + supabaseConfig.supabaseAnonKey.substring(0, 20) + '...');
                
                // V√©rifier que createClient est disponible
                if (typeof createClient === 'undefined') {
                    throw new Error('createClient n\'est pas d√©fini. V√©rifiez que le script Supabase est charg√©.');
                }
                
                supabase = createClient(supabaseConfig.supabaseUrl, supabaseConfig.supabaseAnonKey);
                
                // Test de connexion imm√©diat
                const { data, error } = await supabase.from('staffTable').select('count').limit(1);
                if (error) {
                    throw new Error('Test de connexion √©chou√©: ' + error.message);
                }
                
                document.getElementById('supabase-url').textContent = supabaseConfig.supabaseUrl;
                document.getElementById('supabase-key').textContent = supabaseConfig.supabaseAnonKey.substring(0, 20) + '...';
                
                log('‚úÖ Client Supabase initialis√© et test√© avec succ√®s');
                return true;
            } catch (error) {
                log('‚ùå Erreur lors de l\'initialisation: ' + error.message, 'error');
                return false;
            }
        }

        // Test de connexion de base
        async function testConnection() {
            try {
                log('üîÑ Test de connexion de base...');
                const { data, error } = await supabase.from('staffTable').select('count').limit(1);
                
                if (error) {
                    throw error;
                }
                
                log('‚úÖ Connexion de base r√©ussie', 'success');
                document.getElementById('connection-results').innerHTML = '<div class="log success">‚úÖ Connexion de base r√©ussie</div>';
            } catch (error) {
                log('‚ùå Erreur de connexion: ' + error.message, 'error');
                document.getElementById('connection-results').innerHTML = '<div class="log error">‚ùå Erreur de connexion: ' + error.message + '</div>';
            }
        }

        // Test d'acc√®s √† la table principale
        async function testTableAccess() {
            try {
                log('üîÑ Test d\'acc√®s √† la table staffTable...');
                const { data, error } = await supabase.from('staffTable').select('*').limit(5);
                
                if (error) {
                    throw error;
                }
                
                log(`‚úÖ Acc√®s √† staffTable r√©ussi - ${data.length} lignes trouv√©es`, 'success');
                document.getElementById('connection-results').innerHTML += '<div class="log success">‚úÖ Acc√®s √† staffTable r√©ussi - ' + data.length + ' lignes trouv√©es</div>';
            } catch (error) {
                log('‚ùå Erreur d\'acc√®s √† staffTable: ' + error.message, 'error');
                document.getElementById('connection-results').innerHTML += '<div class="log error">‚ùå Erreur d\'acc√®s √† staffTable: ' + error.message + '</div>';
            }
        }

        // Test d'acc√®s √† la table des snapshots
        async function testSnapshotTable() {
            try {
                log('üîÑ Test d\'acc√®s √† la table table_snapshots_index...');
                const { data, error } = await supabase.from('table_snapshots_index').select('*');
                
                if (error) {
                    throw error;
                }
                
                log(`‚úÖ Acc√®s √† table_snapshots_index r√©ussi - ${data.length} snapshots trouv√©s`, 'success');
                document.getElementById('connection-results').innerHTML += '<div class="log success">‚úÖ Acc√®s √† table_snapshots_index r√©ussi - ' + data.length + ' snapshots trouv√©s</div>';
                
                if (data.length > 0) {
                    log('üìã D√©tails des snapshots:');
                    data.forEach((snapshot, index) => {
                        log(`  ${index + 1}. Date: ${snapshot.snapshot_date}, Lignes: ${snapshot.row_count}, Taille: ${snapshot.file_size_bytes} bytes`);
                    });
                }
            } catch (error) {
                log('‚ùå Erreur d\'acc√®s √† table_snapshots_index: ' + error.message, 'error');
                document.getElementById('connection-results').innerHTML += '<div class="log error">‚ùå Erreur d\'acc√®s √† table_snapshots_index: ' + error.message + '</div>';
            }
        }

        // Test d'acc√®s au stockage
        async function testStorageAccess() {
            try {
                log('üîÑ Test d\'acc√®s au bucket de stockage...');
                const { data, error } = await supabase.storage.from('table-snapshots').list('', { limit: 10 });
                
                if (error) {
                    throw error;
                }
                
                log(`‚úÖ Acc√®s au stockage r√©ussi - ${data.length} fichiers trouv√©s`, 'success');
                document.getElementById('connection-results').innerHTML += '<div class="log success">‚úÖ Acc√®s au stockage r√©ussi - ' + data.length + ' fichiers trouv√©s</div>';
                
                if (data.length > 0) {
                    log('üìÅ Fichiers dans le bucket:');
                    data.forEach((file, index) => {
                        log(`  ${index + 1}. ${file.name} (${file.metadata?.size || 'Taille inconnue'} bytes)`);
                    });
                }
            } catch (error) {
                log('‚ùå Erreur d\'acc√®s au stockage: ' + error.message, 'error');
                document.getElementById('connection-results').innerHTML += '<div class="log error">‚ùå Erreur d\'acc√®s au stockage: ' + error.message + '</div>';
            }
        }

        // Charger les snapshots
        async function loadSnapshots() {
            try {
                log('üîÑ Chargement des snapshots...');
                const { data, error } = await supabase
                    .from('table_snapshots_index')
                    .select('snapshot_date, created_at, row_count, object_path, file_size_bytes')
                    .order('snapshot_date', { ascending: false });
                
                if (error) {
                    throw error;
                }
                
                log(`‚úÖ ${data.length} snapshots charg√©s`, 'success');
                
                let resultsHtml = `<div class="log success">‚úÖ ${data.length} snapshots charg√©s</div>`;
                
                if (data.length > 0) {
                    resultsHtml += '<div class="log">';
                    data.forEach((snapshot, index) => {
                        const date = new Date(snapshot.snapshot_date);
                        const formattedDate = date.toLocaleDateString('fr-FR');
                        resultsHtml += `<div><strong>${index + 1}.</strong> Date: ${formattedDate}, Lignes: ${snapshot.row_count}, Taille: ${(snapshot.file_size_bytes / 1024).toFixed(2)} KB</div>`;
                    });
                    resultsHtml += '</div>';
                } else {
                    resultsHtml += '<div class="log info">Aucun snapshot trouv√© dans la base de donn√©es</div>';
                }
                
                document.getElementById('snapshots-results').innerHTML = resultsHtml;
                
            } catch (error) {
                log('‚ùå Erreur lors du chargement des snapshots: ' + error.message, 'error');
                document.getElementById('snapshots-results').innerHTML = '<div class="log error">‚ùå Erreur lors du chargement des snapshots: ' + error.message + '</div>';
            }
        }

        // V√©rifier le bucket de stockage
        async function checkStorageBucket() {
            try {
                log('üîÑ V√©rification du bucket de stockage...');
                
                // Lister les fichiers dans le bucket snapshots
                const { data: files, error: filesError } = await supabase.storage
                    .from('table-snapshots')
                    .list('', { limit: 100 });
                
                if (filesError) {
                    throw filesError;
                }
                
                log(`‚úÖ Bucket snapshots accessible - ${files.length} fichiers trouv√©s`, 'success');
                
                let resultsHtml = `<div class="log success">‚úÖ Bucket snapshots accessible - ${files.length} fichiers trouv√©s</div>`;
                
                if (files.length > 0) {
                    resultsHtml += '<div class="log">';
                    files.forEach((file, index) => {
                        const size = file.metadata?.size ? (file.metadata.size / 1024).toFixed(2) + ' KB' : 'Taille inconnue';
                        resultsHtml += `<div><strong>${index + 1}.</strong> ${file.name} (${size})</div>`;
                    });
                    resultsHtml += '</div>';
                } else {
                    resultsHtml += '<div class="log info">Aucun fichier trouv√© dans le bucket snapshots</div>';
                }
                
                document.getElementById('snapshots-results').innerHTML += resultsHtml;
                
            } catch (error) {
                log('‚ùå Erreur lors de la v√©rification du bucket: ' + error.message, 'error');
                document.getElementById('snapshots-results').innerHTML += '<div class="log error">‚ùå Erreur lors de la v√©rification du bucket: ' + error.message + '</div>';
            }
        }

        // Fonction utilitaire pour logger
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('diagnostic-logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log ${type}`;
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            
            console.log(`[${timestamp}] ${message}`);
        }

        // Effacer les logs
        function clearLogs() {
            document.getElementById('diagnostic-logs').innerHTML = '';
        }

        // Initialisation au chargement de la page
        window.addEventListener('load', async () => {
            log('üöÄ Page de diagnostic charg√©e');
            await initSupabase();
        });
    </script>
</body>
</html>
