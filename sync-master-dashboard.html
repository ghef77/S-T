<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ›ï¸ Tableau de Bord MaÃ®tre - Synchronisation</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: system-ui, -apple-system, sans-serif; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #1f2937;
            line-height: 1.6;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 1.1rem; }
        
        .container { 
            max-width: 1600px; 
            margin: 0 auto; 
            padding: 20px;
        }
        
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); 
            gap: 20px; 
            margin: 20px 0;
        }
        
        .card { 
            background: white; 
            border-radius: 12px; 
            padding: 20px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .card:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .card h3 { 
            color: #374151; 
            margin-bottom: 15px; 
            font-size: 1.3rem;
            display: flex;
            align-items: center;
        }
        
        .card h3 .emoji { margin-right: 10px; font-size: 1.5rem; }
        
        .status-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
            gap: 15px; 
            margin: 15px 0;
        }
        
        .status-item { 
            text-align: center; 
            padding: 15px; 
            border-radius: 8px; 
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            transition: all 0.2s;
        }
        
        .status-item.healthy { border-color: #10b981; background: #ecfdf5; }
        .status-item.warning { border-color: #f59e0b; background: #fffbeb; }
        .status-item.error { border-color: #ef4444; background: #fef2f2; }
        
        .status-value { font-size: 1.5rem; font-weight: bold; margin-bottom: 5px; }
        .status-label { font-size: 0.85rem; opacity: 0.8; }
        
        .button { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 8px; 
            cursor: pointer; 
            margin: 5px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .button:hover { 
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .button.success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .button.warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .button.danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        
        .metrics-display {
            background: #1f2937;
            color: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.6;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .timeline {
            max-height: 250px;
            overflow-y: auto;
            background: #f8fafc;
            border-radius: 8px;
            padding: 15px;
        }
        
        .timeline-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .timeline-item:last-child { border-bottom: none; }
        
        .timeline-time {
            min-width: 80px;
            font-size: 12px;
            color: #64748b;
            font-family: monospace;
        }
        
        .timeline-event {
            flex: 1;
            font-size: 14px;
        }
        
        .timeline-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .timeline-status.success { background: #10b981; }
        .timeline-status.warning { background: #f59e0b; }
        .timeline-status.error { background: #ef4444; }
        .timeline-status.info { background: #3b82f6; }
        
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        
        .system-health {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, #f0fff4 0%, #dcfce7 100%);
            border: 1px solid #bbf7d0;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }
        
        .health-indicator {
            display: flex;
            align-items: center;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .health-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 2s infinite;
        }
        
        .health-dot.healthy { background: #10b981; }
        .health-dot.warning { background: #f59e0b; }
        .health-dot.error { background: #ef4444; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .progress-ring {
            width: 60px;
            height: 60px;
            margin: 10px;
        }
        
        .progress-ring-circle {
            fill: none;
            stroke: #e5e7eb;
            stroke-width: 4;
        }
        
        .progress-ring-progress {
            fill: none;
            stroke: #10b981;
            stroke-width: 4;
            stroke-linecap: round;
            transform-origin: 50% 50%;
            transform: rotate(-90deg);
            transition: stroke-dasharray 0.3s;
        }
        
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 2rem; }
            .container { padding: 15px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ›ï¸ Tableau de Bord MaÃ®tre</h1>
        <p>Surveillance ComplÃ¨te de la Synchronisation Temps RÃ©el</p>
    </div>
    
    <div class="container">
        <!-- Ã‰tat de santÃ© du systÃ¨me -->
        <div class="system-health">
            <div class="health-indicator">
                <div class="health-dot healthy" id="systemHealthDot"></div>
                <span id="systemHealthText">SystÃ¨me OpÃ©rationnel</span>
            </div>
            <div style="display: flex; align-items: center;">
                <svg class="progress-ring" width="60" height="60">
                    <circle class="progress-ring-circle" cx="30" cy="30" r="26"></circle>
                    <circle class="progress-ring-progress" cx="30" cy="30" r="26" 
                            id="healthProgressCircle" stroke-dasharray="0 164"></circle>
                </svg>
                <div>
                    <div style="font-weight: bold;" id="systemScore">95%</div>
                    <div style="font-size: 0.9rem; opacity: 0.8;">Score de SantÃ©</div>
                </div>
            </div>
        </div>
        
        <!-- Grille principale -->
        <div class="grid">
            <!-- Ã‰tat en temps rÃ©el -->
            <div class="card">
                <h3><span class="emoji">ğŸ“¡</span>Ã‰tat Temps RÃ©el</h3>
                <div class="status-grid">
                    <div class="status-item" id="connectionStatus">
                        <div class="status-value">-</div>
                        <div class="status-label">Connexion</div>
                    </div>
                    <div class="status-item" id="subscriptionStatus">
                        <div class="status-value">-</div>
                        <div class="status-label">Subscription</div>
                    </div>
                    <div class="status-item" id="eventsStatus">
                        <div class="status-value">0</div>
                        <div class="status-label">Ã‰vÃ©nements</div>
                    </div>
                    <div class="status-item" id="latencyStatus">
                        <div class="status-value">-</div>
                        <div class="status-label">Latence</div>
                    </div>
                </div>
                <div class="quick-actions">
                    <button class="button success" onclick="refreshStatus()">ğŸ”„ Actualiser</button>
                    <button class="button" onclick="openMonitor()">ğŸ‘ï¸ Monitoring</button>
                </div>
            </div>
            
            <!-- Actions rapides -->
            <div class="card">
                <h3><span class="emoji">âš¡</span>Actions Rapides</h3>
                <div class="quick-actions">
                    <button class="button success" onclick="runQuickDiagnostic()">ğŸ” Diagnostic Rapide</button>
                    <button class="button warning" onclick="runFullAnalysis()">ğŸ§ª Analyse ComplÃ¨te</button>
                    <button class="button danger" onclick="forceReconnect()">ğŸ”„ Reconnexion ForcÃ©e</button>
                </div>
                <div class="quick-actions">
                    <button class="button" onclick="testEdgeCases()">ğŸ§ª Test Cas Limites</button>
                    <button class="button" onclick="checkSyncIssues()">ğŸ” ProblÃ¨mes Sync</button>
                    <button class="button" onclick="exportAllLogs()">ğŸ“ Exporter Logs</button>
                </div>
            </div>
            
            <!-- MÃ©triques de performance -->
            <div class="card">
                <h3><span class="emoji">ğŸ“Š</span>MÃ©triques</h3>
                <div class="metrics-display" id="metricsDisplay">
                    Chargement des mÃ©triques...
                </div>
                <div class="quick-actions">
                    <button class="button" onclick="updateMetrics()">ğŸ“ˆ Actualiser</button>
                    <button class="button" onclick="resetMetrics()">ğŸ—‘ï¸ RÃ©initialiser</button>
                </div>
            </div>
            
            <!-- Timeline des Ã©vÃ©nements -->
            <div class="card">
                <h3><span class="emoji">â°</span>Timeline</h3>
                <div class="timeline" id="eventTimeline">
                    <div class="timeline-item">
                        <div class="timeline-status info"></div>
                        <div class="timeline-time">--:--:--</div>
                        <div class="timeline-event">Tableau de bord initialisÃ©</div>
                    </div>
                </div>
                <div class="quick-actions">
                    <button class="button" onclick="clearTimeline()">ğŸ—‘ï¸ Vider</button>
                </div>
            </div>
            
            <!-- Outils de correction -->
            <div class="card">
                <h3><span class="emoji">ğŸ”§</span>Outils de Correction</h3>
                <div class="quick-actions">
                    <button class="button success" onclick="autoFixAll()">ğŸš€ Correction Auto</button>
                    <button class="button warning" onclick="clearBlockingFlags()">ğŸ Vider Flags</button>
                    <button class="button" onclick="reinitializeSupabase()">ğŸ“¡ RÃ©init Supabase</button>
                </div>
                <div class="quick-actions">
                    <button class="button" onclick="openDirectFix()">ğŸ”§ Fix Direct</button>
                    <button class="button" onclick="openDiagnostics()">ğŸ” Diagnostics</button>
                </div>
            </div>
            
            <!-- Rapport de santÃ© -->
            <div class="card">
                <h3><span class="emoji">ğŸ“‹</span>Rapport de SantÃ©</h3>
                <div class="metrics-display" id="healthReport">
                    GÃ©nÃ©ration du rapport...
                </div>
                <div class="quick-actions">
                    <button class="button" onclick="generateHealthReport()">ğŸ“‹ GÃ©nÃ©rer</button>
                    <button class="button" onclick="exportHealthReport()">ğŸ“¤ Exporter</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        // Import Supabase
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
        
        // Configuration
        const supabaseConfig = {
            supabaseUrl: 'https://fiecugxopjxzqfdnaqsu.supabase.co',
            supabaseAnonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpZWN1Z3hvcGp4enFmZG5hcXN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDU2NTcsImV4cCI6MjA3MDA4MTY1N30.xd9Thasg4r8Nrwxx5nFwyGB_ufPIvok4XB-78dilpsw'
        };
        
        // Variables globales du dashboard
        window.dashboardData = {
            supabase: null,
            subscription: null,
            startTime: Date.now(),
            events: [],
            maxEvents: 100,
            maxTimelineItems: 50,
            isInitializing: false,
            isReconnecting: false,
            lastHealthUpdate: 0,
            healthUpdateThrottle: 1000,
            metrics: {
                eventCount: 0,
                errorCount: 0,
                avgLatency: 0,
                connectionUptime: 100
            }
        };
        
        // Initialisation du dashboard
        async function initDashboard() {
            if (window.dashboardData.isInitializing) {
                console.warn('Initialisation dÃ©jÃ  en cours');
                return;
            }
            
            window.dashboardData.isInitializing = true;
            try {
                addTimelineEvent('info', 'Initialisation du dashboard...');
                
                // CrÃ©er le client Supabase
                window.dashboardData.supabase = createClient(supabaseConfig.supabaseUrl, supabaseConfig.supabaseAnonKey);
                window.supabase = window.dashboardData.supabase; // Pour compatibilitÃ©
                
                addTimelineEvent('success', 'Client Supabase initialisÃ©');
                
                // DÃ©marrer la surveillance
                try {
                    await startMonitoring();
                } catch (error) {
                    console.error('Erreur dÃ©marrage surveillance:', error);
                    addTimelineEvent('error', 'Ã‰chec dÃ©marrage surveillance: ' + error.message);
                }
                
                // PremiÃ¨re mise Ã  jour des mÃ©triques
                try {
                    await updateSystemHealth();
                    await updateMetrics();
                } catch (error) {
                    console.error('Erreur mise Ã  jour initiale:', error);
                    addTimelineEvent('error', 'Ã‰chec mise Ã  jour initiale: ' + error.message);
                }
                
                // DÃ©marrer les mises Ã  jour automatiques avec gestion d'erreur
                setInterval(async () => {
                    try {
                        await updateSystemHealth();
                    } catch (error) {
                        console.error('Erreur mise Ã  jour santÃ©:', error);
                    }
                }, 10000); // 10 secondes
                
                setInterval(() => {
                    try {
                        updateMetrics();
                    } catch (error) {
                        console.error('Erreur mise Ã  jour mÃ©triques:', error);
                    }
                }, 5000); // 5 secondes
                
                setInterval(async () => {
                    try {
                        await checkSystemHealth();
                    } catch (error) {
                        console.error('Erreur vÃ©rification santÃ©:', error);
                    }
                }, 30000); // 30 secondes
                
                addTimelineEvent('success', 'Dashboard complÃ¨tement initialisÃ©');
                
            } catch (error) {
                console.error('Erreur initialisation dashboard:', error);
                addTimelineEvent('error', 'Erreur initialisation: ' + error.message);
                updateSystemHealth('error', 0);
            } finally {
                window.dashboardData.isInitializing = false;
            }
        }
        
        // DÃ©marrer la surveillance
        async function startMonitoring() {
            try {
                const channelName = `dashboard-${Date.now()}`;
                
                window.dashboardData.subscription = window.dashboardData.supabase
                    .channel(channelName)
                    .on('postgres_changes', {
                        event: '*',
                        schema: 'public',
                        table: 'staffTable'
                    }, (payload) => {
                        handleRealtimeEvent(payload);
                    })
                    .subscribe((status, error) => {
                        if (status === 'SUBSCRIBED') {
                            addTimelineEvent('success', `Monitoring actif (${channelName})`);
                            window.realtimeSubscription = window.dashboardData.subscription; // CompatibilitÃ©
                        } else if (status === 'CHANNEL_ERROR') {
                            addTimelineEvent('error', 'Erreur subscription: ' + (error?.message || 'Inconnue'));
                            window.dashboardData.metrics.errorCount++;
                        }
                    });
                    
            } catch (error) {
                addTimelineEvent('error', 'Erreur monitoring: ' + error.message);
            }
        }
        
        // GÃ©rer les Ã©vÃ©nements realtime
        function handleRealtimeEvent(payload) {
            window.dashboardData.metrics.eventCount++;
            window.dashboardData.events.push({
                timestamp: Date.now(),
                type: payload.event,
                payload: payload
            });
            
            // Garder seulement les maxEvents derniers Ã©vÃ©nements
            if (window.dashboardData.events.length > window.dashboardData.maxEvents) {
                window.dashboardData.events.splice(0, window.dashboardData.events.length - window.dashboardData.maxEvents);
            }
            
            const eventType = payload.event.toLowerCase();
            addTimelineEvent(eventType, `${payload.event}: ${payload.new?.id || payload.old?.id || 'N/A'}`);
        }
        
        // Mettre Ã  jour la santÃ© du systÃ¨me
        async function updateSystemHealth(forceStatus = null, forceScore = null) {
            const now = Date.now();
            if (forceStatus === null && forceScore === null && 
                now - window.dashboardData.lastHealthUpdate < window.dashboardData.healthUpdateThrottle) {
                return; // Throttle les mises Ã  jour automatiques
            }
            
            window.dashboardData.lastHealthUpdate = now;
            
            try {
                let healthScore = forceScore !== null ? forceScore : 95;
                let healthStatus = forceStatus || 'healthy';
                
                if (forceStatus === null) {
                    // Calculer le score de santÃ© basÃ© sur diffÃ©rents facteurs
                    let score = 100;
                    
                    // Connexion Supabase (-20 si pas de client)
                    if (!window.dashboardData.supabase) {
                        score -= 20;
                        healthStatus = 'error';
                    }
                    
                    // Subscription (-15 si pas connectÃ©e)
                    const subscriptionState = window.dashboardData.subscription?.state;
                    if (!window.dashboardData.subscription || 
                        (subscriptionState !== 'joined' && subscriptionState !== 'SUBSCRIBED')) {
                        score -= 15;
                        if (healthStatus !== 'error') healthStatus = 'warning';
                    }
                    
                    // Erreurs rÃ©centes (-10 si plus de 3 erreurs)
                    if (window.dashboardData.metrics.errorCount > 3) {
                        score -= 10;
                        if (healthStatus !== 'error') healthStatus = 'warning';
                    }
                    
                    // Latence (-5 si plus de 2000ms)
                    if (window.dashboardData.metrics.avgLatency > 2000) {
                        score -= 5;
                    }
                    
                    healthScore = Math.max(0, score);
                }
                
                // Mise Ã  jour de l'interface
                const healthDot = document.getElementById('systemHealthDot');
                const healthText = document.getElementById('systemHealthText');
                const systemScore = document.getElementById('systemScore');
                const healthProgressCircle = document.getElementById('healthProgressCircle');
                
                if (healthDot) {
                    healthDot.className = `health-dot ${healthStatus}`;
                }
                
                if (healthText) {
                    const statusTexts = {
                        healthy: 'SystÃ¨me OpÃ©rationnel',
                        warning: 'Attention Requise',
                        error: 'ProblÃ¨me Critique'
                    };
                    healthText.textContent = statusTexts[healthStatus] || 'Ã‰tat Inconnu';
                }
                
                if (systemScore) {
                    systemScore.textContent = healthScore + '%';
                }
                
                if (healthProgressCircle) {
                    const circumference = 2 * Math.PI * 26; // rayon = 26
                    const progress = (healthScore / 100) * circumference;
                    healthProgressCircle.style.strokeDasharray = `${progress} ${circumference}`;
                }
                
                // Mettre Ã  jour les statuts individuels
                await updateIndividualStatuses();
                
            } catch (error) {
                console.error('Erreur mise Ã  jour santÃ©:', error);
            }
        }
        
        // Mettre Ã  jour les statuts individuels
        async function updateIndividualStatuses() {
            // Connexion
            const connectionEl = document.getElementById('connectionStatus');
            if (connectionEl) {
                const isConnected = !!window.dashboardData.supabase;
                connectionEl.className = `status-item ${isConnected ? 'healthy' : 'error'}`;
                connectionEl.querySelector('.status-value').textContent = isConnected ? 'âœ…' : 'âŒ';
            }
            
            // Subscription
            const subscriptionEl = document.getElementById('subscriptionStatus');
            if (subscriptionEl) {
                const subscriptionState = window.dashboardData.subscription?.state;
                const isSubscribed = window.dashboardData.subscription && 
                                   (subscriptionState === 'joined' || subscriptionState === 'SUBSCRIBED');
                subscriptionEl.className = `status-item ${isSubscribed ? 'healthy' : 'error'}`;
                subscriptionEl.querySelector('.status-value').textContent = isSubscribed ? 'ğŸ“¡' : 'âŒ';
            }
            
            // Ã‰vÃ©nements
            const eventsEl = document.getElementById('eventsStatus');
            if (eventsEl) {
                eventsEl.className = 'status-item healthy';
                eventsEl.querySelector('.status-value').textContent = window.dashboardData.metrics.eventCount;
            }
            
            // Latence
            const latencyEl = document.getElementById('latencyStatus');
            if (latencyEl) {
                const latency = window.dashboardData.metrics.avgLatency;
                const latencyStatus = latency > 2000 ? 'error' : latency > 1000 ? 'warning' : 'healthy';
                latencyEl.className = `status-item ${latencyStatus}`;
                latencyEl.querySelector('.status-value').textContent = latency > 0 ? `${Math.round(latency)}ms` : '-';
            }
        }
        
        // Mettre Ã  jour les mÃ©triques
        function updateMetrics() {
            const metricsDisplay = document.getElementById('metricsDisplay');
            if (!metricsDisplay) return;
            
            const uptime = Math.floor((Date.now() - window.dashboardData.startTime) / 1000);
            const uptimeMinutes = Math.floor(uptime / 60);
            const uptimeSeconds = uptime % 60;
            
            const metrics = `
ğŸ“Š MÃ‰TRIQUES TEMPS RÃ‰EL
=====================
â±ï¸  Uptime: ${uptimeMinutes}m ${uptimeSeconds}s
ğŸ”” Ã‰vÃ©nements reÃ§us: ${window.dashboardData.metrics.eventCount}
âŒ Erreurs: ${window.dashboardData.metrics.errorCount}
ğŸ“Š Latence moyenne: ${window.dashboardData.metrics.avgLatency}ms
ğŸ”— Ã‰tat connexion: ${window.dashboardData.supabase ? 'ConnectÃ©' : 'DÃ©connectÃ©'}
ğŸ“¡ Ã‰tat subscription: ${window.dashboardData.subscription?.state || 'N/A'}
ğŸ”— Canal subscription: ${window.dashboardData.subscription?.topic || 'N/A'}

ğŸ“ˆ STATISTIQUES
==============
ğŸ¯ Taux de succÃ¨s: ${((window.dashboardData.metrics.eventCount - window.dashboardData.metrics.errorCount) / Math.max(window.dashboardData.metrics.eventCount, 1) * 100).toFixed(1)}%
âš¡ Ã‰vÃ©nements/min: ${Math.round(window.dashboardData.metrics.eventCount / Math.max(uptimeMinutes, 1))}
ğŸ›¡ï¸ StabilitÃ©: ${window.dashboardData.metrics.connectionUptime}%

ğŸ”§ SYSTÃˆME
==========
ğŸ’¾ MÃ©moire utilisÃ©e: ${performance.memory ? Math.round(performance.memory.usedJSHeapSize / 1024 / 1024) + 'MB' : 'N/A'}
ğŸŒ URL Supabase: ${supabaseConfig.supabaseUrl}
ğŸ“… DerniÃ¨re MAJ: ${new Date().toLocaleTimeString()}
            `;
            
            metricsDisplay.textContent = metrics;
        }
        
        // Ajouter un Ã©vÃ©nement Ã  la timeline
        function addTimelineEvent(type, message) {
            const timeline = document.getElementById('eventTimeline');
            if (!timeline) return;
            
            const timelineItem = document.createElement('div');
            timelineItem.className = 'timeline-item';
            
            const statusClass = type === 'insert' ? 'success' : 
                              type === 'update' ? 'warning' :
                              type === 'delete' ? 'error' : type;
            
            timelineItem.innerHTML = `
                <div class="timeline-status ${statusClass}"></div>
                <div class="timeline-time">${new Date().toLocaleTimeString()}</div>
                <div class="timeline-event">${message}</div>
            `;
            
            timeline.insertBefore(timelineItem, timeline.firstChild);
            
            // Garder seulement les maxTimelineItems derniers Ã©vÃ©nements visibles
            while (timeline.children.length > window.dashboardData.maxTimelineItems) {
                timeline.removeChild(timeline.lastChild);
            }
        }
        
        // VÃ©rifier la santÃ© du systÃ¨me
        async function checkSystemHealth() {
            try {
                // Test de connexion Supabase
                if (window.dashboardData.supabase) {
                    const start = performance.now();
                    const { data, error } = await window.dashboardData.supabase.auth.getSession();
                    const latency = performance.now() - start;
                    
                    window.dashboardData.metrics.avgLatency = latency;
                    
                    if (error) {
                        window.dashboardData.metrics.errorCount++;
                        addTimelineEvent('error', 'Erreur connexion: ' + error.message);
                    }
                }
                
                // VÃ©rifier les flags de blocage
                const hasBlocks = (typeof window.isLocalSaveInProgress === 'boolean' && window.isLocalSaveInProgress) || 
                                 (typeof window.isExcelSaveInProgress === 'boolean' && window.isExcelSaveInProgress) ||
                                 (typeof window.isRestoringCursor === 'function' && window.isRestoringCursor());
                
                if (hasBlocks) {
                    addTimelineEvent('warning', 'Flags de blocage dÃ©tectÃ©s');
                }
                
            } catch (error) {
                window.dashboardData.metrics.errorCount++;
                addTimelineEvent('error', 'Erreur vÃ©rification: ' + error.message);
            }
        }
        
        // Fonctions globales pour les boutons
        window.refreshStatus = async function() {
            try {
                addTimelineEvent('info', 'Actualisation manuelle des statuts...');
                await updateSystemHealth();
                await updateMetrics();
                addTimelineEvent('success', 'Statuts actualisÃ©s avec succÃ¨s');
            } catch (error) {
                console.error('Erreur actualisation statuts:', error);
                addTimelineEvent('error', 'Erreur actualisation: ' + error.message);
            }
        };
        
        window.openMonitor = function() {
            window.open('realtime-sync-monitor.html', '_blank');
        };
        
        window.runQuickDiagnostic = async function() {
            addTimelineEvent('info', 'Diagnostic rapide en cours...');
            
            // Simulation d'un diagnostic rapide
            try {
                const issues = [];
                
                if (!window.dashboardData.supabase) {
                    issues.push('Client Supabase non initialisÃ©');
                }
                
                const subscriptionState = window.dashboardData.subscription?.state;
                if (!window.dashboardData.subscription || 
                    (subscriptionState !== 'joined' && subscriptionState !== 'SUBSCRIBED')) {
                    issues.push('Subscription realtime non active');
                }
                
                const hasBlocks = (typeof window.isLocalSaveInProgress === 'boolean' && window.isLocalSaveInProgress) || 
                                 (typeof window.isExcelSaveInProgress === 'boolean' && window.isExcelSaveInProgress);
                if (hasBlocks) {
                    issues.push('Flags de blocage actifs');
                }
                
                if (issues.length === 0) {
                    addTimelineEvent('success', 'Diagnostic rapide: Aucun problÃ¨me dÃ©tectÃ©');
                } else {
                    addTimelineEvent('warning', `Diagnostic rapide: ${issues.length} problÃ¨mes trouvÃ©s`);
                    issues.forEach(issue => {
                        addTimelineEvent('error', `- ${issue}`);
                    });
                }
                
            } catch (error) {
                addTimelineEvent('error', 'Erreur diagnostic: ' + error.message);
            }
        };
        
        window.runFullAnalysis = function() {
            addTimelineEvent('info', 'Analyse complÃ¨te lancÃ©e...');
            window.open('test-sync-tools.html', '_blank');
        };
        
        window.forceReconnect = async function() {
            if (window.dashboardData.isReconnecting) {
                addTimelineEvent('warning', 'Reconnexion dÃ©jÃ  en cours...');
                return;
            }
            
            window.dashboardData.isReconnecting = true;
            addTimelineEvent('info', 'Reconnexion forcÃ©e...');
            
            try {
                if (window.dashboardData.subscription) {
                    try {
                        await window.dashboardData.supabase.removeChannel(window.dashboardData.subscription);
                    } catch (removeError) {
                        console.warn('Erreur suppression channel:', removeError);
                        addTimelineEvent('warning', 'ProblÃ¨me suppression ancien channel');
                    }
                    window.dashboardData.subscription = null;
                }
                
                await startMonitoring();
                addTimelineEvent('success', 'Reconnexion rÃ©ussie');
            } catch (error) {
                console.error('Erreur reconnexion:', error);
                addTimelineEvent('error', 'Erreur reconnexion: ' + error.message);
            } finally {
                window.dashboardData.isReconnecting = false;
            }
        };
        
        window.testEdgeCases = function() {
            window.open('edge-case-tester.html', '_blank');
        };
        
        window.checkSyncIssues = function() {
            window.open('sync-issues-detector.html', '_blank');
        };
        
        window.exportAllLogs = function() {
            try {
                const logs = {
                    timestamp: new Date().toISOString(),
                    dashboardData: window.dashboardData || {},
                    systemHealth: document.getElementById('systemScore')?.textContent || 'N/A',
                    timeline: Array.from(document.querySelectorAll('.timeline-item') || []).map(item => ({
                        time: item.querySelector('.timeline-time')?.textContent || '',
                        event: item.querySelector('.timeline-event')?.textContent || '',
                        type: item.querySelector('.timeline-status')?.className || ''
                    })),
                    windowVariables: {
                        isLocalSaveInProgress: typeof window.isLocalSaveInProgress !== 'undefined' ? window.isLocalSaveInProgress : null,
                        isExcelSaveInProgress: typeof window.isExcelSaveInProgress !== 'undefined' ? window.isExcelSaveInProgress : null,
                        isRestoringCursor: typeof window.isRestoringCursor === 'function' ? 'function available' : 'not available'
                    }
                };
            
                const blob = new Blob([JSON.stringify(logs, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sync-dashboard-logs-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                addTimelineEvent('success', 'Logs exportÃ©s');
            } catch (error) {
                console.error('Erreur export logs:', error);
                addTimelineEvent('error', 'Erreur export logs: ' + error.message);
            }
        };
        
        window.autoFixAll = function() {
            window.open('auto-fix-sync.html', '_blank');
        };
        
        window.clearBlockingFlags = function() {
            if (typeof window.isLocalSaveInProgress !== 'undefined') {
                window.isLocalSaveInProgress = false;
            }
            if (typeof window.isExcelSaveInProgress !== 'undefined') {
                window.isExcelSaveInProgress = false;
            }
            addTimelineEvent('success', 'Flags de blocage vidÃ©s');
        };
        
        window.reinitializeSupabase = async function() {
            addTimelineEvent('info', 'RÃ©initialisation Supabase...');
            try {
                // Nettoyer l'ancienne connexion si elle existe
                if (window.dashboardData.subscription) {
                    try {
                        await window.dashboardData.supabase.removeChannel(window.dashboardData.subscription);
                    } catch (cleanupError) {
                        console.warn('Erreur nettoyage:', cleanupError);
                    }
                    window.dashboardData.subscription = null;
                }
                
                window.dashboardData.supabase = createClient(supabaseConfig.supabaseUrl, supabaseConfig.supabaseAnonKey);
                window.supabase = window.dashboardData.supabase;
                addTimelineEvent('success', 'Supabase rÃ©initialisÃ©');
                
                // RedÃ©marrer la surveillance
                await startMonitoring();
            } catch (error) {
                console.error('Erreur rÃ©initialisation:', error);
                addTimelineEvent('error', 'Erreur rÃ©initialisation: ' + error.message);
            }
        };
        
        window.openDirectFix = function() {
            window.open('fix-sync-direct.html', '_blank');
        };
        
        window.openDiagnostics = function() {
            window.open('realtime-sync-diagnostics.js', '_blank');
        };
        
        window.generateHealthReport = async function() {
            try {
                const healthReport = document.getElementById('healthReport');
                if (!healthReport) {
                    addTimelineEvent('error', 'Ã‰lÃ©ment rapport de santÃ© introuvable');
                    return;
                }
                
                addTimelineEvent('info', 'GÃ©nÃ©ration rapport de santÃ©...');
            
            const report = `
ğŸ¥ RAPPORT DE SANTÃ‰ SYSTÃˆME
===========================
ğŸ“… GÃ©nÃ©rÃ© le: ${new Date().toLocaleString()}
â±ï¸ Uptime: ${Math.floor((Date.now() - window.dashboardData.startTime) / 60000)} minutes

ğŸ” Ã‰TAT GÃ‰NÃ‰RAL
===============
âœ… Score de santÃ©: ${document.getElementById('systemScore')?.textContent || 'N/A'}
ğŸ”— Connexion Supabase: ${window.dashboardData.supabase ? 'âœ… OK' : 'âŒ KO'}
ğŸ“¡ Subscription: ${(window.dashboardData.subscription?.state === 'joined' || window.dashboardData.subscription?.state === 'SUBSCRIBED') ? 'âœ… ConnectÃ©e' : 'âŒ DÃ©connectÃ©e'}
ğŸ Flags de blocage: ${((typeof window.isLocalSaveInProgress === 'boolean' && window.isLocalSaveInProgress) || (typeof window.isExcelSaveInProgress === 'boolean' && window.isExcelSaveInProgress)) ? 'âš ï¸ Actifs' : 'âœ… Clairs'}

ğŸ“Š MÃ‰TRIQUES PERFORMANCE
========================
ğŸ”” Ã‰vÃ©nements traitÃ©s: ${window.dashboardData.metrics.eventCount}
âŒ Erreurs totales: ${window.dashboardData.metrics.errorCount}
ğŸ“Š Latence moyenne: ${window.dashboardData.metrics.avgLatency}ms
ğŸ¯ Taux de succÃ¨s: ${((window.dashboardData.metrics.eventCount - window.dashboardData.metrics.errorCount) / Math.max(window.dashboardData.metrics.eventCount, 1) * 100).toFixed(1)}%

ğŸ’¡ RECOMMANDATIONS
==================
${window.dashboardData.metrics.errorCount > 3 ? 'âš ï¸ Taux d\'erreur Ã©levÃ© - Investigation requise\n' : ''}${window.dashboardData.metrics.avgLatency > 2000 ? 'âš ï¸ Latence Ã©levÃ©e - Optimisation rÃ©seau recommandÃ©e\n' : ''}${(!window.dashboardData.subscription || (window.dashboardData.subscription.state !== 'joined' && window.dashboardData.subscription.state !== 'SUBSCRIBED')) ? 'ğŸ”§ RecrÃ©er la subscription realtime\n' : ''}${window.dashboardData.metrics.errorCount === 0 && window.dashboardData.metrics.avgLatency < 1000 ? 'ğŸ‰ SystÃ¨me en excellente santÃ© - Aucune action requise\n' : ''}

ğŸ”§ ACTIONS SUGGÃ‰RÃ‰ES
====================
1. Surveillance continue des mÃ©triques
2. Tests rÃ©guliers des cas limites
3. Maintenance prÃ©ventive hebdomadaire
4. Mise Ã  jour des outils de diagnostic
            `;
            
                healthReport.textContent = report;
                addTimelineEvent('success', 'Rapport de santÃ© gÃ©nÃ©rÃ©');
            } catch (error) {
                console.error('Erreur gÃ©nÃ©ration rapport:', error);
                addTimelineEvent('error', 'Erreur gÃ©nÃ©ration rapport: ' + error.message);
            }
        };
        
        window.exportHealthReport = function() {
            try {
                const healthReport = document.getElementById('healthReport')?.textContent || 'Rapport non gÃ©nÃ©rÃ©';
                
                const blob = new Blob([healthReport], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `health-report-${Date.now()}.txt`;
                a.click();
                URL.revokeObjectURL(url);
                
                addTimelineEvent('success', 'Rapport de santÃ© exportÃ©');
            } catch (error) {
                console.error('Erreur export rapport:', error);
                addTimelineEvent('error', 'Erreur export rapport: ' + error.message);
            }
        };
        
        window.clearTimeline = function() {
            const timeline = document.getElementById('eventTimeline');
            if (timeline) {
                timeline.innerHTML = `
                    <div class="timeline-item">
                        <div class="timeline-status info"></div>
                        <div class="timeline-time">${new Date().toLocaleTimeString()}</div>
                        <div class="timeline-event">Timeline vidÃ©e</div>
                    </div>
                `;
            }
        };
        
        // Initialiser au chargement
        initDashboard();
        
    </script>
</body>
</html>