<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Correction Duplication Undo Suppression</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { 
            background: #f8f9fa; 
            padding: 20px; 
            margin: 20px; 
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .log { 
            background: #f8f9fa; 
            padding: 15px; 
            margin: 20px; 
            border-radius: 8px;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }
        .success { color: #28a745; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .info { color: #17a2b8; font-weight: bold; }
        button { 
            padding: 12px 20px; 
            margin: 8px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .btn-danger { background-color: #dc3545; color: white; }
        .instructions {
            background: #e3f2fd;
            padding: 15px;
            margin: 20px;
            border-radius: 8px;
            border-left: 4px solid #2196f3;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .selected-row {
            background-color: #e3f2fd !important;
        }
        .delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
        }
        .undo-btn {
            background-color: #ffc107;
            color: black;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª Test Correction Duplication Undo Suppression</h1>
    
    <div class="instructions">
        <h3>ğŸ“‹ Test de la Correction de la Duplication</h3>
        <p><strong>ProblÃ¨me :</strong> Quand on efface une ligne et fait undo, la ligne revient mais elle est dupliquÃ©e.</p>
        <p><strong>Objectif :</strong> VÃ©rifier que la correction empÃªche la duplication lors de l'undo de suppression.</p>
        <ol>
            <li>VÃ©rifiez l'Ã©tat initial du tableau</li>
            <li>Supprimez une ligne</li>
            <li>Faites undo pour restaurer la ligne</li>
            <li>VÃ©rifiez qu'il n'y a pas de duplication</li>
        </ol>
    </div>
    
    <div class="test-section">
        <h3>ğŸ“Š Tableau de Test</h3>
        <table id="test-table">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Action</th>
                    <th>Nom</th>
                    <th>Email</th>
                    <th>Statut</th>
                </tr>
            </thead>
            <tbody id="test-tbody">
                <tr data-key="1">
                    <td>1</td>
                    <td><button class="delete-btn" onclick="deleteRow(this)">ğŸ—‘ï¸</button></td>
                    <td>Jean Dupont</td>
                    <td>jean@email.com</td>
                    <td>Actif</td>
                </tr>
                <tr data-key="2">
                    <td>2</td>
                    <td><button class="delete-btn" onclick="deleteRow(this)">ğŸ—‘ï¸</button></td>
                    <td>Marie Martin</td>
                    <td>marie@email.com</td>
                    <td>Actif</td>
                </tr>
                <tr data-key="3">
                    <td>3</td>
                    <td><button class="delete-btn" onclick="deleteRow(this)">ğŸ—‘ï¸</button></td>
                    <td>Pierre Durand</td>
                    <td>pierre@email.com</td>
                    <td>Inactif</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="test-section">
        <h3>ğŸ® Actions de Test</h3>
        <button onclick="testDeleteAndUndo()" class="btn-primary">ğŸ§ª Test Suppression + Undo</button>
        <button onclick="testMultipleDeletions()" class="btn-warning">ğŸ”„ Test Multiples Suppressions</button>
        <button onclick="resetTable()" class="btn-success">ğŸ”„ RÃ©initialiser Tableau</button>
        <button onclick="clearLog()" class="btn-danger">ğŸ—‘ï¸ Effacer Log</button>
    </div>
    
    <div class="test-section">
        <h3>ğŸ“ˆ Historique des OpÃ©rations</h3>
        <div id="operation-history">
            <p><strong>OpÃ©rations :</strong> <span id="op-count">0</span></p>
            <p><strong>Lignes supprimÃ©es :</strong> <span id="deleted-count">0</span></p>
            <p><strong>Lignes restaurÃ©es :</strong> <span id="restored-count">0</span></p>
        </div>
    </div>
    
    <div class="log" id="log">
        <div class="info">ğŸš€ Test de correction duplication undo initialisÃ©</div>
    </div>
    
    <script>
        // âœ… SIMULATION DU SYSTÃˆME UNDO/REDO
        let operationHistory = [];
        let redoHistory = [];
        let deletedRowsData = [];
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '<div class="info">ğŸš€ Test de correction duplication undo initialisÃ©</div>';
        }
        
        function updateOperationCounts() {
            document.getElementById('op-count').textContent = operationHistory.length;
            document.getElementById('deleted-count').textContent = deletedRowsData.length;
            document.getElementById('restored-count').textContent = operationHistory.filter(op => op.type === 'restore').length;
        }
        
        // âœ… FONCTION DE SUPPRESSION DE LIGNE (SIMULÃ‰E)
        function deleteRow(button) {
            const row = button.closest('tr');
            const rowKey = row.dataset.key;
            const rowNumber = row.querySelector('td:first-child').textContent;
            
            log(`ğŸ—‘ï¸ Suppression de la ligne ${rowNumber} (clÃ©: ${rowKey})`, 'warning');
            
            // âœ… CAPTURER LES DONNÃ‰ES AVANT SUPPRESSION
            const rowData = {
                key: rowKey,
                number: rowNumber,
                cells: Array.from(row.querySelectorAll('td')).slice(2).map(td => td.textContent),
                headers: ['Nom', 'Email', 'Statut']
            };
            
            // âœ… ENREGISTRER L'OPÃ‰RATION DE SUPPRESSION
            const deleteOperation = {
                type: 'delete',
                timestamp: Date.now(),
                data: {
                    deletedRows: 1,
                    rowKeys: [rowKey],
                    rowData: [rowData],
                    rowNumbers: [parseInt(rowNumber)]
                }
            };
            
            operationHistory.push(deleteOperation);
            deletedRowsData.push(rowData);
            
            // âœ… SUPPRIMER LA LIGNE DU DOM
            row.remove();
            
            // âœ… RENUMÃ‰ROTER LES LIGNES
            renumberRows();
            
            log(`âœ… Ligne ${rowNumber} supprimÃ©e et opÃ©ration enregistrÃ©e`, 'success');
            updateOperationCounts();
        }
        
        // âœ… FONCTION UNDO CORRIGÃ‰E (SANS DUPLICATION)
        function undo() {
            if (operationHistory.length === 0) {
                log('âš ï¸ Aucune opÃ©ration Ã  annuler', 'warning');
                return;
            }
            
            const lastOperation = operationHistory.pop();
            
            if (lastOperation.type === 'delete') {
                log(`ğŸ”„ Tentative de restauration de la ligne supprimÃ©e...`, 'info');
                
                // âœ… VÃ‰RIFIER SI LA LIGNE EXISTE DÃ‰JÃ€ (ANTI-DUPLICATION)
                const existingRow = document.querySelector(`tr[data-key="${lastOperation.data.rowKeys[0]}"]`);
                if (existingRow) {
                    log(`âš ï¸ LIGNE DÃ‰JÃ€ PRÃ‰SENTE - Ã‰VITER LA DUPLICATION`, 'warning');
                    log(`   - ClÃ© existante: ${lastOperation.data.rowKeys[0]}`, 'warning');
                    log(`   - NumÃ©ro de ligne: ${lastOperation.data.rowNumbers[0]}`, 'warning');
                    return;
                }
                
                // âœ… RESTAURER LA LIGNE UNIQUEMENT SI ELLE N'EXISTE PAS
                const rowData = lastOperation.data.rowData[0];
                const tbody = document.getElementById('test-tbody');
                
                // âœ… CRÃ‰ER LA NOUVELLE LIGNE
                const newRow = document.createElement('tr');
                newRow.dataset.key = rowData.key;
                newRow.className = 'bg-white hover:bg-gray-100 transition-colors cursor-pointer';
                
                // âœ… CELLULE NUMÃ‰RO
                const numCell = document.createElement('td');
                numCell.textContent = rowData.number;
                newRow.appendChild(numCell);
                
                // âœ… CELLULE ACTION (bouton supprimer)
                const actionCell = document.createElement('td');
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'ğŸ—‘ï¸';
                deleteBtn.onclick = function() { deleteRow(this); };
                actionCell.appendChild(deleteBtn);
                newRow.appendChild(actionCell);
                
                // âœ… CELLULES DE DONNÃ‰ES
                rowData.cells.forEach(cellText => {
                    const cell = document.createElement('td');
                    cell.textContent = cellText;
                    newRow.appendChild(cell);
                });
                
                // âœ… INSÃ‰RER Ã€ LA POSITION ORIGINALE
                const targetPosition = Math.min(parseInt(rowData.number) - 1, tbody.children.length);
                if (targetPosition >= 0) {
                    tbody.insertBefore(newRow, tbody.children[targetPosition]);
                } else {
                    tbody.appendChild(newRow);
                }
                
                // âœ… RENUMÃ‰ROTER APRÃˆS RESTAURATION
                renumberRows();
                
                // âœ… ENREGISTRER L'OPÃ‰RATION DE RESTAURATION
                const restoreOperation = {
                    type: 'restore',
                    timestamp: Date.now(),
                    data: {
                        restoredRows: 1,
                        rowKey: rowData.key,
                        rowNumber: rowData.number
                    }
                };
                
                operationHistory.push(restoreOperation);
                
                log(`âœ… Ligne ${rowData.number} restaurÃ©e SANS DUPLICATION`, 'success');
                log(`   - ClÃ©: ${rowData.key}`, 'info');
                log(`   - Position: ${targetPosition + 1}`, 'info');
                
            } else {
                log(`âš ï¸ Type d'opÃ©ration non gÃ©rÃ©: ${lastOperation.type}`, 'warning');
            }
            
            updateOperationCounts();
        }
        
        // âœ… FONCTION DE RENUMÃ‰ROTATION
        function renumberRows() {
            const rows = document.querySelectorAll('#test-tbody tr');
            rows.forEach((row, index) => {
                const numCell = row.querySelector('td:first-child');
                if (numCell) {
                    numCell.textContent = index + 1;
                }
            });
        }
        
        // âœ… TEST COMPLET SUPPRESSION + UNDO
        function testDeleteAndUndo() {
            log('ğŸ§ª Test complet: Suppression + Undo', 'info');
            
            if (deletedRowsData.length === 0) {
                log('âš ï¸ Aucune ligne supprimÃ©e Ã  restaurer', 'warning');
                return;
            }
            
            log('ğŸ”„ ExÃ©cution de l\'undo...', 'info');
            undo();
            
            // âœ… VÃ‰RIFICATION ANTI-DUPLICATION
            const allRows = document.querySelectorAll('#test-tbody tr');
            const uniqueKeys = new Set();
            let hasDuplication = false;
            
            allRows.forEach(row => {
                const key = row.dataset.key;
                if (uniqueKeys.has(key)) {
                    hasDuplication = true;
                    log(`âŒ DUPLICATION DÃ‰TECTÃ‰E: ClÃ© ${key} apparaÃ®t plusieurs fois`, 'error');
                } else {
                    uniqueKeys.add(key);
                }
            });
            
            if (!hasDuplication) {
                log('âœ… Aucune duplication dÃ©tectÃ©e - Test rÃ©ussi', 'success');
            } else {
                log('âŒ Duplication dÃ©tectÃ©e - Test Ã©chouÃ©', 'error');
            }
        }
        
        // âœ… TEST DE MULTIPLES SUPPRESSIONS
        function testMultipleDeletions() {
            log('ğŸ§ª Test de multiples suppressions', 'info');
            
            const rows = document.querySelectorAll('#test-tbody tr');
            if (rows.length === 0) {
                log('âš ï¸ Aucune ligne Ã  supprimer', 'warning');
                return;
            }
            
            // Supprimer toutes les lignes
            rows.forEach(row => {
                const deleteBtn = row.querySelector('.delete-btn');
                if (deleteBtn) {
                    deleteBtn.click();
                }
            });
            
            log(`âœ… ${rows.length} lignes supprimÃ©es`, 'success');
            
            // Restaurer toutes les lignes
            for (let i = 0; i < rows.length; i++) {
                setTimeout(() => {
                    undo();
                }, i * 200);
            }
            
            log('ğŸ”„ Restauration de toutes les lignes en cours...', 'info');
        }
        
        // âœ… RÃ‰INITIALISATION DU TABLEAU
        function resetTable() {
            log('ğŸ”„ RÃ©initialisation du tableau...', 'info');
            
            // Vider l'historique
            operationHistory = [];
            deletedRowsData = [];
            
            // Restaurer le tableau original
            const tbody = document.getElementById('test-tbody');
            tbody.innerHTML = `
                <tr data-key="1">
                    <td>1</td>
                    <td><button class="delete-btn" onclick="deleteRow(this)">ğŸ—‘ï¸</button></td>
                    <td>Jean Dupont</td>
                    <td>jean@email.com</td>
                    <td>Actif</td>
                </tr>
                <tr data-key="2">
                    <td>2</td>
                    <td><button class="delete-btn" onclick="deleteRow(this)">ğŸ—‘ï¸</button></td>
                    <td>Marie Martin</td>
                    <td>marie@email.com</td>
                    <td>Actif</td>
                </tr>
                <tr data-key="3">
                    <td>3</td>
                    <td><button class="delete-btn" onclick="deleteRow(this)">ğŸ—‘ï¸</button></td>
                    <td>Pierre Durand</td>
                    <td>pierre@email.com</td>
                    <td>Inactif</td>
                </tr>
            `;
            
            updateOperationCounts();
            log('âœ… Tableau rÃ©initialisÃ©', 'success');
        }
        
        // âœ… AJOUTER BOUTON UNDO AU TABLEAU
        function addUndoButton() {
            const thead = document.querySelector('#test-table thead tr');
            const undoHeader = document.createElement('th');
            undoHeader.innerHTML = '<button class="undo-btn" onclick="undo()">â†¶ Undo</button>';
            thead.appendChild(undoHeader);
            
            // Ajouter cellule vide pour chaque ligne
            const rows = document.querySelectorAll('#test-tbody tr');
            rows.forEach(row => {
                const undoCell = document.createElement('td');
                undoCell.innerHTML = '<button class="undo-btn" onclick="undo()">â†¶</button>';
                row.appendChild(undoCell);
            });
        }
        
        // Initialisation
        log('âœ… Test de correction duplication undo initialisÃ© avec succÃ¨s', 'success');
        log('ğŸ¯ Objectif: VÃ©rifier que l\'undo de suppression ne crÃ©e pas de duplications', 'success');
        log('ğŸ’¡ Correction: VÃ©rification de l\'existence avant restauration', 'info');
        
        // Ajouter le bouton undo
        addUndoButton();
        
        // Afficher l'Ã©tat initial
        log('ğŸ“Š Ã‰tat initial:', 'info');
        log('   - 3 lignes de test configurÃ©es', 'info');
        log('   - SystÃ¨me undo/redo simulÃ©', 'info');
        log('   - VÃ©rification anti-duplication implÃ©mentÃ©e', 'info');
        log('   - Boutons undo ajoutÃ©s au tableau', 'info');
        
        log('ğŸ’¡ Instructions de test:', 'info');
        log('   1. Supprimez une ligne avec le bouton ğŸ—‘ï¸', 'info');
        log('   2. Cliquez sur Undo pour la restaurer', 'info');
        log('   3. VÃ©rifiez qu\'il n\'y a pas de duplication', 'info');
        
        updateOperationCounts();
    </script>
</body>
</html>
