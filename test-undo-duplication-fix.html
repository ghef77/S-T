<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Correction Duplication Undo Suppression</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { 
            background: #f8f9fa; 
            padding: 20px; 
            margin: 20px; 
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .log { 
            background: #f8f9fa; 
            padding: 15px; 
            margin: 20px; 
            border-radius: 8px;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }
        .success { color: #28a745; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .info { color: #17a2b8; font-weight: bold; }
        button { 
            padding: 12px 20px; 
            margin: 8px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .btn-danger { background-color: #dc3545; color: white; }
        .instructions {
            background: #e3f2fd;
            padding: 15px;
            margin: 20px;
            border-radius: 8px;
            border-left: 4px solid #2196f3;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .selected-row {
            background-color: #e3f2fd !important;
        }
        .delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
        }
        .undo-btn {
            background-color: #ffc107;
            color: black;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        /* ‚úÖ INDICATEURS VISUELS POUR SUPPRESSION ET RESTAURATION */
        .row-deleting {
            animation: deleteRow 0.5s ease-out;
            background-color: #ffebee !important;
            border: 2px solid #f44336 !important;
        }
        
        .row-restoring {
            animation: restoreRow 0.6s ease-in;
            background-color: #e8f5e8 !important;
            border: 2px solid #4caf50 !important;
        }
        
        .row-deleted {
            opacity: 0.3;
            background-color: #f5f5f5 !important;
            text-decoration: line-through;
            color: #999 !important;
        }
        
        .row-restored {
            animation: highlightRestored 1s ease-in-out;
        }
        
        /* ‚úÖ ANIMATIONS CSS */
        @keyframes deleteRow {
            0% { 
                transform: scale(1);
                opacity: 1;
                background-color: #ffebee;
            }
            50% { 
                transform: scale(0.95);
                background-color: #ffcdd2;
            }
            100% { 
                transform: scale(0.9);
                opacity: 0.3;
                background-color: #f5f5f5;
            }
        }
        
        @keyframes restoreRow {
            0% { 
                transform: scale(0.8);
                opacity: 0;
                background-color: #e8f5e8;
            }
            50% { 
                transform: scale(1.05);
                background-color: #c8e6c9;
            }
            100% { 
                transform: scale(1);
                opacity: 1;
                background-color: #e8f5e8;
            }
        }
        
        @keyframes highlightRestored {
            0% { 
                background-color: #4caf50;
                color: white;
                transform: scale(1.02);
            }
            50% { 
                background-color: #66bb6a;
                transform: scale(1.05);
            }
            100% { 
                background-color: #e8f5e8;
                transform: scale(1);
            }
        }
        
        /* ‚úÖ INDICATEURS DE STATUT */
        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        
        .status-deleting {
            background-color: #f44336;
            border: 2px solid #d32f2f;
        }
        
        .status-restoring {
            background-color: #4caf50;
            border: 2px solid #388e3c;
        }
        
        @keyframes slideIn {
            from { 
                transform: translateX(100%);
                opacity: 0;
            }
            to { 
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <h1>üß™ Test Correction Duplication Undo Suppression</h1>
    
    <div class="instructions">
        <h3>üìã Test de la Correction de la Duplication</h3>
        <p><strong>Probl√®me :</strong> Quand on efface une ligne et fait undo, la ligne revient mais elle est dupliqu√©e.</p>
        <p><strong>Objectif :</strong> V√©rifier que la correction emp√™che la duplication lors de l'undo de suppression.</p>
        <ol>
            <li>V√©rifiez l'√©tat initial du tableau</li>
            <li>Supprimez une ligne</li>
            <li>Faites undo pour restaurer la ligne</li>
            <li>V√©rifiez qu'il n'y a pas de duplication</li>
        </ol>
    </div>
    
    <div class="test-section">
        <h3>üìä Tableau de Test</h3>
        <table id="test-table">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Action</th>
                    <th>Nom</th>
                    <th>Email</th>
                    <th>Statut</th>
                </tr>
            </thead>
            <tbody id="test-tbody">
                <tr data-key="1">
                    <td>1</td>
                    <td><button class="delete-btn" onclick="deleteRow(this)">üóëÔ∏è</button></td>
                    <td>Jean Dupont</td>
                    <td>jean@email.com</td>
                    <td>Actif</td>
                </tr>
                <tr data-key="2">
                    <td>2</td>
                    <td><button class="delete-btn" onclick="deleteRow(this)">üóëÔ∏è</button></td>
                    <td>Marie Martin</td>
                    <td>marie@email.com</td>
                    <td>Actif</td>
                </tr>
                <tr data-key="3">
                    <td>3</td>
                    <td><button class="delete-btn" onclick="deleteRow(this)">üóëÔ∏è</button></td>
                    <td>Pierre Durand</td>
                    <td>pierre@email.com</td>
                    <td>Inactif</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="test-section">
        <h3>üéÆ Actions de Test</h3>
        <button onclick="testDeleteAndUndo()" class="btn-primary">üß™ Test Suppression + Undo</button>
        <button onclick="testMultipleDeletions()" class="btn-warning">üîÑ Test Multiples Suppressions</button>
        <button onclick="resetTable()" class="btn-success">üîÑ R√©initialiser Tableau</button>
        <button onclick="clearLog()" class="btn-danger">üóëÔ∏è Effacer Log</button>
    </div>
    
    <div class="test-section">
        <h3>üìà Historique des Op√©rations</h3>
        <div id="operation-history">
            <p><strong>Op√©rations :</strong> <span id="op-count">0</span></p>
            <p><strong>Lignes supprim√©es :</strong> <span id="deleted-count">0</span></p>
            <p><strong>Lignes restaur√©es :</strong> <span id="restored-count">0</span></p>
        </div>
    </div>
    
    <div class="log" id="log">
        <div class="info">üöÄ Test de correction duplication undo initialis√©</div>
    </div>
    
    <script>
        // ‚úÖ SIMULATION DU SYST√àME UNDO/REDO
        let operationHistory = [];
        let redoHistory = [];
        let deletedRowsData = [];
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '<div class="info">üöÄ Test de correction duplication undo initialis√©</div>';
        }
        
        function updateOperationCounts() {
            document.getElementById('op-count').textContent = operationHistory.length;
            document.getElementById('deleted-count').textContent = deletedRowsData.length;
            document.getElementById('restored-count').textContent = operationHistory.filter(op => op.type === 'restore').length;
        }
        
        // ‚úÖ FONCTION DE SUPPRESSION DE LIGNE AVEC INDICATEURS VISUELS
        function deleteRow(button) {
            const row = button.closest('tr');
            const rowKey = row.dataset.key;
            const rowNumber = row.querySelector('td:first-child').textContent;
            
            log(`üóëÔ∏è Suppression de la ligne ${rowNumber} (cl√©: ${rowKey})`, 'warning');
            
            // ‚úÖ INDICATEUR VISUEL DE SUPPRESSION
            showStatusIndicator(`üóëÔ∏è Suppression de la ligne ${rowNumber}...`, 'deleting');
            
            // ‚úÖ ANIMATION DE SUPPRESSION
            row.classList.add('row-deleting');
            
            // ‚úÖ CAPTURER LES DONN√âES AVANT SUPPRESSION
            const rowData = {
                key: rowKey,
                number: rowNumber,
                cells: Array.from(row.querySelectorAll('td')).slice(2).map(td => td.textContent),
                headers: ['Nom', 'Email', 'Statut']
            };
            
            // ‚úÖ ENREGISTRER L'OP√âRATION DE SUPPRESSION
            const deleteOperation = {
                type: 'delete',
                timestamp: Date.now(),
                data: {
                    deletedRows: 1,
                    rowKeys: [rowKey],
                    rowData: [rowData],
                    rowNumbers: [parseInt(rowNumber)]
                }
            };
            
            operationHistory.push(deleteOperation);
            deletedRowsData.push(rowData);
            
            // ‚úÖ SUPPRIMER LA LIGNE DU DOM APR√àS ANIMATION
            setTimeout(() => {
                row.remove();
                
                // ‚úÖ RENUM√âROTER LES LIGNES
                renumberRows();
                
                // ‚úÖ MASQUER L'INDICATEUR DE SUPPRESSION
                hideStatusIndicator();
                
                log(`‚úÖ Ligne ${rowNumber} supprim√©e et op√©ration enregistr√©e`, 'success');
                updateOperationCounts();
            }, 500); // Dur√©e de l'animation
        }
        
        // ‚úÖ FONCTION UNDO CORRIG√âE AVEC INDICATEURS VISUELS (SANS DUPLICATION)
        function undo() {
            if (operationHistory.length === 0) {
                log('‚ö†Ô∏è Aucune op√©ration √† annuler', 'warning');
                return;
            }
            
            const lastOperation = operationHistory.pop();
            
            if (lastOperation.type === 'delete') {
                log(`üîÑ Tentative de restauration de la ligne supprim√©e...`, 'info');
                
                // ‚úÖ INDICATEUR VISUEL DE RESTAURATION
                showStatusIndicator(`üîÑ Restauration de la ligne...`, 'restoring');
                
                // ‚úÖ V√âRIFIER SI LA LIGNE EXISTE D√âJ√Ä (ANTI-DUPLICATION)
                const existingRow = document.querySelector(`tr[data-key="${lastOperation.data.rowKeys[0]}"]`);
                if (existingRow) {
                    log(`‚ö†Ô∏è LIGNE D√âJ√Ä PR√âSENTE - √âVITER LA DUPLICATION`, 'warning');
                    log(`   - Cl√© existante: ${lastOperation.data.rowKeys[0]}`, 'warning');
                    log(`   - Num√©ro de ligne: ${lastOperation.data.rowNumbers[0]}`, 'warning');
                    
                    // ‚úÖ MASQUER L'INDICATEUR DE RESTAURATION
                    hideStatusIndicator();
                    return;
                }
                
                // ‚úÖ RESTAURER LA LIGNE UNIQUEMENT SI ELLE N'EXISTE PAS
                const rowData = lastOperation.data.rowData[0];
                const tbody = document.getElementById('test-tbody');
                
                // ‚úÖ CR√âER LA NOUVELLE LIGNE
                const newRow = document.createElement('tr');
                newRow.dataset.key = rowData.key;
                newRow.className = 'bg-white hover:bg-gray-100 transition-colors cursor-pointer row-restoring';
                
                // ‚úÖ CELLULE NUM√âRO
                const numCell = document.createElement('td');
                numCell.textContent = rowData.number;
                newRow.appendChild(numCell);
                
                // ‚úÖ CELLULE ACTION (bouton supprimer + undo)
                const actionCell = document.createElement('td');
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'üóëÔ∏è';
                deleteBtn.onclick = function() { deleteRow(this); };
                actionCell.appendChild(deleteBtn);
                
                const undoBtn = document.createElement('button');
                undoBtn.className = 'undo-btn';
                undoBtn.textContent = '‚Ü∂';
                undoBtn.onclick = function() { undo(); };
                actionCell.appendChild(undoBtn);
                
                newRow.appendChild(actionCell);
                
                // ‚úÖ CELLULES DE DONN√âES
                rowData.cells.forEach(cellText => {
                    const cell = document.createElement('td');
                    cell.textContent = cellText;
                    newRow.appendChild(cell);
                });
                
                // ‚úÖ INS√âRER √Ä LA POSITION ORIGINALE
                const targetPosition = Math.min(parseInt(rowData.number) - 1, tbody.children.length);
                if (targetPosition >= 0) {
                    tbody.insertBefore(newRow, tbody.children[targetPosition]);
                } else {
                    tbody.appendChild(newRow);
                }
                
                // ‚úÖ RENUM√âROTER APR√àS RESTAURATION
                renumberRows();
                
                // ‚úÖ ANIMATION DE RESTAURATION COMPL√àTE
                setTimeout(() => {
                    newRow.classList.remove('row-restoring');
                    newRow.classList.add('row-restored');
                    
                    // ‚úÖ MASQUER L'INDICATEUR DE RESTAURATION
                    hideStatusIndicator();
                    
                    // ‚úÖ RETIRER LA CLASSE D'ANIMATION APR√àS COMPL√âTION
                    setTimeout(() => {
                        newRow.classList.remove('row-restored');
                    }, 1000);
                }, 600); // Dur√©e de l'animation de restauration
                
                // ‚úÖ ENREGISTRER L'OP√âRATION DE RESTAURATION
                const restoreOperation = {
                    type: 'restore',
                    timestamp: Date.now(),
                    data: {
                        restoredRows: 1,
                        rowKey: rowData.key,
                        rowNumber: rowData.number
                    }
                };
                
                operationHistory.push(restoreOperation);
                
                log(`‚úÖ Ligne ${rowData.number} restaur√©e SANS DUPLICATION`, 'success');
                log(`   - Cl√©: ${rowData.key}`, 'info');
                log(`   - Position: ${targetPosition + 1}`, 'info');
                
            } else {
                log(`‚ö†Ô∏è Type d'op√©ration non g√©r√©: ${lastOperation.type}`, 'warning');
            }
            
            updateOperationCounts();
        }
        
        // ‚úÖ FONCTION DE RENUM√âROTATION
        function renumberRows() {
            const rows = document.querySelectorAll('#test-tbody tr');
            rows.forEach((row, index) => {
                const numCell = row.querySelector('td:first-child');
                if (numCell) {
                    numCell.textContent = index + 1;
                }
            });
        }
        
        // ‚úÖ TEST COMPLET SUPPRESSION + UNDO
        function testDeleteAndUndo() {
            log('üß™ Test complet: Suppression + Undo', 'info');
            
            if (deletedRowsData.length === 0) {
                log('‚ö†Ô∏è Aucune ligne supprim√©e √† restaurer', 'warning');
                return;
            }
            
            log('üîÑ Ex√©cution de l\'undo...', 'info');
            undo();
            
            // ‚úÖ V√âRIFICATION ANTI-DUPLICATION
            const allRows = document.querySelectorAll('#test-tbody tr');
            const uniqueKeys = new Set();
            let hasDuplication = false;
            
            allRows.forEach(row => {
                const key = row.dataset.key;
                if (uniqueKeys.has(key)) {
                    hasDuplication = true;
                    log(`‚ùå DUPLICATION D√âTECT√âE: Cl√© ${key} appara√Æt plusieurs fois`, 'error');
                } else {
                    uniqueKeys.add(key);
                }
            });
            
            if (!hasDuplication) {
                log('‚úÖ Aucune duplication d√©tect√©e - Test r√©ussi', 'success');
            } else {
                log('‚ùå Duplication d√©tect√©e - Test √©chou√©', 'error');
            }
        }
        
        // ‚úÖ TEST DE MULTIPLES SUPPRESSIONS
        function testMultipleDeletions() {
            log('üß™ Test de multiples suppressions', 'info');
            
            const rows = document.querySelectorAll('#test-tbody tr');
            if (rows.length === 0) {
                log('‚ö†Ô∏è Aucune ligne √† supprimer', 'warning');
                return;
            }
            
            // Supprimer toutes les lignes
            rows.forEach(row => {
                const deleteBtn = row.querySelector('.delete-btn');
                if (deleteBtn) {
                    deleteBtn.click();
                }
            });
            
            log(`‚úÖ ${rows.length} lignes supprim√©es`, 'success');
            
            // Restaurer toutes les lignes
            for (let i = 0; i < rows.length; i++) {
                setTimeout(() => {
                    undo();
                }, i * 200);
            }
            
            log('üîÑ Restauration de toutes les lignes en cours...', 'info');
        }
        
        // ‚úÖ R√âINITIALISATION DU TABLEAU
        function resetTable() {
            log('üîÑ R√©initialisation du tableau...', 'info');
            
            // Vider l'historique
            operationHistory = [];
            deletedRowsData = [];
            
            // Restaurer le tableau original
            const tbody = document.getElementById('test-tbody');
            tbody.innerHTML = `
                <tr data-key="1">
                    <td>1</td>
                    <td><button class="delete-btn" onclick="deleteRow(this)">üóëÔ∏è</button></td>
                    <td>Jean Dupont</td>
                    <td>jean@email.com</td>
                    <td>Actif</td>
                </tr>
                <tr data-key="2">
                    <td>2</td>
                    <td><button class="delete-btn" onclick="deleteRow(this)">üóëÔ∏è</button></td>
                    <td>Marie Martin</td>
                    <td>marie@email.com</td>
                    <td>Actif</td>
                </tr>
                <tr data-key="3">
                    <td>3</td>
                    <td><button class="delete-btn" onclick="deleteRow(this)">üóëÔ∏è</button></td>
                    <td>Pierre Durand</td>
                    <td>pierre@email.com</td>
                    <td>Inactif</td>
                </tr>
            `;
            
            // ‚úÖ Ajouter les boutons undo aux nouvelles lignes
            addUndoButton();
            
            updateOperationCounts();
            log('‚úÖ Tableau r√©initialis√© avec boutons undo', 'success');
        }
        
        // ‚úÖ FONCTIONS POUR LES INDICATEURS DE STATUT
        function showStatusIndicator(message, type) {
            // Supprimer l'ancien indicateur s'il existe
            hideStatusIndicator();
            
            const indicator = document.createElement('div');
            indicator.className = `status-indicator status-${type}`;
            indicator.textContent = message;
            indicator.id = 'status-indicator';
            
            document.body.appendChild(indicator);
        }
        
        function hideStatusIndicator() {
            const existingIndicator = document.getElementById('status-indicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
        }
        
        // ‚úÖ AJOUTER BOUTON UNDO AU TABLEAU
        function addUndoButton() {
            const thead = document.querySelector('#test-table thead tr');
            const undoHeader = document.createElement('th');
            undoHeader.innerHTML = '<button class="undo-btn" onclick="undo()">‚Ü∂ Undo</button>';
            thead.appendChild(undoHeader);
            
            // Ajouter cellule vide pour chaque ligne
            const rows = document.querySelectorAll('#test-tbody tr');
            rows.forEach(row => {
                const undoCell = document.createElement('td');
                undoCell.innerHTML = '<button class="undo-btn" onclick="undo()">‚Ü∂</button>';
                row.appendChild(undoCell);
            });
        }
        
        // Initialisation
        log('‚úÖ Test de correction duplication undo initialis√© avec succ√®s', 'success');
        log('üéØ Objectif: V√©rifier que l\'undo de suppression ne cr√©e pas de duplications', 'success');
        log('üí° Correction: V√©rification de l\'existence avant restauration', 'info');
        
        // Ajouter le bouton undo
        addUndoButton();
        
        // Afficher l'√©tat initial
        log('üìä √âtat initial:', 'info');
        log('   - 3 lignes de test configur√©es', 'info');
        log('   - Syst√®me undo/redo simul√©', 'info');
        log('   - V√©rification anti-duplication impl√©ment√©e', 'info');
        log('   - Boutons undo ajout√©s au tableau', 'info');
        
        log('üí° Instructions de test:', 'info');
        log('   1. Supprimez une ligne avec le bouton üóëÔ∏è', 'info');
        log('   2. Cliquez sur Undo pour la restaurer', 'info');
        log('   3. V√©rifiez qu\'il n\'y a pas de duplication', 'info');
        
        updateOperationCounts();
    </script>
</body>
</html>
