<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Manual Snapshot Storage</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            background: #4f46e5;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
        }
        .button:hover {
            background: #4338ca;
        }
        .success { color: #059669; }
        .error { color: #dc2626; }
        .warning { color: #d97706; }
        .info { color: #2563eb; }
        pre {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #374151;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Manual Snapshot Storage</h1>
        <p>This tool tests the manual snapshot creation and storage upload process.</p>
        
        <div class="test-section">
            <h3>üìã Step 1: Test Configuration</h3>
            <button class="button" onclick="testConfig()">Test Supabase Config</button>
            <pre id="config-output"></pre>
        </div>
        
        <div class="test-section">
            <h3>üóÑÔ∏è Step 2: Test Storage Connection</h3>
            <button class="button" onclick="testStorageConnection()">Test Storage Access</button>
            <pre id="storage-output"></pre>
        </div>
        
        <div class="test-section">
            <h3>üìä Step 3: Test Data Preparation</h3>
            <button class="button" onclick="testDataPreparation()">Prepare Test Data</button>
            <pre id="data-output"></pre>
        </div>
        
        <div class="test-section">
            <h3>üíæ Step 4: Test Storage Upload</h3>
            <button class="button" onclick="testStorageUpload()">Upload Test File</button>
            <pre id="upload-output"></pre>
        </div>
        
        <div class="test-section">
            <h3>üìö Step 5: Test Database Index</h3>
            <button class="button" onclick="testDatabaseIndex()">Create Index Entry</button>
            <pre id="index-output"></pre>
        </div>
        
        <div class="test-section">
            <h3>üîç Step 6: Verify Files in Storage</h3>
            <button class="button" onclick="listStorageFiles()">List Storage Files</button>
            <pre id="verify-output"></pre>
        </div>
        
        <div class="test-section">
            <h3>üöÄ Complete Test: Create Manual Snapshot</h3>
            <button class="button" onclick="runCompleteTest()">Run Complete Manual Snapshot Test</button>
            <pre id="complete-output"></pre>
        </div>
    </div>

    <script>
        // Configuration (you need to update these with your actual values)
        const supabaseConfig = {
            supabaseUrl: 'https://fiecugxopjxzqfdnaqsu.supabase.co',
            supabaseAnonKey: 'your-anon-key-here',
            supabaseServiceKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpZWN1Z3hvcGp4enFmZG5hcXN1Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NDUwNTY1NywiZXhwIjoyMDcwMDgxNjU3fQ.5m7nLHxHxOkxQf8maZis7Y7jynqu2dWqIzEbgWvOTcE'
        };

        let supabaseClient = null;

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            element.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        async function testConfig() {
            clearLog('config-output');
            log('config-output', 'üîß Testing Supabase configuration...');
            
            try {
                // Check if config values exist
                if (!supabaseConfig.supabaseUrl || !supabaseConfig.supabaseServiceKey) {
                    throw new Error('Missing Supabase configuration values');
                }
                
                log('config-output', `‚úÖ Supabase URL: ${supabaseConfig.supabaseUrl}`, 'success');
                log('config-output', `‚úÖ Service Key exists: ${supabaseConfig.supabaseServiceKey ? 'Yes' : 'No'}`, 'success');
                
                // Try to create client
                const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
                supabaseClient = createClient(supabaseConfig.supabaseUrl, supabaseConfig.supabaseServiceKey);
                
                log('config-output', '‚úÖ Supabase client created successfully', 'success');
                return true;
                
            } catch (error) {
                log('config-output', `‚ùå Configuration error: ${error.message}`, 'error');
                return false;
            }
        }

        async function testStorageConnection() {
            clearLog('storage-output');
            log('storage-output', 'üóÑÔ∏è Testing storage connection...');
            
            try {
                if (!supabaseClient) {
                    const success = await testConfig();
                    if (!success) {
                        throw new Error('Failed to create Supabase client');
                    }
                }
                
                // Try to list files in the bucket
                const { data, error } = await supabaseClient.storage
                    .from('table-snapshots')
                    .list('', { limit: 5 });
                
                if (error) {
                    throw new Error(`Storage error: ${error.message}`);
                }
                
                log('storage-output', `‚úÖ Storage connection successful`, 'success');
                log('storage-output', `üìÅ Found ${data?.length || 0} files/folders in bucket`, 'info');
                
                if (data && data.length > 0) {
                    data.slice(0, 3).forEach(file => {
                        log('storage-output', `   - ${file.name} (${file.metadata?.size || 'unknown size'})`, 'info');
                    });
                }
                
                return true;
                
            } catch (error) {
                log('storage-output', `‚ùå Storage connection failed: ${error.message}`, 'error');
                return false;
            }
        }

        async function testDataPreparation() {
            clearLog('data-output');
            log('data-output', 'üìä Preparing test data...');
            
            try {
                // Create test data similar to what the app would have
                const testData = [
                    { No: 1, Name: 'Test User 1', Position: 'Developer', Department: 'IT' },
                    { No: 2, Name: 'Test User 2', Position: 'Designer', Department: 'Design' },
                    { No: 3, Name: 'Test User 3', Position: 'Manager', Department: 'Management' }
                ];
                
                const now = new Date();
                const timestamp = now.getTime();
                const dateString = now.toISOString().split('T')[0];
                const timeString = now.toTimeString().split(' ')[0].replace(/:/g, '-');
                
                // Create paths
                const year = now.getFullYear();
                const month = (now.getMonth() + 1).toString().padStart(2, '0');
                const day = now.getDate().toString().padStart(2, '0');
                const objectPath = `${year}/${month}/${day}/TEST_MANUAL_${timeString}_staffTable.json`;
                
                // Prepare snapshot data
                const snapshotData = {
                    data: testData,
                    metadata: {
                        table: 'staffTable',
                        rowCount: testData.length,
                        createdAt: now.toISOString(),
                        snapshotDate: dateString,
                        type: 'TEST_MANUAL_SNAPSHOT',
                        version: '2.0.0',
                        description: 'Test snapshot created by diagnostic tool',
                        timestamp: timestamp,
                        userAction: 'test_creation'
                    }
                };
                
                const jsonContent = JSON.stringify(snapshotData, null, 2);
                const fileSize = new TextEncoder().encode(jsonContent).length;
                
                // Store for other tests
                window.testSnapshotData = {
                    data: snapshotData,
                    jsonContent,
                    fileSize,
                    objectPath,
                    dateString,
                    testData
                };
                
                log('data-output', `‚úÖ Test data prepared successfully`, 'success');
                log('data-output', `üìä Test data: ${testData.length} rows`, 'info');
                log('data-output', `üìÅ Object path: ${objectPath}`, 'info');
                log('data-output', `üíæ File size: ${(fileSize / 1024).toFixed(2)} KB`, 'info');
                
                return true;
                
            } catch (error) {
                log('data-output', `‚ùå Data preparation failed: ${error.message}`, 'error');
                return false;
            }
        }

        async function testStorageUpload() {
            clearLog('upload-output');
            log('upload-output', 'üíæ Testing storage upload...');
            
            try {
                if (!window.testSnapshotData) {
                    await testDataPreparation();
                }
                
                if (!supabaseClient) {
                    await testConfig();
                }
                
                const { jsonContent, objectPath, fileSize } = window.testSnapshotData;
                
                log('upload-output', `üì§ Uploading to: ${objectPath}`, 'info');
                
                // Upload to storage
                const { data, error } = await supabaseClient.storage
                    .from('table-snapshots')
                    .upload(objectPath, jsonContent, {
                        contentType: 'application/json',
                        upsert: true
                    });
                
                if (error) {
                    throw new Error(`Upload failed: ${error.message}`);
                }
                
                log('upload-output', `‚úÖ File uploaded successfully!`, 'success');
                log('upload-output', `üìÅ Upload path: ${data.path}`, 'success');
                log('upload-output', `üíæ File size: ${(fileSize / 1024).toFixed(2)} KB`, 'info');
                
                // Verify the file exists
                const { data: files, error: listError } = await supabaseClient.storage
                    .from('table-snapshots')
                    .list(objectPath.split('/').slice(0, -1).join('/'));
                
                if (listError) {
                    log('upload-output', `‚ö†Ô∏è Could not verify upload: ${listError.message}`, 'warning');
                } else {
                    const uploadedFile = files?.find(f => f.name === objectPath.split('/').pop());
                    if (uploadedFile) {
                        log('upload-output', `‚úÖ Upload verified: File found in storage`, 'success');
                    } else {
                        log('upload-output', `‚ö†Ô∏è Upload verification: File not found in directory listing`, 'warning');
                    }
                }
                
                return true;
                
            } catch (error) {
                log('upload-output', `‚ùå Storage upload failed: ${error.message}`, 'error');
                return false;
            }
        }

        async function testDatabaseIndex() {
            clearLog('index-output');
            log('index-output', 'üìö Testing database index creation...');
            
            try {
                if (!window.testSnapshotData) {
                    await testDataPreparation();
                }
                
                if (!supabaseClient) {
                    await testConfig();
                }
                
                const { data, objectPath, dateString, fileSize } = window.testSnapshotData;
                
                log('index-output', `üìù Creating index entry for: ${dateString}`, 'info');
                
                // Create index entry
                const { error: indexError } = await supabaseClient
                    .from('table_snapshots_index')
                    .insert({
                        snapshot_date: dateString,
                        object_path: objectPath,
                        row_count: data.data.length,
                        file_size_bytes: fileSize,
                        metadata: data.metadata
                    });
                
                if (indexError) {
                    throw new Error(`Index creation failed: ${indexError.message}`);
                }
                
                log('index-output', `‚úÖ Database index entry created successfully!`, 'success');
                log('index-output', `üìÖ Snapshot date: ${dateString}`, 'info');
                log('index-output', `üìÅ Object path: ${objectPath}`, 'info');
                log('index-output', `üìä Row count: ${data.data.length}`, 'info');
                
                return true;
                
            } catch (error) {
                log('index-output', `‚ùå Database index creation failed: ${error.message}`, 'error');
                return false;
            }
        }

        async function listStorageFiles() {
            clearLog('verify-output');
            log('verify-output', 'üîç Listing storage files...');
            
            try {
                if (!supabaseClient) {
                    await testConfig();
                }
                
                // List all files in the bucket
                const { data, error } = await supabaseClient.storage
                    .from('table-snapshots')
                    .list('', { limit: 50 });
                
                if (error) {
                    throw new Error(`List files failed: ${error.message}`);
                }
                
                log('verify-output', `‚úÖ Storage listing successful`, 'success');
                log('verify-output', `üìÅ Found ${data?.length || 0} items in root`, 'info');
                
                if (data && data.length > 0) {
                    for (const item of data.slice(0, 10)) {
                        if (item.metadata) {
                            log('verify-output', `   üìÑ ${item.name} (${(item.metadata.size / 1024).toFixed(2)} KB)`, 'info');
                        } else {
                            log('verify-output', `   üìÅ ${item.name}/`, 'info');
                            
                            // If it's a folder, list its contents
                            const { data: subData } = await supabaseClient.storage
                                .from('table-snapshots')
                                .list(item.name, { limit: 10 });
                            
                            if (subData && subData.length > 0) {
                                subData.slice(0, 5).forEach(subItem => {
                                    if (subItem.metadata) {
                                        log('verify-output', `      üìÑ ${item.name}/${subItem.name} (${(subItem.metadata.size / 1024).toFixed(2)} KB)`, 'info');
                                    }
                                });
                            }
                        }
                    }
                }
                
                return true;
                
            } catch (error) {
                log('verify-output', `‚ùå Storage listing failed: ${error.message}`, 'error');
                return false;
            }
        }

        async function runCompleteTest() {
            clearLog('complete-output');
            log('complete-output', 'üöÄ Running complete manual snapshot test...');
            log('complete-output', '=' + '='.repeat(50));
            
            try {
                // Step 1: Config
                log('complete-output', '1Ô∏è‚É£ Testing configuration...', 'info');
                if (!(await testConfig())) {
                    throw new Error('Configuration test failed');
                }
                
                // Step 2: Storage connection
                log('complete-output', '2Ô∏è‚É£ Testing storage connection...', 'info');
                if (!(await testStorageConnection())) {
                    throw new Error('Storage connection test failed');
                }
                
                // Step 3: Data preparation
                log('complete-output', '3Ô∏è‚É£ Preparing test data...', 'info');
                if (!(await testDataPreparation())) {
                    throw new Error('Data preparation failed');
                }
                
                // Step 4: Storage upload
                log('complete-output', '4Ô∏è‚É£ Testing storage upload...', 'info');
                if (!(await testStorageUpload())) {
                    throw new Error('Storage upload failed');
                }
                
                // Step 5: Database index
                log('complete-output', '5Ô∏è‚É£ Creating database index...', 'info');
                if (!(await testDatabaseIndex())) {
                    throw new Error('Database index creation failed');
                }
                
                log('complete-output', '=' + '='.repeat(50));
                log('complete-output', 'üéâ COMPLETE TEST SUCCESSFUL!', 'success');
                log('complete-output', '‚úÖ Manual snapshot process is working correctly', 'success');
                log('complete-output', 'üí° If your main app still has issues, the problem might be:', 'warning');
                log('complete-output', '   - Data capture from DOM not working', 'warning');
                log('complete-output', '   - Different error handling in the main app', 'warning');
                log('complete-output', '   - RLS policies blocking the main app\'s calls', 'warning');
                
                return true;
                
            } catch (error) {
                log('complete-output', `‚ùå Complete test failed: ${error.message}`, 'error');
                log('complete-output', 'üí° Check the individual test steps above to identify the issue', 'warning');
                return false;
            }
        }
    </script>
</body>
</html>